<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Exploration with Solveit â€“ wattbot</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-baedc78cbf92349237790bf011c153e8.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Exploration with Solveit â€“ wattbot">
<meta property="og:description" content="This repository is based on a kaggle competition named Wattbot">
<meta property="og:image" content="https://anubhavmaity.github.io/wattbot/06_wattbot_exploration_solveit_files/figure-html/cell-28-output-1.png">
<meta property="og:site_name" content="wattbot">
<meta property="og:image:height" content="455">
<meta property="og:image:width" content="571">
<meta name="twitter:title" content="Exploration with Solveit â€“ wattbot">
<meta name="twitter:description" content="This repository is based on a kaggle competition named Wattbot">
<meta name="twitter:image" content="https://anubhavmaity.github.io/wattbot/06_wattbot_exploration_solveit_files/figure-html/cell-28-output-1.png">
<meta name="twitter:image-height" content="455">
<meta name="twitter:image-width" content="571">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">wattbot</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./wattbot_exploration_solveit.html">Exploration with Solveit</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">WattBot 2025 - RAG System for Technical Document Q&amp;A</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./eda.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EDA</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./retriever.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Retriever</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./generator.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Generator</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./evaluate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Eval</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./submission_v1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Submissions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./submission_v2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Submissions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./submission_v3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Submissions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./utils.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Utils</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wattbot_exploration_solveit.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Exploration with Solveit</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wattbot_sdk_solveit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Initial Development with Solveit</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#wattbot-2025" id="toc-wattbot-2025" class="nav-link active" data-scroll-target="#wattbot-2025">WattBot 2025</a>
  <ul class="collapse">
  <li><a href="#wattbot-2025-1" id="toc-wattbot-2025-1" class="nav-link" data-scroll-target="#wattbot-2025-1">WattBot 2025</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#background" id="toc-background" class="nav-link" data-scroll-target="#background">Background</a></li>
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#provided-data" id="toc-provided-data" class="nav-link" data-scroll-target="#provided-data">Provided Data</a>
  <ul class="collapse">
  <li><a href="#question-types-examples" id="toc-question-types-examples" class="nav-link" data-scroll-target="#question-types-examples">Question Types &amp; Examples</a></li>
  <li><a href="#considerations" id="toc-considerations" class="nav-link" data-scroll-target="#considerations">Considerations</a></li>
  </ul></li>
  <li><a href="#expected-output-format" id="toc-expected-output-format" class="nav-link" data-scroll-target="#expected-output-format">Expected Output Format</a></li>
  <li><a href="#scoring" id="toc-scoring" class="nav-link" data-scroll-target="#scoring">Scoring</a>
  <ul class="collapse">
  <li><a href="#notes" id="toc-notes" class="nav-link" data-scroll-target="#notes">Notes</a></li>
  </ul></li>
  <li><a href="#submitting-solution" id="toc-submitting-solution" class="nav-link" data-scroll-target="#submitting-solution">Submitting solution</a></li>
  <li><a href="#ai-prompt" id="toc-ai-prompt" class="nav-link" data-scroll-target="#ai-prompt">AI Prompt</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/anubhavmaity/wattbot/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="wattbot_exploration_solveit.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Exploration with Solveit</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>I have the following url links and I have downloaded the pdfs in my local. I want to index the content (images/text) of the pdfs in qdrant database. https://sustainability.aboutamazon.com/2023-amazon-sustainability-report.pdf://arxiv.org/pdf/2405.01814://arxiv.org/pdf/2505.06371://arxiv.org/pdf/2405.21015://arxiv.org/pdf/2206.05229://arxiv.org/pdf/2410.06681://arxiv.org/pdf/2306.03163://arxiv.org/pdf/2504.17674://arxiv.org/pdf/2404.14527://arxiv.org/pdf/2412.06288://arxiv.org/pdf/2505.09598://arxiv.org/pdf/2504.06307://arxiv.org/pdf/2504.11816://arxiv.org/pdf/2309.03852://arxiv.org/pdf/2304.03271://arxiv.org/pdf/2302.08476://arxiv.org/pdf/2311.16863://arxiv.org/pdf/2501.16548://arxiv.org/pdf/2504.00797://arxiv.org/pdf/2506.15572://arxiv.org/pdf/2503.05804://arxiv.org/pdf/2104.10350://arxiv.org/pdf/2501.05899://arxiv.org/pdf/2310.03003://arxiv.org/pdf/1907.10597://arxiv.org/pdf/2404.07413://arxiv.org/pdf/2211.06318://arxiv.org/pdf/1906.02243://arxiv.org/pdf/2111.00364://arxiv.org/pdf/2108.06738://arxiv.org/pdf/2408.04693://arxiv.org/pdf/2508.14170</p>
<p>Also I have metadata of these pdfs stored in metadata.csv. I also want to index along with the content of the pdfs. Eventually I want to build a rag database</p>
<p>How shall I proceed?</p>
<section id="reply" class="level5">
<h5 class="anchored" data-anchor-id="reply">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great project! Building a RAG database with PDFs and metadata is a powerful way to create a searchable knowledge base. Let me help you break this down into manageable steps.</p>
<p>First, let me understand your current setup better:</p>
<ol type="1">
<li>Do you already have Qdrant installed and running (locally or cloud)?</li>
<li>What does your metadata.csv look like? (What columns does it have?)</li>
<li>Are you comfortable with Python libraries like <code>langchain</code>, <code>pymupdf</code>, or <code>unstructured</code> for PDF processing?</li>
</ol>
<p>For the overall approach, weâ€™ll need to: - Extract text and images from PDFs - Chunk the content appropriately - Generate embeddings - Store everything in Qdrant with metadata</p>
<p>Which of these areas would you like to start with, or would you prefer I suggest a specific first step?</p>
<ol type="1">
<li>Yes Qdrant client is installed locally. I would like to use the qdrant database in the cloud.</li>
<li>Metadata.csv has the columns id, type, title, year, citation, url id is the document id type is either report or paper. As you can see there are 31 papers and 1 report title is the title of the report/paper year is the year when the report/paper was published url is the url of the report/paper</li>
<li>No I am not familiar with any of those libraries</li>
</ol>
<p>You please suggest a specific first step</p>
</section>
<section id="reply-1" class="level5">
<h5 class="anchored" data-anchor-id="reply-1">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s start with the first step: setting up the basic libraries youâ€™ll need.</p>
<p>Since youâ€™re not familiar with the PDF processing libraries, I recommend starting with <code>pymupdf</code> (also called <code>fitz</code>) - itâ€™s reliable and handles both text and images well.</p>
<p>Hereâ€™s what you should install first:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install pymupdf qdrant-client sentence-transformers pandas</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Once youâ€™ve installed these, letâ€™s take a quick look at your metadata.csv to understand the structure better. Can you run this small code snippet to show us the first few rows?</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'metadata.csv'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df.head())</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total documents: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will help us see exactly what weâ€™re working with before we start processing the PDFs. Have you installed the libraries and can you show me what the metadata looks like?</p>
<div id="945d427f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'metadata.csv'</span>, encoding<span class="op">=</span><span class="st">'latin-1'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df.head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[1]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> <span style="font-weight:bold;color:rgb(0,135,0)">import</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">pandas</span><span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(0,135,0)">as</span><span style="color:rgb(188,188,188)"> </span><span class="ansi-blue-fg ansi-bold">pd</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> df = <span class="ansi-yellow-bg">pd</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-fg ansi-yellow-bg">metadata.csv</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-fg ansi-yellow-bg">latin-1</span><span class="ansi-yellow-fg ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">      3</span> df.head(n=<span class="ansi-green-fg">2</span>)

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/.local/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg">   1013</span> kwds_defaults = _refine_defaults_read(
<span class="ansi-green-fg">   1014</span>     dialect,
<span class="ansi-green-fg">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span><span class="ansi-green-fg">   1022</span>     dtype_backend=dtype_backend,
<span class="ansi-green-fg">   1023</span> )
<span class="ansi-green-fg">   1024</span> kwds.update(kwds_defaults)
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/.local/lib/python3.12/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg">    617</span> _validate_names(kwds.get(<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">names</span><span class="ansi-yellow-fg">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">620</span> parser = <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/.local/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg">   1617</span>     <span style="color:rgb(0,135,0)">self</span>.options[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">has_index_names</span><span class="ansi-yellow-fg">"</span>] = kwds[<span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">has_index_names</span><span class="ansi-yellow-fg">"</span>]
<span class="ansi-green-fg">   1619</span> <span style="color:rgb(0,135,0)">self</span>.handles: IOHandles | <span style="font-weight:bold;color:rgb(0,135,0)">None</span> = <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1620</span> <span style="color:rgb(0,135,0)">self</span>._engine = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/.local/lib/python3.12/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg">   1879</span>         mode += <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span>
<span class="ansi-green-fg">-&gt; </span><span class="ansi-green-fg">1880</span> <span style="color:rgb(0,135,0)">self</span>.handles = <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">encoding</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">compression</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">memory_map</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">encoding_errors</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">strict</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">storage_options</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span>.handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">   1891</span> f = <span style="color:rgb(0,135,0)">self</span>.handles.handle

<span class="ansi-cyan-fg">File </span><span class="ansi-green-fg">~/.local/lib/python3.12/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs.encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span class="ansi-yellow-fg">"</span><span class="ansi-yellow-fg">b</span><span class="ansi-yellow-fg">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs.mode:
<span class="ansi-green-fg">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; </span><span class="ansi-green-fg">873</span>         handle = <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span class="ansi-yellow-bg">=</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-fg ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg">    882</span>         handle = <span style="color:rgb(0,135,0)">open</span>(handle, ioargs.mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'metadata.csv'</pre>
</div>
</div>
</div>
<div id="0a1006bd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>32</code></pre>
</div>
</div>
<div id="4650689a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q PyMuPDF</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f3779e3d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q qdrant<span class="op">-</span>client</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Yes I installed the packages and also executed the code</p>
</section>
<section id="reply-2" class="level5">
<h5 class="anchored" data-anchor-id="reply-2">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! I can see you have 32 documents with good metadata structure. Now letâ€™s test if we can read one of your PDF files to make sure everything is working.</p>
<p>Can you try reading one PDF file first? Pick any PDF from your local folder and test this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fitz  <span class="co"># PyMuPDF</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace 'your_pdf_filename.pdf' with the actual filename</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> fitz.<span class="bu">open</span>(<span class="st">'your_pdf_filename.pdf'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of pages: </span><span class="sc">{</span><span class="bu">len</span>(doc)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First page text preview: </span><span class="sc">{</span>doc[<span class="dv">0</span>]<span class="sc">.</span>get_text()[:<span class="dv">200</span>]<span class="sc">}</span><span class="ss">..."</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>doc.close()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Whatâ€™s the filename of one of your PDFs? Once we confirm we can read the PDFs properly, weâ€™ll move to the next step of setting up the Qdrant cloud connection.</p>
<p>Apologies I did not download the pdf</p>
</section>
<section id="reply-3" class="level5">
<h5 class="anchored" data-anchor-id="reply-3">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>No problem! Letâ€™s download the PDFs first. We can use Python to download them from the URLs in your metadata.csv.</p>
<p>Hereâ€™s a simple approach to download one PDF first to test:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's download the first PDF as a test</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> df.iloc[<span class="dv">0</span>][<span class="st">'url'</span>]  <span class="co"># Amazon sustainability report</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>df<span class="sc">.</span>iloc[<span class="dv">0</span>][<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">.pdf"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> requests.get(url)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    f.write(response.content)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Downloaded: </span><span class="sc">{</span>filename<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Try this first to download one PDF. Once we confirm it works, we can download all of them in a loop.</p>
<p>Did this work for you?</p>
<div id="759f5574" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> httpx</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastcore.<span class="bu">all</span> <span class="im">as</span> fc</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>data_path <span class="op">=</span> fc.Path(<span class="st">'watt_bot_data'</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>data_path.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> df.iloc[<span class="dv">0</span>][<span class="st">'url'</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>df<span class="sc">.</span>iloc[<span class="dv">0</span>][<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">.pdf"</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> httpx.get(url)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(data_path<span class="op">/</span>filename, <span class="st">'wb'</span>) <span class="im">as</span> f: f.write(response.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Yes it worked for me</p>
</section>
<section id="reply-4" class="level5">
<h5 class="anchored" data-anchor-id="reply-4">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now letâ€™s test reading that PDF to make sure we can extract text from it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fitz</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fitz.<span class="bu">open</span>(data_path<span class="op">/</span><span class="st">'amazon2023.pdf'</span>) <span class="im">as</span> doc:</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Number of pages: </span><span class="sc">{</span><span class="bu">len</span>(doc)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"First page text preview:</span><span class="ch">\n</span><span class="sc">{</span>doc[<span class="dv">0</span>]<span class="sc">.</span>get_text()[:<span class="dv">300</span>]<span class="sc">}</span><span class="ss">..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Once we confirm this works, we can proceed to download all the other PDFs. Does this show you some text from the Amazon report?</p>
<div id="99b146b4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fitz</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> fitz.<span class="bu">open</span>(data_path<span class="op">/</span><span class="st">'amazon2023.pdf'</span>) <span class="im">as</span> doc:</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Number of pages: </span><span class="sc">{</span><span class="bu">len</span>(doc)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"First page text preview:</span><span class="ch">\n</span><span class="sc">{</span>doc[<span class="dv">0</span>]<span class="sc">.</span>get_text()[:<span class="dv">300</span>]<span class="sc">}</span><span class="ss">..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of pages: 98
First page text preview:
Amazon 
Sustainability 
Report
2023
...</code></pre>
</div>
</div>
<p>Yes, lets proceed</p>
</section>
<section id="reply-5" class="level5">
<h5 class="anchored" data-anchor-id="reply-5">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Now letâ€™s download all the remaining PDFs. Hereâ€™s a simple loop to get them all:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_pdf(row):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">.pdf"</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> (data_path<span class="op">/</span>filename).exists():</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> httpx.get(row[<span class="st">'url'</span>])</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(data_path<span class="op">/</span>filename, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>            f.write(response.content)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>df.<span class="bu">apply</span>(download_pdf, axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will download all 32 PDFs. It might take a few minutes since some are quite large. Should we run this?</p>
<div id="eb8de07b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> download_pdf(row):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    filename <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'id'</span>]<span class="sc">}</span><span class="ss">.pdf"</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> (data_path<span class="op">/</span>filename).exists():</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> httpx.get(row[<span class="st">'url'</span>].strip())</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(data_path<span class="op">/</span>filename, <span class="st">'wb'</span>) <span class="im">as</span> f:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>            f.write(response.content)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>download_status <span class="op">=</span> df.<span class="bu">apply</span>(download_pdf, axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now what is next?</p>
</section>
<section id="reply-6" class="level5">
<h5 class="anchored" data-anchor-id="reply-6">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now that we have all the PDFs downloaded, the next step is to set up your Qdrant cloud connection.</p>
<p>Do you already have a Qdrant cloud account and cluster set up? If so, youâ€™ll need: - Your cluster URL - Your API key</p>
<p>If you donâ€™t have a Qdrant cloud setup yet, you can create a free account at https://cloud.qdrant.io/</p>
<p>Once you have those credentials, we can test the connection. Do you have your Qdrant cloud credentials ready?</p>
<p>Yes I have set the API key as QDRANT_API_KEY and the cluster URL is https://76eb75ff-5ca3-4a68-93d4-ae19a9c169a4.us-west-2-0.aws.cloud.qdrant.io</p>
</section>
<section id="reply-7" class="level5">
<h5 class="anchored" data-anchor-id="reply-7">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s test the connection to your Qdrant cloud cluster:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client <span class="im">import</span> QdrantClient</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> QdrantClient(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    url<span class="op">=</span><span class="st">"https://76eb75ff-5ca3-4a68-93d4-ae19a9c169a4.us-west-2-0.aws.cloud.qdrant.io"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    api_key<span class="op">=</span>os.getenv(<span class="st">"QDRANT_API_KEY"</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the connection</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(client.get_collections())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will show us any existing collections in your cluster. Can you run this to confirm the connection works?</p>
<div id="7f68e2f4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client <span class="im">import</span> QdrantClient</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>QDRANT_HOST <span class="op">=</span> <span class="st">"https://76eb75ff-5ca3-4a68-93d4-ae19a9c169a4.us-west-2-0.aws.cloud.qdrant.io:6333"</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> QdrantClient(url<span class="op">=</span>QDRANT_HOST, api_key<span class="op">=</span>os.getenv(<span class="st">"QDRANT_API_KEY"</span>))</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the connection</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(client.get_collections())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>collections=[CollectionDescription(name='wattbot_documents_768'), CollectionDescription(name='wattbot_documents')]</code></pre>
</div>
</div>
<p>Yes the connection works</p>
</section>
<section id="reply-8" class="level5">
<h5 class="anchored" data-anchor-id="reply-8">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! The connection is working and your cluster is empty (no collections yet), which is perfect for starting fresh.</p>
<p>Now we need to decide on our approach for processing the PDFs. We have a few key decisions to make:</p>
<ol type="1">
<li><strong>Chunking strategy</strong>: How should we split the PDF content? (by page, by paragraph, fixed size chunks, etc.)</li>
<li><strong>Embedding model</strong>: What model should we use to create vector embeddings?</li>
<li><strong>Collection structure</strong>: Should we have one collection for all documents, or separate collections for papers vs reports?</li>
</ol>
<p>Whatâ€™s your preference for the chunking approach? Do you want to keep content organized by pages, or break it into smaller semantic chunks?</p>
<p>Which is favorable?</p>
</section>
<section id="reply-9" class="level5">
<h5 class="anchored" data-anchor-id="reply-9">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>For a RAG system, smaller semantic chunks are generally more favorable because:</p>
<ol type="1">
<li><strong>Better retrieval accuracy</strong> - You can find the exact relevant section rather than a whole page</li>
<li><strong>More focused context</strong> - Each chunk contains related information that fits together</li>
<li><strong>Better embedding quality</strong> - Smaller, coherent chunks create more meaningful vector representations</li>
</ol>
<p>Iâ€™d recommend chunks of around 500-1000 characters with some overlap between chunks to avoid cutting sentences in half.</p>
<p>For the embedding model, we have options like: - <code>sentence-transformers/all-MiniLM-L6-v2</code> (lightweight, good for general use) - <code>sentence-transformers/all-mpnet-base-v2</code> (higher quality, larger)</p>
<p>Which embedding model would you prefer to start with - the lighter/faster one or the higher quality one?</p>
<div id="39dc6aba" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>du <span class="op">-</span>sh watt_bot_data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>66M watt_bot_data</code></pre>
</div>
</div>
<p>I have the pdfs of size 65 MB. In qdrant cloud I have the disk space of 4GB and RAM of 1GB. Is the qdrant cloud size enough? Lets use the lightweight embedding model</p>
</section>
<section id="reply-10" class="level5">
<h5 class="anchored" data-anchor-id="reply-10">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes, your Qdrant cloud resources should be sufficient! Hereâ€™s a rough estimate:</p>
<ul>
<li>65MB of PDFs will likely extract to ~10-20MB of text</li>
<li>With 500-1000 character chunks, youâ€™ll have roughly 20,000-40,000 chunks</li>
<li>Using the lightweight model (384 dimensions), each vector is ~1.5KB</li>
<li>Total storage needed: ~60-100MB for vectors + metadata</li>
</ul>
<p>This fits comfortably in your 4GB disk space and 1GB RAM.</p>
<p>Letâ€™s install the lightweight embedding model:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install sentence<span class="op">-</span>transformers</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Once thatâ€™s installed, should we start processing one PDF first to test our pipeline before doing all 32?</p>
<p>What about the images in the PDF?</p>
</section>
<section id="reply-11" class="level5">
<h5 class="anchored" data-anchor-id="reply-11">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great question! Images in PDFs can contain valuable information like charts, graphs, and diagrams that are important for a comprehensive RAG system.</p>
<p>For handling images, we have a few options:</p>
<ol type="1">
<li><strong>Extract and describe images</strong> - Use vision models (like CLIP or BLIP) to generate text descriptions of images</li>
<li><strong>OCR for text in images</strong> - Extract any text embedded in charts/diagrams</li>
<li><strong>Skip images for now</strong> - Focus on text-only initially, add image processing later</li>
</ol>
<p>Given your cloud resources and that this is your first RAG system, which approach interests you most? Would you like to start with text-only and add image processing later, or tackle images from the beginning?</p>
<div id="573f4872" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q sentence<span class="op">-</span>transformers</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Lets do with text</p>
</section>
<section id="reply-12" class="level5">
<h5 class="anchored" data-anchor-id="reply-12">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s focus on text extraction and processing first.</p>
<p>Now letâ€™s create our first collection in Qdrant and set up the embedding model. Weâ€™ll need to:</p>
<ol type="1">
<li>Initialize the embedding model</li>
<li>Create a collection with the right vector dimensions</li>
<li>Test with one PDF first</li>
</ol>
<p>Letâ€™s start by initializing the embedding model:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SentenceTransformer(<span class="st">'sentence-transformers/all-MiniLM-L6-v2'</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Model loaded. Vector dimension: </span><span class="sc">{</span>model<span class="sc">.</span>get_sentence_embedding_dimension()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Can you run this to load the model?</p>
<div id="8fb3285b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sentence_transformers <span class="im">import</span> SentenceTransformer</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> SentenceTransformer(<span class="st">'sentence-transformers/all-MiniLM-L6-v2'</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>model.get_sentence_embedding_dimension()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.12/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>384</code></pre>
</div>
</div>
<p>I ran the model. Now next what</p>
</section>
<section id="reply-13" class="level5">
<h5 class="anchored" data-anchor-id="reply-13">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! The model is loaded and creates 384-dimensional vectors. Now letâ€™s create a collection in Qdrant to store our document chunks.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> Distance, VectorParams</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>collection_name <span class="op">=</span> <span class="st">"wattbot_documents"</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>client.create_collection(</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    collection_name<span class="op">=</span>collection_name,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span><span class="dv">384</span>, distance<span class="op">=</span>Distance.COSINE)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Collection '</span><span class="sc">{</span>collection_name<span class="sc">}</span><span class="ss">' created successfully!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This creates a collection that can store our 384-dimensional vectors with cosine similarity for search. Should we run this?</p>
<div id="a2ae2d4c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> Distance, VectorParams</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>collection_name <span class="op">=</span> <span class="st">"wattbot_documents"</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> client.collection_exists(collection_name):</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    client.create_collection(collection_name<span class="op">=</span>collection_name, vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span><span class="dv">384</span>, distance<span class="op">=</span>Distance.COSINE))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Okay what is next?</p>
</section>
<section id="reply-14" class="level5">
<h5 class="anchored" data-anchor-id="reply-14">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! The collection is created successfully. Now letâ€™s process one PDF to test our pipeline. We need to:</p>
<ol type="1">
<li>Extract text from a PDF</li>
<li>Split it into chunks</li>
<li>Create embeddings and store them in Qdrant</li>
</ol>
<p>Letâ€™s start by extracting and chunking text from the Amazon report:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextkit.read <span class="im">as</span> rd</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with one PDF</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="st">'amazon2023.pdf'</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Extracted </span><span class="sc">{</span><span class="bu">len</span>(text)<span class="sc">}</span><span class="ss"> characters"</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First 200 chars: </span><span class="sc">{</span>text[:<span class="dv">200</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see how much text we extract?</p>
<div id="95411a0e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextkit.read <span class="im">as</span> rd</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with one PDF</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="st">'amazon2023.pdf'</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Extracted </span><span class="sc">{</span><span class="bu">len</span>(text)<span class="sc">}</span><span class="ss"> characters"</span>)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First 200 chars: </span><span class="sc">{</span>text[:<span class="dv">200</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Extracted 450063 characters
First 200 chars: Amazon 
Sustainability 
Report
2023 Contents
Overview
3 Introduction
4 A Letter from Our Chief 
Sustainability Officer&nbsp;
5 How We Work
6 Goals Summary
7 2023 Year in Review &nbsp;
Environment
9 Carbon
24 Ca</code></pre>
</div>
</div>
<p>Okay now what is next?</p>
</section>
<section id="reply-15" class="level5">
<h5 class="anchored" data-anchor-id="reply-15">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! We extracted 450,063 characters from the Amazon report. Now we need to split this into smaller chunks for better retrieval.</p>
<p>Letâ€™s create chunks of around 800 characters with some overlap:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_chunks(text, chunk_size<span class="op">=</span><span class="dv">800</span>, overlap<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> []</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    start <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> start <span class="op">&lt;</span> <span class="bu">len</span>(text):</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> start <span class="op">+</span> chunk_size</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>        chunk <span class="op">=</span> text[start:end]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        chunks.append(chunk)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> end <span class="op">-</span> overlap</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> chunks</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> create_chunks(text)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Created </span><span class="sc">{</span><span class="bu">len</span>(chunks)<span class="sc">}</span><span class="ss"> chunks"</span>)</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First chunk: </span><span class="sc">{</span>chunks[<span class="dv">0</span>][:<span class="dv">100</span>]<span class="sc">}</span><span class="ss">..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see how many chunks we get?</p>
<p>Why do we need overlap? Can we use the fastcore chunked function https://fastcore.fast.ai/basics.html#chunked?</p>
</section>
<section id="reply-16" class="level5">
<h5 class="anchored" data-anchor-id="reply-16">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great questions!</p>
<p><strong>Why overlap?</strong> When we split text at fixed positions, we might cut sentences or paragraphs in the middle. Overlap helps ensure that complete thoughts/concepts appear in at least one chunk, improving retrieval quality.</p>
<p><strong>Using fastcore.chunked:</strong> Yes, we can use <code>fc.chunked</code>! However, it splits by number of items (characters), not by semantic boundaries. Letâ€™s try it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> <span class="bu">list</span>(fc.chunked(text, <span class="dv">800</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Created </span><span class="sc">{</span><span class="bu">len</span>(chunks)<span class="sc">}</span><span class="ss"> chunks"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First chunk length: </span><span class="sc">{</span><span class="bu">len</span>(chunks[<span class="dv">0</span>])<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to try this simpler approach first, or should we implement overlap for better semantic chunking?</p>
<p>Is there a name for this chunking?</p>
</section>
<section id="reply-17" class="level5">
<h5 class="anchored" data-anchor-id="reply-17">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! There are several names for different chunking strategies:</p>
<ol type="1">
<li><strong>Fixed-size chunking</strong> - What <code>fc.chunked</code> does (split by character/token count)</li>
<li><strong>Overlapping chunking</strong> - Fixed-size with overlap between chunks</li>
<li><strong>Semantic chunking</strong> - Split by sentences, paragraphs, or meaning</li>
<li><strong>Recursive chunking</strong> - Try sentences first, then paragraphs, then fixed-size as fallback</li>
</ol>
<p>The overlap approach is often called <strong>â€œsliding window chunkingâ€</strong> because each chunk â€œslidesâ€ over the previous one.</p>
<p>Which approach sounds most appealing to you for your RAG system?</p>
<p>Is there a way to use islice?</p>
</section>
<section id="reply-18" class="level5">
<h5 class="anchored" data-anchor-id="reply-18">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! <code>itertools.islice</code> can be great for creating overlapping chunks efficiently. You can use it to create a sliding window pattern:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> islice</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">800</span>, step<span class="op">=</span><span class="dv">700</span>):</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(text), step):</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> text[i:i<span class="op">+</span>chunk_size]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This creates chunks of 800 characters with 100 character overlap (800-700=100). The <code>islice</code> approach would be more memory-efficient for very large texts.</p>
<p>Would you like to try this sliding window approach, or do you prefer the simpler fixed-size chunking for now?</p>
<p>But the above one is not using islice</p>
</section>
<section id="reply-19" class="level5">
<h5 class="anchored" data-anchor-id="reply-19">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re absolutely right! That example doesnâ€™t use <code>islice</code> at all. Hereâ€™s how you could actually use <code>islice</code> for chunking:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> islice</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> islice_chunks(text, chunk_size<span class="op">=</span><span class="dv">800</span>):</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    it <span class="op">=</span> <span class="bu">iter</span>(text)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> chunk <span class="op">:=</span> <span class="st">''</span>.join(islice(it, chunk_size)):</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> chunk</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This uses <code>islice</code> to take <code>chunk_size</code> characters at a time from the text iterator.</p>
<p>Would you like to try this <code>islice</code> approach, or would you prefer to stick with a simpler method for now?</p>
<div id="26a9cc2f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> islice</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">800</span>, step<span class="op">=</span><span class="dv">700</span>):</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(text), step):</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">yield</span> text[i:i<span class="op">+</span>chunk_size]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="f13d5c09" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text))</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(chunks), chunks[<span class="dv">0</span>][:<span class="dv">100</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(643,
 'Amazon \nSustainability \nReport\n2023 Contents\nOverview\n3 Introduction\n4 A Letter from Our Chief \nSust')</code></pre>
</div>
</div>
<p>What is next?</p>
</section>
<section id="reply-20" class="level5">
<h5 class="anchored" data-anchor-id="reply-20">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Youâ€™ve created 643 chunks from the Amazon report. Now letâ€™s create embeddings for these chunks and store them in Qdrant.</p>
<p>Letâ€™s start with just the first few chunks to test:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with first 3 chunks</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>test_chunks <span class="op">=</span> chunks[:<span class="dv">3</span>]</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> model.encode(test_chunks)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Created embeddings shape: </span><span class="sc">{</span>embeddings<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see if the embedding generation works?</p>
<div id="810bcafc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with first 3 chunks</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>test_chunks <span class="op">=</span> chunks[:<span class="dv">3</span>]</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> model.encode(test_chunks)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>embeddings.shape</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(3, 384)</code></pre>
</div>
</div>
<p>Yes that is working</p>
</section>
<section id="reply-21" class="level5">
<h5 class="anchored" data-anchor-id="reply-21">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! The embeddings are working perfectly - 3 chunks with 384-dimensional vectors each.</p>
<p>Now letâ€™s store these test chunks in Qdrant with their metadata. We need to create points with: - Vectors (embeddings) - Payload (metadata like document ID, chunk text, etc.)</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> PointStruct</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> [</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    PointStruct(</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span>i,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        vector<span class="op">=</span>embeddings[i].tolist(),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        payload<span class="op">=</span>{<span class="st">"text"</span>: chunk, <span class="st">"doc_id"</span>: <span class="st">"amazon2023"</span>, <span class="st">"chunk_id"</span>: i}</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(test_chunks)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we create these points and upload them to test the storage?</p>
<p>Would not be storing the metadata information like type, title, year, citation and url?</p>
</section>
<section id="reply-22" class="level5">
<h5 class="anchored" data-anchor-id="reply-22">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Absolutely! Youâ€™re right - we should include all the metadata from your CSV file. Let me modify the payload to include that information:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get metadata for amazon2023 document</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>doc_metadata <span class="op">=</span> df[df[<span class="st">'id'</span>] <span class="op">==</span> <span class="st">'amazon2023'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> [</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    PointStruct(</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">id</span><span class="op">=</span>i,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        vector<span class="op">=</span>embeddings[i].tolist(),</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        payload<span class="op">=</span>{</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span>: chunk, </span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"doc_id"</span>: <span class="st">"amazon2023"</span>, </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"chunk_id"</span>: i,</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: doc_metadata[<span class="st">'type'</span>],</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"title"</span>: doc_metadata[<span class="st">'title'</span>],</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"year"</span>: doc_metadata[<span class="st">'year'</span>],</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"citation"</span>: doc_metadata[<span class="st">'citation'</span>],</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"url"</span>: doc_metadata[<span class="st">'url'</span>]</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(test_chunks)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we create these points with the full metadata?</p>
<div id="044efc21" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get metadata for amazon2023 document</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> PointStruct</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_payload(index, chunk, doc_id):</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> df[df[<span class="st">'id'</span>] <span class="op">==</span> doc_id].iloc[<span class="dv">0</span>]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"text"</span>: chunk, <span class="st">"doc_id"</span>: doc_id, <span class="st">"chunk_id"</span>: index, <span class="st">"type"</span>: r[<span class="st">'type'</span>], <span class="st">"title"</span>: r[<span class="st">'title'</span>], <span class="st">"year"</span>: <span class="bu">int</span>(r[<span class="st">'year'</span>]), <span class="st">"citation"</span>: r[<span class="st">'citation'</span>], <span class="st">"url"</span>: r[<span class="st">'url'</span>]}</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> [</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    PointStruct(<span class="bu">id</span><span class="op">=</span>i, vector<span class="op">=</span>model.encode(chunk).tolist(), payload<span class="op">=</span>create_payload(i, chunk, <span class="st">'amazon2023'</span>)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(test_chunks)</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Upload to Qdrant</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>client.upsert(collection_name<span class="op">=</span>collection_name, points<span class="op">=</span>points)</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Uploaded </span><span class="sc">{</span><span class="bu">len</span>(points)<span class="sc">}</span><span class="ss"> points to Qdrant!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Uploaded 3 points to Qdrant!</code></pre>
</div>
</div>
<p>Does the upsert replaces the existing points or create duplicates?</p>
</section>
<section id="reply-23" class="level5">
<h5 class="anchored" data-anchor-id="reply-23">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great question! <code>upsert</code> will <strong>replace</strong> existing points if they have the same ID, not create duplicates.</p>
<p>Since weâ€™re using sequential IDs (0, 1, 2â€¦), if you run the same code again, it will overwrite those 3 points rather than create new ones.</p>
<p>For processing all documents, weâ€™ll need unique IDs across all chunks. Should we modify the ID strategy to avoid conflicts when we process multiple documents?</p>
<p>Not needed for now. What is next?</p>
</section>
<section id="reply-24" class="level5">
<h5 class="anchored" data-anchor-id="reply-24">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now letâ€™s test if our search functionality works. We can query the collection to see if we get relevant results back:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test search</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"sustainability goals"</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> model.encode(query).tolist()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.search(collection_name<span class="op">=</span>collection_name, query_vector<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see if the search returns relevant chunks from the Amazon report?</p>
<div id="5134c82a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test search</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"sustainability goals"</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> model.encode(query).tolist()</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.search(collection_name<span class="op">=</span>collection_name, query_vector<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>results[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_55/96134313.py:4: DeprecationWarning: `search` method is deprecated and will be removed in the future. Use `query_points` instead.
  results = client.search(collection_name=collection_name, query_vector=query_vector, limit=2)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>ScoredPoint(id=2, version=20, score=0.5657909, payload={'text': 'ios, and Ring.\nOur 2023 Sustainability Report is structured into three \nmain categories: Environment, Value Chain, and People. In \nthe Environment\xa0  section, we discuss scaling our work, \npartnering with others, and inventing new solutions to \nminimize our emissions, waste, and water use; increasing \nour use of carbon-free energy; and pioneering solutions to \nimprove packaging, products, and the materials we use. In \nthe Value Chain\xa0  section, we discuss our commitment to \nrespect the human rights of people connected to our global \nbusiness, managing a responsible supply chain, creating \nsustainable products and using more sustainable materials, \nadvancing supplier diversity, and having a positive impact on \nthe communities where we operate. In the People\xa0  section, \nwe discuss our ambitio', 'doc_id': 'amazon2023', 'chunk_id': 2, 'type': 'report', 'title': '2023 Amazon Sustainability Report', 'year': 2023, 'citation': 'Amazon Staff. (2023). Amazon Sustainability Report. https://sustainability.aboutamazon.com/2023-amazon-sustainability-report.pdf', 'url': 'https://sustainability.aboutamazon.com/2023-amazon-sustainability-report.pdf'}, vector=None, shard_key=None, order_value=None)</code></pre>
</div>
</div>
<p>Ok so what is next?</p>
</section>
<section id="reply-25" class="level5">
<h5 class="anchored" data-anchor-id="reply-25">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! The search is working (though we should use <code>query_points</code> instead of the deprecated <code>search</code> method).</p>
<p>Now that our pipeline works for one document, we have two options:</p>
<ol type="1">
<li><strong>Scale up</strong>: Process all 32 PDFs and store everything in Qdrant</li>
<li><strong>Build query interface</strong>: Create a simple function to search and retrieve relevant chunks</li>
</ol>
<p>Which would you like to tackle first - processing all your documents, or creating a better search interface?</p>
<p>Lets use the query_points and scale up</p>
</section>
<section id="reply-26" class="level5">
<h5 class="anchored" data-anchor-id="reply-26">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great choice! Letâ€™s first update to use <code>query_points</code> and then scale up.</p>
<p>Hereâ€™s the updated search method:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> Query</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>collection_name,  query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results.points[<span class="dv">0</span>].payload[<span class="st">'text'</span>][:<span class="dv">100</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated search method first, then move on to processing all 32 PDFs?</p>
<div id="89be7417" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> Query</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>collection_name,  query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results.points[<span class="dv">0</span>].payload[<span class="st">'text'</span>][:<span class="dv">100</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>ios, and Ring.
Our 2023 Sustainability Report is structured into three 
main categories: Environment</code></pre>
</div>
</div>
<p>Lets scale up</p>
</section>
<section id="reply-27" class="level5">
<h5 class="anchored" data-anchor-id="reply-27">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Now letâ€™s scale up to process all 32 PDFs. We need to create a function that processes each document and generates unique IDs.</p>
<p>Hereâ€™s the approach - should I write the full processing function for you, or would you prefer to build it step by step?</p>
<p>The function would: 1. Loop through each row in your metadata CSV 2. Extract text from each PDF 3. Create chunks with unique IDs 4. Generate embeddings and store in Qdrant</p>
<p>Whatâ€™s your preference?</p>
<div id="31f923ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_point(idx, chunk, doc_id):</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>idx<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>model.encode(chunk).tolist(), payload<span class="op">=</span>create_payload(<span class="bu">id</span>, chunk, doc_id))</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points(doc_id):</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([create_point(i, chunk, doc_id) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(sliding_window_chunks(text))])</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>all_ids <span class="op">=</span> fc.L(df[<span class="st">'id'</span>].tolist())</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(all_ids[:<span class="dv">2</span>])</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="co"># all_points = fc.parallel(create_points, all_ids, threadpool=True)</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co"># len(all_points.flatten())</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>['amazon2023', 'chen2024']</code></pre>
</div>
</div>
<p>Each text extraction and chunking will take lot of time. How shall we optimize it?</p>
</section>
<section id="reply-28" class="level5">
<h5 class="anchored" data-anchor-id="reply-28">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good thinking about optimization! Youâ€™ve already set up parallel processing with <code>fc.parallel</code> which is great. Here are a few optimization strategies:</p>
<ol type="1">
<li><strong>Batch processing</strong>: Process embeddings in batches instead of one-by-one</li>
<li><strong>Async processing</strong>: Use async operations for I/O</li>
<li><strong>Caching</strong>: Save processed chunks to disk to avoid reprocessing</li>
</ol>
<p>Since youâ€™re using <code>threadpool=True</code>, that should help with the PDF reading. For embeddings, you could batch them:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead of encoding each chunk individually</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> model.encode([chunk <span class="cf">for</span> chunk <span class="kw">in</span> chunks])  <span class="co"># Batch encode</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Which optimization interests you most - batching the embeddings or adding progress tracking first?</p>
<p>Batching the embedding</p>
</section>
<section id="reply-29" class="level5">
<h5 class="anchored" data-anchor-id="reply-29">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great choice! Batching embeddings will be much faster than encoding one chunk at a time.</p>
<p>Hereâ€™s how to modify your <code>create_point</code> function to work with batched embeddings:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_batched(doc_id):</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text))</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    embs <span class="op">=</span> model.encode(chunks)  <span class="co"># Batch encode all chunks at once</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>embs[i].tolist(), payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this with one document first to see the speed improvement?</p>
<div id="47ca400a" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_batched(doc_id):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    embs <span class="op">=</span> model.encode(chunks)  <span class="co"># Batch encode all chunks at once</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>embs[i].tolist(), payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="e553dff6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>text[:<span class="dv">10</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Amazon \nSu'</code></pre>
</div>
</div>
<p>Is there any faster way to embed? The function create_points_batched is taking too much time as there are too many chunks</p>
</section>
<section id="reply-30" class="level5">
<h5 class="anchored" data-anchor-id="reply-30">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! Here are several ways to speed up embedding:</p>
<ol type="1">
<li><strong>Smaller batch sizes</strong>: Instead of encoding all chunks at once, process in smaller batches (e.g., 32-64 chunks)</li>
<li><strong>GPU acceleration</strong>: If available, the model will automatically use GPU</li>
<li><strong>Faster model</strong>: Use an even lighter model like <code>all-MiniLM-L12-v2</code></li>
<li><strong>Larger chunks</strong>: Reduce the number of chunks by using bigger chunk sizes</li>
</ol>
<p>How many chunks are you getting per document? You could try processing chunks in batches of 50:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process embeddings in batches of 50</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(chunks), <span class="dv">50</span>):</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    batch <span class="op">=</span> chunks[i:i<span class="op">+</span><span class="dv">50</span>]</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    batch_embs <span class="op">=</span> model.encode(batch)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Which approach would you like to try first?</p>
<div id="f6e0d4f5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(chunks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>643</code></pre>
</div>
</div>
<p>There are 643 chunks. Is it too many?</p>
</section>
<section id="reply-31" class="level5">
<h5 class="anchored" data-anchor-id="reply-31">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>643 chunks is quite a lot for one document! Thatâ€™s why the embedding is taking so long. Here are a few options to reduce this:</p>
<ol type="1">
<li><strong>Larger chunks</strong>: Increase chunk_size from 800 to 1500-2000 characters</li>
<li><strong>Larger step size</strong>: Reduce overlap by increasing step from 700 to closer to chunk_size</li>
<li><strong>Batch processing</strong>: Process in smaller batches of 32-64 chunks</li>
</ol>
<p>For comparison, with 1500 character chunks and 1400 step (100 overlap), youâ€™d get roughly ~320 chunks instead of 643.</p>
<p>Which approach would you prefer to try first?</p>
<p>Is there any cons for using larger chunks?</p>
</section>
<section id="reply-32" class="level5">
<h5 class="anchored" data-anchor-id="reply-32">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes, there are some trade-offs with larger chunks:</p>
<p><strong>Cons of larger chunks:</strong> 1. <strong>Less precise retrieval</strong> - You might get a whole section when you only need one paragraph 2. <strong>Mixed topics</strong> - Larger chunks may contain multiple unrelated concepts, making embeddings less focused 3. <strong>Context window limits</strong> - Some LLMs have token limits, so very large chunks might get truncated</p>
<p><strong>Pros:</strong> 1. <strong>Fewer total chunks</strong> - Faster processing and storage 2. <strong>More context</strong> - Each chunk contains more complete information 3. <strong>Better for complex topics</strong> - Full explanations stay together</p>
<p>For your RAG system, would you prefer more precise retrieval (smaller chunks) or faster processing (larger chunks)?</p>
<p>What is the tokeni limits of our embedding model?</p>
</section>
<section id="reply-33" class="level5">
<h5 class="anchored" data-anchor-id="reply-33">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The <code>all-MiniLM-L6-v2</code> model has a <strong>maximum sequence length of 512 tokens</strong>.</p>
<p>Since 1 token â‰ˆ 4 characters on average, this means roughly <strong>2000 characters maximum</strong> per chunk.</p>
<p>Your current chunks of 800 characters are well within this limit (~200 tokens), so you have room to increase chunk size if you want fewer chunks without hitting the modelâ€™s limit.</p>
<p>Would you like to try increasing to 1500 characters to reduce the number of chunks?</p>
<p>What should I keep the step size?</p>
</section>
<section id="reply-34" class="level5">
<h5 class="anchored" data-anchor-id="reply-34">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>For 1500 character chunks, you have a few good options for step size:</p>
<ol type="1">
<li><strong>No overlap (step = 1500)</strong>: Fastest processing, no redundancy</li>
<li><strong>Small overlap (step = 1400)</strong>: 100 characters overlap, ensures sentences donâ€™t get cut</li>
<li><strong>Medium overlap (step = 1300)</strong>: 200 characters overlap, better context preservation</li>
</ol>
<p>Iâ€™d recommend <strong>step = 1400</strong> as a good balance - youâ€™ll get about half as many chunks (~320 instead of 643) while keeping some overlap for better retrieval quality.</p>
<p>What do you think? Would you like to try this configuration?</p>
<p>Why does overlap gives better retrieval quality?</p>
</section>
<section id="reply-35" class="level5">
<h5 class="anchored" data-anchor-id="reply-35">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great question! Overlap improves retrieval quality because:</p>
<ol type="1">
<li><p><strong>Prevents information fragmentation</strong> - If a key concept spans across a chunk boundary, overlap ensures it appears completely in at least one chunk</p></li>
<li><p><strong>Context preservation</strong> - Important sentences that reference previous information wonâ€™t lose that context when chunks are split</p></li>
<li><p><strong>Better semantic matching</strong> - When a user asks a question, the relevant answer is more likely to be found in a complete, coherent chunk rather than a fragment</p></li>
</ol>
<p>For example, without overlap: - Chunk 1: â€œâ€¦the companyâ€™s carbon reduction strategy involvesâ€¦â€ - Chunk 2: â€œâ€¦renewable energy adoption and efficiency measures.â€</p>
<p>With overlap, one chunk would contain the complete thought about carbon reduction strategy.</p>
<p>Does this make sense? Would you like to try the 1500/1400 configuration?</p>
<div id="23c0a9d2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q more_itertools</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
</div>
<div id="91e959d8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> more_itertools <span class="im">import</span> ilen</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_chunks_count(doc_id):</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ilen(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ddce85c1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>chunks_count <span class="op">=</span> all_ids.<span class="bu">map</span>(get_chunks_count)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How to generate bar plot?</p>
</section>
<section id="reply-36" class="level5">
<h5 class="anchored" data-anchor-id="reply-36">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>You can create a bar plot using matplotlib! Hereâ€™s a simple approach:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>plt.bar(<span class="bu">range</span>(<span class="bu">len</span>(chunks_count)), chunks_count)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Document Index'</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of Chunks'</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Chunks per Document'</span>)</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to try this, or do you want to customize it further (like adding document names on x-axis)?</p>
<div id="f0b1672d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>plt.bar(<span class="bu">range</span>(<span class="bu">len</span>(chunks_count)), chunks_count)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Document Index'</span>)</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Number of Chunks'</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Chunks per Document'</span>)</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_wattbot_exploration_solveit_files/figure-html/cell-28-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="c3cb6e40" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_batched(doc_id):</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    embs <span class="op">=</span> model.encode(chunks)  <span class="co"># Batch encode all chunks at once</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>embs[i].tolist(), payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Generating the embedding is taking lot of time locally. Can we generate the embedding from fireworks.ai?</p>
</section>
<section id="reply-37" class="level5">
<h5 class="anchored" data-anchor-id="reply-37">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! Using Fireworks.ai for embeddings could be much faster than local processing. Youâ€™d need to:</p>
<ol type="1">
<li>Install the Fireworks client: <code>pip install fireworks-ai</code></li>
<li>Set up your Fireworks API key</li>
<li>Use their embedding API instead of the local model</li>
</ol>
<p>However, there are trade-offs: - <strong>Pros</strong>: Much faster, no local compute needed - <strong>Cons</strong>: API costs, need internet connection, data sent to external service</p>
<p>Do you have a Fireworks.ai account and API key? And are you comfortable with sending your PDF content to their API for embedding generation?</p>
<div id="2c0cb707" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">-</span>q fireworks<span class="op">-</span>ai</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
</div>
<p>Yes I have the fireworks account and I am sending PDF content to their API for embedding generation</p>
</section>
<section id="reply-38" class="level5">
<h5 class="anchored" data-anchor-id="reply-38">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now you need to set up the Fireworks client. Youâ€™ll need to:</p>
<ol type="1">
<li>Set your Fireworks API key as an environment variable</li>
<li>Replace the local embedding model with Fireworks API calls</li>
</ol>
<p>Do you have your Fireworks API key ready to set as an environment variable?</p>
<p>I have already set the environment variable; letâ€™s get started.</p>
</section>
<section id="reply-39" class="level5">
<h5 class="anchored" data-anchor-id="reply-39">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s set up the Fireworks client and test it with a small batch first:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fireworks.client</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>fireworks.client.api_key <span class="op">=</span> os.getenv(<span class="st">"FIREWORKS_API_KEY"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Which Fireworks embedding model would you like to use? They have several options like <code>nomic-ai/nomic-embed-text-v1.5</code> or others. Do you have a preference?</p>
<p>I want to go for a sweet spot between accuracy and speed.</p>
</section>
<section id="reply-40" class="level5">
<h5 class="anchored" data-anchor-id="reply-40">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>For a good balance between accuracy and speed, Iâ€™d recommend <code>nomic-ai/nomic-embed-text-v1.5</code>. Itâ€™s fast, cost-effective, and performs well for retrieval tasks.</p>
<p>Letâ€™s test it with a few chunks first:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fireworks.client</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>fireworks.client.api_key <span class="op">=</span> os.getenv(<span class="st">"FIREWORKS_API_KEY"</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with a few chunks</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>test_response <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>chunks[:<span class="dv">3</span>]</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we try this to see if the API connection works?</p>
<div id="4e3bcef6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fireworks.client</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>fireworks.client.api_key <span class="op">=</span> os.getenv(<span class="st">"FIREWORKS_API_KEY"</span>)</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test with a few chunks</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>test_response <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>chunks[:<span class="dv">3</span>]</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
</div>
<p>How to resolve the error? I got the embedding</p>
</section>
<section id="reply-41" class="level5">
<h5 class="anchored" data-anchor-id="reply-41">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>That error is just a warning about an unclosed session - it doesnâ€™t affect the functionality. Your embeddings were created successfully!</p>
<p>Letâ€™s check the response structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of embeddings: </span><span class="sc">{</span><span class="bu">len</span>(test_response.data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Embedding dimension: </span><span class="sc">{</span><span class="bu">len</span>(test_response.data[<span class="dv">0</span>].embedding)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this to see the embedding dimensions?</p>
<div id="904c3608" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(test_response.data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>3</code></pre>
</div>
</div>
<div id="03a17f46" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(test_response.data[<span class="dv">0</span>].embedding)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>768</code></pre>
</div>
</div>
<p>I think we might need to update the collectionâ€™s vector size</p>
</section>
<section id="reply-42" class="level5">
<h5 class="anchored" data-anchor-id="reply-42">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Exactly right! The Fireworks model creates 768-dimensional vectors, but your Qdrant collection is configured for 384 dimensions.</p>
<p>You have two options: 1. <strong>Create a new collection</strong> with 768 dimensions 2. <strong>Recreate the existing collection</strong> (this will delete the 3 test points)</p>
<p>Which would you prefer?</p>
<p>Lets create a new collection</p>
</section>
<section id="reply-43" class="level5">
<h5 class="anchored" data-anchor-id="reply-43">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s create a new collection with 768 dimensions for the Fireworks embeddings:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>new_collection_name <span class="op">=</span> <span class="st">"wattbot_documents_768"</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>client.create_collection(</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    collection_name<span class="op">=</span>new_collection_name,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span><span class="dv">768</span>, distance<span class="op">=</span>Distance.COSINE)</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we create this new collection?</p>
<div id="ca049dc9" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>new_collection_name <span class="op">=</span> <span class="st">"wattbot_documents_768"</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> client.collection_exists(new_collection_name):</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    client.create_collection(collection_name<span class="op">=</span>new_collection_name, vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span><span class="dv">768</span>, distance<span class="op">=</span>Distance.COSINE))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>So what is next?</p>
</section>
<section id="reply-44" class="level5">
<h5 class="anchored" data-anchor-id="reply-44">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now we need to update your <code>create_points_batched</code> function to use the Fireworks API instead of the local model:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_fireworks(doc_id):</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use Fireworks API for embeddings</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>,</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">input</span><span class="op">=</span>chunks</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>response.data[i].embedding, payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this with one document first?</p>
<div id="87c6e52c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_fireworks(doc_id):</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use Fireworks API for embeddings</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fireworks.client.Embedding.create(model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, <span class="bu">input</span><span class="op">=</span>chunks)</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>response.data[i].embedding, payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="11caccf4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>doc_id <span class="op">=</span> all_ids[<span class="dv">0</span>]<span class="op">;</span> doc_id</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'amazon2023'</code></pre>
</div>
</div>
<div id="7baf0075" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="01737a2e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(chunks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>322</code></pre>
</div>
</div>
<div id="f90f5ade" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb90"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>chunks[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Amazon \nSustainability \nReport\n2023 Contents\nOverview\n3 Introduction\n4 A Letter from Our Chief \nSustainability Officer\xa0\n5 How We Work\n6 Goals Summary\n7 2023 Year in Review \xa0\nEnvironment\n9 Carbon\n24 Carbon-Free Energy\n29 Packaging \n34 Waste and Circularity\n40 Water\nValue Chain\n45 Human Rights \n50 Responsible Supply Chain\n58 Sustainable Products and \nMaterials \n64 Supplier Diversity \n67 Community Impact\nPeople\n75 Employee Experience\n81 Health and Safety\n86 Inclusive Experiences\nAppendix\n94  Sustainability Reporting Topic \nAssessment\n95  Endnotes\n96 Assurance Statements \n97 Disclaimer and Forward-Looking \nStatements \nOn the cover  \nThe Baldy Mesa Solar and Storage Project (developed \nand operated by AES), located in Adelanto, California. Employees inside one of our newest office buildings in Bellevue, \nWashington.\nIntroduction 2023 Year in ReviewGoals SummaryHow We WorkCSO Letter\nAbout This Report\nThis is our sixth annual report detailing progress against \nour goals\xa0  and environmental, social, and governance \ntopics. All financial figures are reported in U.S. dollars ($), \nunless otherwise stated. The data within this report reflects \nprogress from January 1 through December 31, 2023, unless \notherwise indicated. This report includes information about \nmany business units and subsidiaries including AWS, Devices, \nFresh, Whole Foods Market, Amazon Private Brands, Twitch, \nMGM Studios, and Ring.\nOur 2023 Sustainability Report is structured into three \nmain categories: Environment'</code></pre>
</div>
</div>
<p>How to resolve the error?</p>
</section>
<section id="reply-45" class="level5">
<h5 class="anchored" data-anchor-id="reply-45">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The error suggests the request is too large - 322 chunks might exceed Fireworksâ€™ API limits. Letâ€™s try processing in smaller batches:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_embeddings_batch(chunks, model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, bs<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> fc.L()</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> fc.chunked(chunks, chunk_sz<span class="op">=</span>bs):</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> fireworks.client.Embedding.create(model<span class="op">=</span>model, <span class="bu">input</span><span class="op">=</span>batch)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>        embeddings.extend([data.embedding <span class="cf">for</span> data <span class="kw">in</span> response.data])</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> embeddings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we try this batched approach?</p>
<div id="5adca5f3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_embeddings_batch(chunks, model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, bs<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> fc.L()</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> fc.chunked(chunks, chunk_sz<span class="op">=</span>bs):</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> fireworks.client.Embedding.create(model<span class="op">=</span>model, <span class="bu">input</span><span class="op">=</span>batch)</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>        embeddings.extend([data.embedding <span class="cf">for</span> data <span class="kw">in</span> response.data])</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> embeddings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="5ed8aafb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>emb <span class="op">=</span> create_embeddings_batch(chunks)</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(emb), <span class="bu">len</span>(emb[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>(322, 768)</code></pre>
</div>
</div>
<p>And now how shall we modify the create_points_fireworks function.</p>
</section>
<section id="reply-46" class="level5">
<h5 class="anchored" data-anchor-id="reply-46">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Now letâ€™s update the <code>create_points_fireworks</code> function to use the batched embedding approach:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_fireworks(doc_id):</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> create_embeddings_batch(chunks)</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>embeddings[i], payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated function with one document?</p>
<div id="02c4f9df" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points_fireworks(doc_id):</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> rd.read_pdf(data_path<span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf"</span>)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="bu">list</span>(sliding_window_chunks(text, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>))</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    embeddings <span class="op">=</span> create_embeddings_batch(chunks)</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fc.L([PointStruct(<span class="bu">id</span><span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span>, vector<span class="op">=</span>embeddings[i], payload<span class="op">=</span>create_payload(i, chunk, doc_id)) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For all the ids it is taking lot of time. Is there a way to slow the process?</p>
</section>
<section id="reply-47" class="level5">
<h5 class="anchored" data-anchor-id="reply-47">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! There are several ways to make the process more manageable:</p>
<ol type="1">
<li><strong>Process fewer documents at a time</strong> - Start with just 5-10 documents</li>
<li><strong>Add progress tracking</strong> - See which document is being processed</li>
<li><strong>Save progress</strong> - Store completed documents so you can resume if interrupted</li>
</ol>
<p>Which approach would you prefer to try first?</p>
<p>Lets do 10 documetns at a time and concatenate those results</p>
</section>
<section id="reply-48" class="level5">
<h5 class="anchored" data-anchor-id="reply-48">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Letâ€™s process 10 documents at a time. Hereâ€™s how we can do it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Process first 10 documents</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>batch_1_ids <span class="op">=</span> all_ids[:<span class="dv">10</span>]</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>batch_1_points <span class="op">=</span> fc.parallel(create_points_fireworks, batch_1_ids, threadpool<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>all_points_batch1 <span class="op">=</span> batch_1_points.flatten()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we try this with the first batch of 10 documents?</p>
<div id="00149c9b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>batch_ids <span class="op">=</span> fc.L(fc.chunked(all_ids, n_chunks<span class="op">=</span><span class="dv">3</span>))</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>batch_ids.<span class="bu">map</span>(<span class="bu">len</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(#3) [11,11,10]</code></pre>
</div>
</div>
<div id="ef791012" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>first_batch_points <span class="op">=</span> fc.parallel(create_points_fireworks, batch_ids[<span class="dv">0</span>], threadpool<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
</div>
<div id="e37d86ee" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(first_batch_points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>11</code></pre>
</div>
</div>
<div id="d76d718c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>second_batch_points <span class="op">=</span> fc.parallel(create_points_fireworks, batch_ids[<span class="dv">1</span>], threadpool<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
</div>
<div id="72f95451" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(second_batch_points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>11</code></pre>
</div>
</div>
<div id="380da031" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>third_batch_points <span class="op">=</span> fc.parallel(create_points_fireworks, batch_ids[<span class="dv">2</span>], threadpool<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(third_batch_points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>10</code></pre>
</div>
</div>
<div id="df437454" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>all_points <span class="op">=</span> fc.L(first_batch_points.concat(), second_batch_points.concat(), third_batch_points.concat()).concat()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="b27b175b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(all_points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>1899</code></pre>
</div>
</div>
<p>Now how shall I upate to collection?</p>
</section>
<section id="reply-49" class="level5">
<h5 class="anchored" data-anchor-id="reply-49">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! You have 1,899 points ready to upload. Now letâ€™s upload them to your new collection:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>client.upsert(collection_name<span class="op">=</span>new_collection_name, points<span class="op">=</span>all_points)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Uploaded </span><span class="sc">{</span><span class="bu">len</span>(all_points)<span class="sc">}</span><span class="ss"> points to </span><span class="sc">{</span>new_collection_name<span class="sc">}</span><span class="ss">!"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we upload all the points to Qdrant?</p>
<p>I am getting the above error</p>
</section>
<section id="reply-50" class="level5">
<h5 class="anchored" data-anchor-id="reply-50">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The error shows that Qdrant requires point IDs to be either integers or UUIDs, but weâ€™re using string IDs like â€œamazon2023_0â€.</p>
<p>We need to generate numeric IDs instead. Hereâ€™s a simple fix:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate unique numeric IDs</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, point <span class="kw">in</span> <span class="bu">enumerate</span>(all_points):</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    point.<span class="bu">id</span> <span class="op">=</span> i</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update the IDs and try uploading again?</p>
<div id="31865b41" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_id(p):</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>    p[<span class="dv">1</span>].<span class="bu">id</span> <span class="op">=</span> p[<span class="dv">0</span>]</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>all_points.<span class="bu">enumerate</span>().<span class="bu">map</span>(assign_id)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(#1899) [None,None,None,None,None,None,None,None,None,None,None,None,None,None,None,None,None,None,None,None...]</code></pre>
</div>
</div>
<div id="8c888af5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>client.upsert(collection_name<span class="op">=</span>new_collection_name, points<span class="op">=</span><span class="bu">list</span>(all_points))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>UpdateResult(operation_id=5, status=&lt;UpdateStatus.COMPLETED: 'completed'&gt;)</code></pre>
</div>
</div>
<p>Now what is next?</p>
</section>
<section id="reply-51" class="level5">
<h5 class="anchored" data-anchor-id="reply-51">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! Youâ€™ve successfully uploaded all 1,899 points to your Qdrant collection. Now letâ€™s test the search functionality with the new collection:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"carbon emissions reduction"</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, </span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>[query]</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>).data[<span class="dv">0</span>].embedding</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    collection_name<span class="op">=</span>new_collection_name, </span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    query<span class="op">=</span>query_vector, </span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">3</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this search to see if it returns relevant results?</p>
<div id="428577a5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="st">"carbon emissions reduction"</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, </span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>[query]</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>).data[<span class="dv">0</span>].embedding</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>    collection_name<span class="op">=</span>new_collection_name, </span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>    query<span class="op">=</span>query_vector, </span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">3</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results.points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>3</code></pre>
</div>
</div>
<p>It is working fine</p>
</section>
<section id="reply-52" class="level5">
<h5 class="anchored" data-anchor-id="reply-52">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Your RAG database is now fully functional with all 32 documents indexed and searchable.</p>
<p>What would you like to do next? You could:</p>
<ol type="1">
<li><strong>Test different queries</strong> to see how well it retrieves relevant content</li>
<li><strong>Build a simple query interface</strong> function for easier searching</li>
<li><strong>Add filtering capabilities</strong> (by document type, year, etc.)</li>
</ol>
<p>Which interests you most?</p>
<p>I have uploaded the train_QA.csv to watt_bot_data folder. I want to check how our RAG is performing.</p>
</section>
<section id="reply-53" class="level5">
<h5 class="anchored" data-anchor-id="reply-53">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea to evaluate your RAG system! Letâ€™s start by examining the QA dataset to understand its structure.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>qa_df <span class="op">=</span> pd.read_csv(data_path<span class="op">/</span><span class="st">'train_QA.csv'</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(qa_df.head())</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dataset shape: </span><span class="sc">{</span>qa_df<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Can you run this to see what questions and answers are in your evaluation dataset?</p>
<div id="0c87ba85" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>qa_df <span class="op">=</span> pd.read_csv(data_path<span class="op">/</span><span class="st">'train_QA.csv'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[1]</span><span class="ansi-green-fg">, line 1</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">1</span> qa_df = pd.read_csv(<span class="ansi-yellow-bg">data_path</span>/<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">train_QA.csv</span><span class="ansi-yellow-fg">'</span>)

<span class="ansi-red-fg">NameError</span>: name 'data_path' is not defined</pre>
</div>
</div>
</div>
<div id="a0923c08" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>qa_df.head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>q003</td>
<td>What is the name of the benchmark suite presen...</td>
<td>The ML.ENERGY Benchmark</td>
<td>ML.ENERGY Benchmark</td>
<td>is_blank</td>
<td>['chung2025']</td>
<td>['https://arxiv.org/pdf/2505.06371']</td>
<td>We present the ML.ENERGY Benchmark, a benchmar...</td>
<td>Quote</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>q009</td>
<td>What were the net CO2e emissions from training...</td>
<td>4.3 tCO2e</td>
<td>4.3</td>
<td>tCO2e</td>
<td>['patterson2021']</td>
<td>['https://arxiv.org/pdf/2104.10350']</td>
<td>"Training GShard-600B used 24 MWh and produced...</td>
<td>Quote</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Are you aware of the scoring mechanism?</p>
</section>
<section id="reply-54" class="level5">
<h5 class="anchored" data-anchor-id="reply-54">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>I can see your QA dataset has questions with expected answers, but Iâ€™m not familiar with the specific scoring mechanism youâ€™re using.</p>
<p>Could you tell me what scoring approach youâ€™d like to use? For example: - Exact match scoring - Semantic similarity between retrieved and expected answers - Custom scoring based on the <code>answer_value</code> and <code>answer_unit</code> columns</p>
<p>What scoring method would work best for your evaluation?</p>
<p>ML+X Â· Community Prediction Competition</p>
</section>
<section id="wattbot-2025" class="level1">
<h1>WattBot 2025</h1>
<p>Evidence-based energy estimation for AI workloads using retrieval augmented generation (RAG).</p>
<section id="wattbot-2025-1" class="level2">
<h2 class="anchored" data-anchor-id="wattbot-2025-1">WattBot 2025</h2>
<p>OverviewDataCodeModelsDiscussionLeaderboardRulesTeamSubmissions</p>
</section>
<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>AI systems can consume vast amounts of energy and water, but reliable emissions data remains hard to find and harder to trust. In this challenge, youâ€™ll build a retrieval-augmented generation (RAG) system that extracts credible environmental impact estimates from academic articles and reports. Your model must output concise, citation-backed answersâ€”or explicitly indicate when the evidence is missing. The goal: turn scattered academic knowledge into transparent, actionable insights for researchers, engineers, and policy makers.</p>
</section>
<section id="background" class="level2">
<h2 class="anchored" data-anchor-id="background">Background</h2>
<p>The environmental impact of artificial intelligence (AI) is an emerging concern in both industry and academia. As large models grow in popularity, so do their energy and resource requirementsâ€”raising questions about carbon emissions, water usage, and sustainability practices across the AI lifecycle. However, the knowledge needed to estimate or compare these impacts is often buried in technical literature, scattered across domains like machine learning, energy systems, and environmental science. Retrieval-augmented generation (RAG) offers a promising approach to extracting and synthesizing this information from unstructured documents. By combining document retrieval with generative language models, RAG systems can produce factually grounded answers supported by references.</p>
</section>
<section id="goal" class="level2">
<h2 class="anchored" data-anchor-id="goal">Goal</h2>
<p>In this challenge, youâ€™ll use RAG to tackle real sustainability questions, drawing from a curated corpus of over 30 scholarly articles on AIâ€™s environmental impact. Your system should generate responses that include:</p>
<ul>
<li>A concise natural-language answer</li>
<li><code>ref_id</code> â€“ ID(s) of the cited document(s) from <code>metadata.csv</code></li>
<li><code>supporting_materials</code> â€“ Supporting materials from the retrieved reference(s) (e.g., a verbatim quote, table reference, or figure reference)</li>
<li><code>explanation</code> â€“ Reasoning that connects the supporting materials to the final answer.</li>
</ul>
<p>If no evidence exists, your system must emit the standardized fallback. Scores combine retrieval precision, numerical accuracy, and citation faithfulness.</p>
</section>
<section id="provided-data" class="level2">
<h2 class="anchored" data-anchor-id="provided-data">Provided Data</h2>
<ul>
<li><code>metadata.csv</code>: Contains document IDs, titles, and full citations</li>
<li><code>train_QA.csv</code>: Sample questions with answers and references provided</li>
<li><code>test_Q.csv</code>: Test questions to be used for evaluation (answers not provided). Your solution file must provide answers to these questions for evaluation.</li>
</ul>
<section id="question-types-examples" class="level3">
<h3 class="anchored" data-anchor-id="question-types-examples">Question Types &amp; Examples</h3>
<p>All questions expect either (i) a numeric value, (ii) a specific term / concept name, or (iii) a True/False answer. Examples include:</p>
<ul>
<li><p><strong>Question</strong> : What is the estimated CO2 emissions (in pounds) from training the BERTâ€‘base model for 79 hours on 64 V100 GPUs?<br>
<strong>Answer</strong> : 1438 lbs. Supporting refID(s): [strubel2019], Supporting materials: [Table 3].</p></li>
<li><p><strong>Question</strong> : True or False: New AI data centers often rely on air cooling due to high server power densities.<br>
<strong>Answer</strong> : FALSE. Supporting refID(s): [li2025b], Supporting materials: [â€œIn general, new data centers dedicated to AI training often rely on liquid cooling due to the high server power densities.â€]</p></li>
<li><p><strong>Question</strong> : What term refers to the amount of water evaporated, transpired, or incorporated into products, defined as â€œwater withdrawal minus water dischargeâ€?<br>
<strong>Answer</strong> : Water consumption. Supporting refID(s): [li2025b], Supporting materials: [â€œWater consumption: It is defined as â€œwater withdrawal minus water dischargeâ€, and means the amount of water â€œevaporated, transpired, incorporated into products or crops, or otherwise removed from the immediate water environment [13].â€â€]</p></li>
<li><p><strong>Question</strong> : How much does an elephant weigh?<br>
<strong>Answer</strong> : Unable to answer with confidence based on the provided documents.</p></li>
</ul>
<p><strong>Refer to to the train_QA.csv to explore other Q &amp;A examples.</strong></p>
</section>
<section id="considerations" class="level3">
<h3 class="anchored" data-anchor-id="considerations">Considerations</h3>
<ul>
<li>A small portion of questions require combining information from multiple documents (e.g., GPU power specs from one source and emissions rates from another).</li>
<li>A small portion of questions involve visual reasoning â€” for example, interpreting a graph in a paper to extract values. Participants are encouraged to use OCR techniques to extract information from figures, tables, or scanned pages where necessary.</li>
<li>A small portion of questions are intentionally unanswerable based on the provided corpus; your system must recognize and handle these appropriately.</li>
</ul>
</section>
</section>
<section id="expected-output-format" class="level2">
<h2 class="anchored" data-anchor-id="expected-output-format">Expected Output Format</h2>
<p>Each system prediction must include the all fields listed in <code>train_QA.csv</code></p>
<ul>
<li><strong><code>id</code></strong> : The question ID (e.g., <code>q001</code>)</li>
<li><strong><code>question</code></strong> : The original question text</li>
<li><strong><code>answer</code></strong> : A clear natural-language response (e.g., <code>1438 lbs</code>, <code>Water consumption</code>, <code>TRUE</code>)â€™.
<ul>
<li>If no answer is possible, use <code>"Unable to answer with confidence based on the provided documents."</code></li>
</ul></li>
<li><strong><code>answer_value</code></strong> : The normalized numeric or categorical value (e.g., <code>1438</code>, <code>Water consumption</code>, <code>1</code>)
<ul>
<li>If no answer is possible, use <code>is_blank</code></li>
<li>Ranges should be encoded as <code>[low,high]</code></li>
<li>Do <strong>not</strong> include symbols like <code>&lt;</code>, <code>&gt;</code>, <code>~</code> here. Those can be left in the clear natural language column.</li>
</ul></li>
<li><strong><code>answer_unit</code></strong> : Unit of measurement (e.g., <code>lbs</code>, <code>kWh</code>, <code>gCO2</code>, <code>projects</code>, <code>is_blank</code>).</li>
<li><strong><code>ref_id</code></strong> : One or more document IDs from <code>metadata.csv</code> that support the answer.</li>
<li><strong><code>ref_url</code></strong> : One or more URL(s) of the cited document(s).</li>
<li><strong><code>supporting_materials</code></strong> : Verbatim justification from the cited document (quote, table reference, figure reference, etc.).</li>
<li><strong><code>explanation</code></strong> : Short reasoning describing why the cited material supports the answer.</li>
</ul>
<p><strong>Refer to to the train_QA.csv to study the expected formatting conventions.</strong></p>
</section>
<section id="scoring" class="level2">
<h2 class="anchored" data-anchor-id="scoring">Scoring</h2>
<p>Submissions are scored with a custom WattBot score that evaluates three fields for every question and returns a weighted accuracy between <strong>0 â€“ 1</strong> :</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Weight</th>
<th>What counts as correct</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>answer_value</strong></td>
<td><strong>0.75</strong></td>
<td>Matches the ground truth. Numeric answers must be within Â±0.1% relative tolerance; categorical values (e.g.&nbsp;<code>TRUE</code>, <code>FALSE</code>, <code>Water consumption</code>) must match exactly after normalization. If a question is unanswerable, this column must contain <code>is_blank</code>.</td>
</tr>
<tr class="even">
<td><strong>ref_id</strong></td>
<td><strong>0.15</strong></td>
<td>Partial credit via Jaccard overlap between your ref_id set and the ground-truth set (order ignored, case-insensitive). Use â€˜is_blankâ€™ if no evidence is available.</td>
</tr>
<tr class="odd">
<td><strong>is_NA</strong></td>
<td><strong>0.10</strong></td>
<td>For truly unanswerable questions, your submission must mark all relevant fields (<code>answer_value</code>, <code>answer_unit</code>, <code>ref_id</code>, <code>ref_url</code>, <code>supporting_materials</code>) as <code>is_blank</code>. Any other combination scores 0 for this component.</td>
</tr>
</tbody>
</table>
<section id="notes" class="level3">
<h3 class="anchored" data-anchor-id="notes">Notes</h3>
<ul>
<li>Only the answer_value and ref_id columns will be evaluated, but full responses are still expected in the other columns. Youâ€™re encouraged to make the <code>explanation</code> field as useful and detailed as possible to help with debugging and calibrating your RAG pipeline. While short quotes or table references are acceptable, longer natural-language justifications and multi-sentence explanations are also encouraged.</li>
<li>The public leaderboard reports the mean WattBot Score on a subset of the test set. A hidden portion is used after the competition deadline for final rankings.</li>
</ul>
</section>
</section>
<section id="submitting-solution" class="level2">
<h2 class="anchored" data-anchor-id="submitting-solution">Submitting solution</h2>
<p>Upload a single <strong>CSV</strong> with the same columns and formatting conventions as train_QA.csv.</p>
<p>Submit the file via <strong>Make Submission</strong>. The platform will run the metric script (ignoring the <code>explanation</code> column for scoring), return your score, and place your team on the public leaderboard.</p>
<p>Questions and answers should:</p>
<ul>
<li>follow the same conventions as train_QA.csv</li>
<li>stick to sustainability topics surrounding AI</li>
<li>be grounded in explicit evidence (quote, table, or figure) with ref ID(s)</li>
<li>be phrased to yield short, checkable answers (numbers, ranges, or categorical names)</li>
<li>to generate good Q&amp;A pairs (that challenge the best RAG systems), we recommend crafting Q&amp;A pairs that have one or more of the following qualities:
<ul>
<li>combine evidence across multiple papers</li>
<li>involve visual reasoning over figures (bonus: without supporting text to back it up so itâ€™s visual reasoning only)</li>
<li>involve simple math/unit conversions/deductions</li>
</ul></li>
</ul>
<p><strong>Send your teamâ€™s Q &amp;A pairs to endemann@wisc.edu by Oct 11</strong>.</p>
<p>I uploaded the competition overview</p>
<section id="reply-55" class="level5">
<h5 class="anchored" data-anchor-id="reply-55">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Thanks for sharing the competition overview! Now I understand the WattBot 2025 scoring mechanism. It evaluates three components:</p>
<ol type="1">
<li><strong>answer_value</strong> (75% weight) - Must match ground truth within Â±0.1% for numbers, exactly for categories</li>
<li><strong>ref_id</strong> (15% weight) - Jaccard overlap with ground truth reference IDs<br>
</li>
<li><strong>is_NA</strong> (10% weight) - Correctly identifying unanswerable questions</li>
</ol>
<p>To evaluate your RAG system, we should test it on some questions from <code>train_QA.csv</code> and see how well it retrieves the right documents and extracts accurate answers.</p>
<p>Should we start by testing your RAG on one question from the training set?</p>
<p>Sure</p>
</section>
<section id="reply-56" class="level5">
<h5 class="anchored" data-anchor-id="reply-56">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s test your RAG system with the first question from the training set:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>test_question <span class="op">=</span> qa_df.iloc[<span class="dv">0</span>]</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>test_question[<span class="st">'question'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected answer: </span><span class="sc">{</span>test_question[<span class="st">'answer'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected ref_id: </span><span class="sc">{</span>test_question[<span class="st">'ref_id'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see the first test question?</p>
<div id="8892d47d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>test_question <span class="op">=</span> qa_df.iloc[<span class="dv">0</span>]</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>test_question[<span class="st">'question'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected answer: </span><span class="sc">{</span>test_question[<span class="st">'answer'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected ref_id: </span><span class="sc">{</span>test_question[<span class="st">'ref_id'</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Question: What is the name of the benchmark suite presented in a recent paper for measuring inference energy consumption?
Expected answer: The ML.ENERGY Benchmark
Expected ref_id: ['chung2025']</code></pre>
</div>
</div>
<p>Yes it works</p>
</section>
<section id="reply-57" class="level5">
<h5 class="anchored" data-anchor-id="reply-57">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now letâ€™s test your RAG system on this question. We need to:</p>
<ol type="1">
<li>Query your Qdrant collection with this question</li>
<li>See what documents it retrieves</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>question_text <span class="op">=</span> test_question[<span class="st">'question'</span>]</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, </span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>[question_text]</span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a>).data[<span class="dv">0</span>].embedding</span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(</span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a>    collection_name<span class="op">=</span>new_collection_name, </span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a>    query<span class="op">=</span>query_vector, </span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">5</span></span>
<span id="cb132-11"><a href="#cb132-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see what your RAG retrieves for this question?</p>
<div id="21767404" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb133"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>question_text <span class="op">=</span> test_question[<span class="st">'question'</span>]</span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> fireworks.client.Embedding.create(</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, </span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>[question_text]</span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>).data[<span class="dv">0</span>].embedding</span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(</span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>    collection_name<span class="op">=</span>new_collection_name, </span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    query<span class="op">=</span>query_vector, </span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>    limit<span class="op">=</span><span class="dv">5</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(results.points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>5</code></pre>
</div>
</div>
<p>It is giving the right answer.</p>
</section>
<section id="reply-58" class="level5">
<h5 class="anchored" data-anchor-id="reply-58">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! Your RAG system is retrieving relevant content for the question.</p>
<p>Now letâ€™s check if it retrieved the correct document. Can you see what <code>doc_id</code> is in the top result?</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Retrieved doc_id: </span><span class="sc">{</span>results<span class="sc">.</span>points[<span class="dv">0</span>]<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Expected doc_id: chung2025"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Does it match the expected reference?</p>
<div id="1fbcc803" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>results.points[<span class="dv">0</span>].payload[<span class="st">'doc_id'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'chung2025'</code></pre>
</div>
</div>
<p>Yes it matches the expected result</p>
</section>
<section id="reply-59" class="level5">
<h5 class="anchored" data-anchor-id="reply-59">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Your RAG system correctly retrieved the right document (<code>chung2025</code>) for this question. This means your retrieval is working well.</p>
<p>To fully evaluate your system, youâ€™d need to: 1. Extract the actual answer from the retrieved text 2. Compare it against the expected answer â€œThe ML.ENERGY Benchmarkâ€ 3. Calculate the WattBot score</p>
<p>Would you like to build a simple evaluation function to test more questions, or focus on improving a specific part of your RAG pipeline?</p>
<p>Dont we have to use the LLM for extracting the actual answer from the retrieved text?</p>
</section>
<section id="reply-60" class="level5">
<h5 class="anchored" data-anchor-id="reply-60">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Absolutely right! You need an LLM to read the retrieved text chunks and extract the specific answer to the question.</p>
<p>Your current RAG system only does the retrieval part - it finds relevant documents but doesnâ€™t generate the final answer from that context.</p>
<p>Would you like to: 1. Add an LLM (like GPT or Claude) to generate answers from retrieved chunks 2. Use a local LLM 3. Try Fireworks.ai for the generation step too</p>
<p>Whatâ€™s your preference for the answer generation component?</p>
<p>Lets try the fireworks api for the generation step too</p>
</section>
<section id="reply-61" class="level5">
<h5 class="anchored" data-anchor-id="reply-61">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great choice! Fireworks.ai has good chat/completion models for generation.</p>
<p>First, letâ€™s see what models are available. You can use models like <code>accounts/fireworks/models/llama-v3p1-8b-instruct</code> or <code>accounts/fireworks/models/llama-v3p1-70b-instruct</code>.</p>
<p>Which model would you prefer - the faster 8B model or the more capable 70B model?</p>
<p>Lets use the most capable one</p>
</section>
<section id="reply-62" class="level5">
<h5 class="anchored" data-anchor-id="reply-62">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s use the 70B model for better answer quality. Hereâ€™s how to set up the generation step:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb139"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fireworks.client</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_answer(question, retrieved_chunks, model<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([chunk.payload[<span class="st">'text'</span>] <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""Based on the following context, answer the question. If you cannot find the answer in the context, respond with "Unable to answer with confidence based on the provided documents."</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a><span class="ss">Context: </span><span class="sc">{</span>context<span class="sc">}</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a><span class="ss">Question: </span><span class="sc">{</span>question<span class="sc">}</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a><span class="ss">Answer:"""</span></span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fireworks.client.ChatCompletion.create(</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a>        model<span class="op">=</span>model,</span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a>        messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: prompt}]</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this with our retrieved chunks?</p>
<p>Dont we have to mention the answer format with specific to the competition overview</p>
</section>
<section id="reply-63" class="level5">
<h5 class="anchored" data-anchor-id="reply-63">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Absolutely right! The competition has very specific output requirements. We need to modify the prompt to generate all the required fields:</p>
<ul>
<li><code>answer</code> (natural language)</li>
<li><code>answer_value</code> (normalized value)</li>
<li><code>answer_unit</code> (units)</li>
<li><code>ref_id</code> (document IDs)</li>
<li><code>supporting_materials</code> (quotes/references)</li>
<li><code>explanation</code> (reasoning)</li>
</ul>
<p>Should we update the prompt to include these specific formatting requirements from the competition?</p>
<p>Yes please</p>
</section>
<section id="reply-64" class="level5">
<h5 class="anchored" data-anchor-id="reply-64">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s create a prompt that generates all the required competition fields:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_wattbot_answer(question, retrieved_chunks, model<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    prompt <span class="op">=</span> <span class="ss">f"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="ss">  "answer": "natural language answer",</span></span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a><span class="ss">  "answer_value": "normalized value (number, category, or 'is_blank')",</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a><span class="ss">  "answer_unit": "unit of measurement or 'is_blank'",</span></span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a><span class="ss">  "ref_id": ["doc_id1", "doc_id2"],</span></span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a><span class="ss">  "supporting_materials": "verbatim quote or reference from documents",</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  "explanation": "reasoning connecting materials to answer"</span></span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a><span class="ss">If no answer can be found, use "Unable to answer with confidence based on the provided documents." for answer and "is_blank" for other fields.</span></span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a><span class="ss">Context: </span><span class="sc">{</span>context<span class="sc">}</span></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a><span class="ss">Question: </span><span class="sc">{</span>question<span class="sc">}</span></span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a><span class="ss">Response:"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated prompt structure?</p>
<div id="59952403" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb141"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>qa_df[<span class="st">'explanation'</span>].values</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>array(['Quote', 'Quote', 'Table 3', 'is_blank',
       'The &gt;40% statement is explicit in Wu. Patterson\'s PUE numbers (1.59 vs 1.11) provide a numeric example consistent with "more than 40% higher efficiency."',
       'The paper states that one 500ml bottle is consumed for every 10 to 50 responses. Therefore, one response consumes 1/50 to 1/10 of a bottle, which is 0.02 to 0.1 bottles.',
       'Requires calculation (75-20)', 'Quote', 'Figure', 'Quote',
       'Table', 'Quote', 'Quote', 'Quote', 'Quote', 'Quote', 'is_blank',
       'Figure', '1438 lbs / 99.8 lbs/day = 14.4 ', 'Figure', 'Quote',
       'Quote', 'Quote', 'Quote', 'Figure', 'Quote', 'Quote', 'Quote',
       'Quote', 'Quote', 'Table', 'Quote',
       '13.8 MWh Ã· 10.7 MWh/yr â‰ˆ 1.3 household-years.', 'Figure, Quote',
       'Math: wall_clock_hours â‰ˆ 30,000 GPUh Ã· 96 GPUs = 312.5 h; days â‰ˆ 312.5 Ã· 24 â‰ˆ 13.0 days (pretraining; alignment 60 GPUh is separate).',
       'Quote', 'Quote', ' 48.66/5.58 ', '0.009â†’0.004=55.6%', 'Quote',
       'Table'], dtype=object)</code></pre>
</div>
</div>
<p>How to change the prompt to have the explanation in the above format?</p>
</section>
<section id="reply-65" class="level5">
<h5 class="anchored" data-anchor-id="reply-65">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Looking at the explanation formats, they vary from simple â€œQuoteâ€ to complex calculations. Letâ€™s update the prompt to guide the LLM to use these specific explanation styles:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="ss">f"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a><span class="ss">For explanation field, use one of these formats:</span></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="ss">- "Quote" - if answer comes directly from text</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="ss">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="ss">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a><span class="ss">- "is_blank" - if unanswerable</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a><span class="ch">{{</span></span>
<span id="cb143-10"><a href="#cb143-10" aria-hidden="true" tabindex="-1"></a><span class="ss">  "answer": "natural language answer",</span></span>
<span id="cb143-11"><a href="#cb143-11" aria-hidden="true" tabindex="-1"></a><span class="ss">  "answer_value": "normalized value",</span></span>
<span id="cb143-12"><a href="#cb143-12" aria-hidden="true" tabindex="-1"></a><span class="ss">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb143-13"><a href="#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="ss">  "ref_id": ["doc_id"],</span></span>
<span id="cb143-14"><a href="#cb143-14" aria-hidden="true" tabindex="-1"></a><span class="ss">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb143-15"><a href="#cb143-15" aria-hidden="true" tabindex="-1"></a><span class="ss">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb143-16"><a href="#cb143-16" aria-hidden="true" tabindex="-1"></a><span class="ch">}}</span></span>
<span id="cb143-17"><a href="#cb143-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-18"><a href="#cb143-18" aria-hidden="true" tabindex="-1"></a><span class="ss">Context: </span><span class="sc">{</span>context<span class="sc">}</span></span>
<span id="cb143-19"><a href="#cb143-19" aria-hidden="true" tabindex="-1"></a><span class="ss">Question: </span><span class="sc">{</span>question<span class="sc">}</span></span>
<span id="cb143-20"><a href="#cb143-20" aria-hidden="true" tabindex="-1"></a><span class="ss">Response:"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated format?</p>
<div id="39806323" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb144"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="st">For explanation field, use one of these formats:</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="st">- "Quote" - if answer comes directly from text</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="st">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a><span class="st">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="st">- "is_blank" - if unanswerable</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="sc">{{</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer": "natural language answer",</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_value": "normalized value",</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_id": ["doc_id"],</span></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_url": ["ref_ur"],</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a><span class="st">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="st">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a><span class="sc">}}</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{context}</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{question}</span></span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a><span class="st">Response:"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bee9ef63" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>prompt.<span class="bu">format</span>(context<span class="op">=</span><span class="st">'hi'</span>, question<span class="op">=</span><span class="st">'bye'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:\n\nFor explanation field, use one of these formats:\n- "Quote" - if answer comes directly from text\n- "Table" or "Figure" - if from visual elements  \n- "Math: [calculation]" - if requires computation\n- "is_blank" - if unanswerable\n\n{\n  "answer": "natural language answer",\n  "answer_value": "normalized value",\n  "answer_unit": "unit or \'is_blank\'",\n  "ref_id": ["doc_id"],\n  "ref_url": ["ref_ur"],\n  "supporting_materials": "exact quote or reference",\n  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"\n}\n\nContext: hi\nQuestion: bye\nResponse:'</code></pre>
</div>
</div>
<div id="6478a161" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_wattbot_answer(question, retrieved_chunks, model<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>What is next?</p>
</section>
<section id="reply-66" class="level5">
<h5 class="anchored" data-anchor-id="reply-66">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Now letâ€™s test the complete RAG pipeline by generating an answer for our test question:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb148"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>generated_prompt <span class="op">=</span> generate_wattbot_answer(question_text, results.points[:<span class="dv">3</span>])</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(generated_prompt[:<span class="dv">500</span>] <span class="op">+</span> <span class="st">"..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see the formatted prompt, then send it to the Fireworks API to get the generated answer?</p>
<div id="65fb7519" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>generated_prompt <span class="op">=</span> generate_wattbot_answer(question_text, results.points[:<span class="dv">3</span>])</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(generated_prompt[:<span class="dv">500</span>] <span class="op">+</span> <span class="st">"..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:

For explanation field, use one of these formats:
- "Quote" - if answer comes directly from text
- "Table" or "Figure" - if from visual elements  
- "Math: [calculation]" - if requires computation
- "is_blank" - if unanswerable

{
  "answer": "natural language answer",
  "answer_value": "normalized value",
  "answer_unit": "unit or 'is_blank'",
  "ref_id": [...</code></pre>
</div>
</div>
<p>Yes</p>
</section>
<section id="reply-67" class="level5">
<h5 class="anchored" data-anchor-id="reply-67">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Now letâ€™s send this prompt to the Fireworks API to get the generated answer:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb151"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> fireworks.client.ChatCompletion.create(</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>,</span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: generated_prompt}]</span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see what answer the LLM generates?</p>
<div id="c90b4511" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> fireworks.client.ChatCompletion.create(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>,</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: generated_prompt}]</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "answer": "ML.ENERGY Benchmark",
  "answer_value": "ML.ENERGY Benchmark",
  "answer_unit": "is_blank",
  "ref_id": ["chung2025"],
  "ref_url": ["https://arxiv.org/abs/2505.06371"],
  "supporting_materials": "The ML.ENERGY Benchmark, a benchmark suite and tool for measuring inference energy consumption under realistic service environments",
  "explanation": "Quote"
}</code></pre>
</div>
</div>
<div id="dddcfaa5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a>qa_df.iloc[<span class="dv">0</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                                                                   q003
question                What is the name of the benchmark suite presen...
answer                                            The ML.ENERGY Benchmark
answer_value                                          ML.ENERGY Benchmark
answer_unit                                                      is_blank
ref_id                                                      ['chung2025']
ref_url                              ['https://arxiv.org/pdf/2505.06371']
supporting_materials    We present the ML.ENERGY Benchmark, a benchmar...
explanation                                                         Quote
Name: 0, dtype: object</code></pre>
</div>
</div>
<p>Okay, lgtm</p>
</section>
<section id="reply-68" class="level5">
<h5 class="anchored" data-anchor-id="reply-68">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Your RAG system is working well - it successfully:</p>
<ol type="1">
<li>âœ… Retrieved the correct document (<code>chung2025</code>)</li>
<li>âœ… Generated a proper JSON response with all required fields</li>
<li>âœ… Matched the expected answer format</li>
</ol>
<p>Now you have a complete RAG pipeline that can: - Query your Qdrant database - Generate competition-formatted answers using Fireworks AI</p>
<p>Would you like to test it on a few more questions from your training set, or work on automating the evaluation process?</p>
<p>Lets work on automating the evaluation process</p>
</section>
<section id="reply-69" class="level5">
<h5 class="anchored" data-anchor-id="reply-69">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! To automate the evaluation, we need to create a function that:</p>
<ol type="1">
<li>Takes a question from your QA dataset</li>
<li>Runs it through your RAG pipeline</li>
<li>Compares the generated answer with the expected answer</li>
<li>Calculates the WattBot score</li>
</ol>
<p>Should we start by creating a function that processes one question end-to-end, or would you prefer to begin with the scoring logic first?</p>
<p>Whatever</p>
</section>
<section id="reply-70" class="level5">
<h5 class="anchored" data-anchor-id="reply-70">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s start with creating a function that processes one question end-to-end. This will help us test the complete pipeline before building the scoring logic.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_single_question(question_row):</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Get the question</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> question_row[<span class="st">'question'</span>]</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Retrieve relevant chunks</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Generate answer</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Return results</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to build this step by step, or should I write the complete function for you?</p>
<p>Write the complete function</p>
</section>
<section id="reply-71" class="level5">
<h5 class="anchored" data-anchor-id="reply-71">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Hereâ€™s the complete function to process one question through your RAG pipeline:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_single_question(question_row, emb_model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, llm<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> question_row[<span class="st">'question'</span>]</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> fireworks.client.Embedding.create(model<span class="op">=</span>model, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fireworks.client.ChatCompletion.create(model<span class="op">=</span>llm, messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>        generated_answer <span class="op">=</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> generated_answer</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"error"</span>: <span class="st">"Failed to parse JSON response"</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this function with your first question?</p>
<div id="a10f9b79" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb159"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_single_question(question_row, emb_model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, llm<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> question_row[<span class="st">'question'</span>]</span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> fireworks.client.Embedding.create(model<span class="op">=</span>emb_model, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fireworks.client.ChatCompletion.create(model<span class="op">=</span>llm, messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>        generated_answer <span class="op">=</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> generated_answer</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"error"</span>: <span class="st">"Failed to parse JSON response"</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="eb05e7b6" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>evaluate_single_question(qa_df.iloc[<span class="dv">7</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': 'False',
 'answer_value': 'False',
 'answer_unit': 'is_blank',
 'ref_id': ['ebert2024'],
 'ref_url': ['https://doi.org/10.1145/nnnnnnn.nnnnnnn'],
 'supporting_materials': 'The limited availability of this data significantly reduces transparency and accountability, thereby weakening the potential for public oversight and market responses.',
 'explanation': 'Quote'}</code></pre>
</div>
</div>
<p>I think in the context we are not passing information like url</p>
</section>
<section id="reply-72" class="level5">
<h5 class="anchored" data-anchor-id="reply-72">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re absolutely right! The context only includes <code>doc_id</code> and <code>text</code>, but the LLM needs access to the URL and other metadata to generate the <code>ref_url</code> field correctly.</p>
<p>Letâ€™s update the context to include all the metadata:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update the function with this richer context?</p>
<div id="8a2d5723" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_single_question(question_row, emb_model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, llm<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> question_row[<span class="st">'question'</span>]</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> fireworks.client.Embedding.create(model<span class="op">=</span>emb_model, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> fireworks.client.ChatCompletion.create(model<span class="op">=</span>llm, messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>        generated_answer <span class="op">=</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> generated_answer</span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"error"</span>: <span class="st">"Failed to parse JSON response"</span>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ba6279c4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb165"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a>evaluate_single_question(qa_df.iloc[<span class="dv">7</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;
ERROR:asyncio:Unclosed client session
client_session: &lt;aiohttp.client.ClientSession object&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': 'False',
 'answer_value': 'False',
 'answer_unit': 'is_blank',
 'ref_id': ['ebert2024'],
 'ref_url': ['https://arxiv.org/pdf/2410.06681'],
 'supporting_materials': 'According to the text, the AI Act restricts the disclosure of energy consumption to authorities and is not accessible to downstream providers or the general public due to confidentiality clauses.',
 'explanation': 'Quote'}</code></pre>
</div>
</div>
<div id="becab6e0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb168"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>qa_df.iloc[<span class="dv">7</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                                                                   q102
question                True or False: The AI Act makes energy consump...
answer                                                              FALSE
answer_value                                                            0
answer_unit                                                      is_blank
ref_id                                                      ['ebert2024']
ref_url                              ['https://arxiv.org/pdf/2410.06681']
supporting_materials    Section 4.3 Transparency: 'Where the Act does ...
explanation                                                         Quote
Name: 7, dtype: object</code></pre>
</div>
</div>
<p>Can we make the function return the context along with the answer?</p>
</section>
<section id="reply-73" class="level5">
<h5 class="anchored" data-anchor-id="reply-73">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! Letâ€™s modify the function to return both the generated answer and the context used:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb170"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_single_question(question_row, emb_model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, llm<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>):</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... existing code ...</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>        generated_answer <span class="op">=</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"answer"</span>: generated_answer, <span class="st">"context"</span>: context}</span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"error"</span>: <span class="st">"Failed to parse JSON response"</span>, <span class="st">"context"</span>: context}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update the function with this change?</p>
<div id="5d5527ac" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb171"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fireworks <span class="im">import</span> LLM</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>llm <span class="op">=</span> LLM(model<span class="op">=</span><span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span>,  deployment_type<span class="op">=</span><span class="st">"auto"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="26b81ad8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb172"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>openai_client <span class="op">=</span> openai.OpenAI(base_url <span class="op">=</span> <span class="st">"https://api.fireworks.ai/inference/v1"</span>, api_key<span class="op">=</span>os.environ[<span class="st">'FIREWORKS_API_KEY'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1adbfb51" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb173"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_single_question(question_row, emb_model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>):</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>    question <span class="op">=</span> question_row[<span class="st">'question'</span>]</span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> openai_client.embeddings.create(model<span class="op">=</span>emb_model, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> llm.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>        generated_answer <span class="op">=</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"answer"</span>: generated_answer, <span class="st">"context"</span>: context}</span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"error"</span>: <span class="st">"Failed to parse JSON response"</span>, <span class="st">"context"</span>: context}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bf88d450" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb174"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a>answer <span class="op">=</span> evaluate_single_question(qa_df.iloc[<span class="dv">7</span>])[<span class="st">'answer'</span>]</span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a>answer</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': 'False',
 'answer_value': 'False',
 'answer_unit': 'is_blank',
 'ref_id': ['ebert2024'],
 'ref_url': ['https://arxiv.org/pdf/2410.06681'],
 'supporting_materials': 'The limited availability of this data significantly reduces transparency and accountability, thereby weakening the potential for public oversight and market responses.',
 'explanation': 'Quote'}</code></pre>
</div>
</div>
<p>Now lets implement the scoring logic</p>
</section>
<section id="reply-74" class="level5">
<h5 class="anchored" data-anchor-id="reply-74">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Now letâ€™s implement the WattBot scoring logic. Based on the competition overview, we need to score three components:</p>
<ol type="1">
<li><strong>answer_value</strong> (75% weight) - exact match or Â±0.1% for numbers</li>
<li><strong>ref_id</strong> (15% weight) - Jaccard overlap</li>
<li><strong>is_NA</strong> (10% weight) - correctly identifying unanswerable questions</li>
</ol>
<p>Should we start with the <code>answer_value</code> scoring function first?</p>
<p>Sure</p>
</section>
<section id="reply-75" class="level5">
<h5 class="anchored" data-anchor-id="reply-75">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s start with the <code>answer_value</code> scoring function. This needs to handle:</p>
<ul>
<li>Numeric values: Â±0.1% relative tolerance</li>
<li>Categorical values: exact match after normalization<br>
</li>
<li>â€œis_blankâ€ for unanswerable questions</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb176"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_answer_value(predicted, expected):</span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add numeric and categorical logic here</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we implement the numeric comparison logic first, or the categorical matching?</p>
<p>Yes</p>
</section>
<section id="reply-76" class="level5">
<h5 class="anchored" data-anchor-id="reply-76">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s implement the numeric comparison logic first:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb177"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_answer_value(predicted, expected):</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Try numeric comparison with Â±0.1% tolerance</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>        pred_num <span class="op">=</span> <span class="bu">float</span>(predicted)</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>        exp_num <span class="op">=</span> <span class="bu">float</span>(expected)</span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>        tolerance <span class="op">=</span> <span class="bu">abs</span>(exp_num <span class="op">*</span> <span class="fl">0.001</span>)  <span class="co"># 0.1% relative tolerance</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> exp_num) <span class="op">&lt;=</span> tolerance <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fall back to categorical matching</span></span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">str</span>(predicted).strip().lower() <span class="op">==</span> <span class="bu">str</span>(expected).strip().lower() <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this function with a few examples?</p>
<p>Can we check differentiate categorical and numerical value without try except?</p>
</section>
<section id="reply-77" class="level5">
<h5 class="anchored" data-anchor-id="reply-77">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! We can use type checking or regex patterns to differentiate them more cleanly. Here are a few approaches:</p>
<ol type="1">
<li><strong>Check if itâ€™s a number first</strong>:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb178"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> re.match(<span class="vs">r'</span><span class="dv">^</span><span class="vs">-</span><span class="op">?</span><span class="dv">\d</span><span class="op">+</span><span class="ch">\.</span><span class="op">?</span><span class="dv">\d</span><span class="op">*</span><span class="dv">$</span><span class="vs">'</span>, <span class="bu">str</span>(expected)):</span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># numeric logic</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># categorical logic</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol start="2" type="1">
<li><strong>Use <code>isinstance()</code> with conversion</strong>:</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb179"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_numeric(value):</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(value)</span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Which approach do you prefer for detecting numeric vs categorical values?</p>
<p>Lets use isinstance</p>
</section>
<section id="reply-78" class="level5">
<h5 class="anchored" data-anchor-id="reply-78">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great choice! Letâ€™s implement the <code>isinstance()</code> approach:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb180"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_numeric(value):</span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(value)</span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_answer_value(predicted, expected):</span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_numeric(expected) <span class="kw">and</span> is_numeric(predicted):</span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Numeric comparison with Â±0.1% tolerance</span></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>        pred_num <span class="op">=</span> <span class="bu">float</span>(predicted)</span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a>        exp_num <span class="op">=</span> <span class="bu">float</span>(expected)</span>
<span id="cb180-16"><a href="#cb180-16" aria-hidden="true" tabindex="-1"></a>        tolerance <span class="op">=</span> <span class="bu">abs</span>(exp_num <span class="op">*</span> <span class="fl">0.001</span>)</span>
<span id="cb180-17"><a href="#cb180-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> exp_num) <span class="op">&lt;=</span> tolerance <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb180-18"><a href="#cb180-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb180-19"><a href="#cb180-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Categorical comparison</span></span>
<span id="cb180-20"><a href="#cb180-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">str</span>(predicted).strip().lower() <span class="op">==</span> <span class="bu">str</span>(expected).strip().lower() <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this with a few examples from your QA data?</p>
<div id="d2239e26" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb181"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> is_numeric(value):</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">float</span>(value)</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_answer_value(predicted, expected):</span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_numeric(expected) <span class="kw">and</span> is_numeric(predicted):</span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Numeric comparison with Â±0.1% tolerance</span></span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a>        pred_num <span class="op">=</span> <span class="bu">float</span>(predicted)</span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a>        exp_num <span class="op">=</span> <span class="bu">float</span>(expected)</span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a>        tolerance <span class="op">=</span> <span class="bu">abs</span>(exp_num <span class="op">*</span> <span class="fl">0.001</span>)</span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> exp_num) <span class="op">&lt;=</span> tolerance <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Categorical comparison</span></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">str</span>(predicted).strip().lower() <span class="op">==</span> <span class="bu">str</span>(expected).strip().lower() <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="dcd757b7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb182"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>score_answer_value(answer[<span class="st">'answer_value'</span>], qa_df.iloc[<span class="dv">7</span>][<span class="st">'answer_value'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<p>From the llm the generated answer has answer_value as False whereas in the dataframe it is 0</p>
</section>
<section id="reply-79" class="level5">
<h5 class="anchored" data-anchor-id="reply-79">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Ah, I see the issue! The LLM generated â€œFalseâ€ but the expected value is <code>0</code>. For boolean values, we need to normalize them before comparison.</p>
<p>Letâ€™s add boolean normalization to handle True/False â†”ï¸Ž 1/0 conversions:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb184"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalize_boolean(value):</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">str</span>(value).lower() <span class="kw">in</span> [<span class="st">'true'</span>, <span class="st">'1'</span>, <span class="dv">1</span>]:</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'1'</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">str</span>(value).lower() <span class="kw">in</span> [<span class="st">'false'</span>, <span class="st">'0'</span>, <span class="dv">0</span>]:</span>
<span id="cb184-5"><a href="#cb184-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">'0'</span></span>
<span id="cb184-6"><a href="#cb184-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">str</span>(value)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update the scoring function to use this normalization?</p>
<p>Instead of modifying the evaluation logic why cant we modify the prompt to answer as 0 and 1 incase of true and false</p>
</section>
<section id="reply-80" class="level5">
<h5 class="anchored" data-anchor-id="reply-80">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Thatâ€™s a much cleaner solution! Youâ€™re right - itâ€™s better to fix the prompt to generate the expected format rather than complicate the evaluation logic.</p>
<p>Letâ€™s update the prompt to specify that boolean answers should be 0/1:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb185"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="st">For answer_value field:</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="st">- Use 0 for False, 1 for True</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact numbers for numeric answers</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact text for categorical answers</span></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a><span class="st">For explanation field, use one of these formats:</span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a><span class="st">- "Quote" - if answer comes directly from text</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a><span class="st">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a><span class="st">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a><span class="st">- "is_blank" - if unanswerable</span></span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a><span class="sc">{{</span></span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer": "natural language answer",</span></span>
<span id="cb185-16"><a href="#cb185-16" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",</span></span>
<span id="cb185-17"><a href="#cb185-17" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb185-18"><a href="#cb185-18" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_id": ["doc_id"],</span></span>
<span id="cb185-19"><a href="#cb185-19" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_url": ["ref_url"],</span></span>
<span id="cb185-20"><a href="#cb185-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb185-21"><a href="#cb185-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb185-22"><a href="#cb185-22" aria-hidden="true" tabindex="-1"></a><span class="sc">}}</span></span>
<span id="cb185-23"><a href="#cb185-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb185-24"><a href="#cb185-24" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{context}</span></span>
<span id="cb185-25"><a href="#cb185-25" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{question}</span></span>
<span id="cb185-26"><a href="#cb185-26" aria-hidden="true" tabindex="-1"></a><span class="st">Response:"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated prompt?</p>
<div id="f9b41d77" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb186"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a><span class="st">For answer_value field:</span></span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a><span class="st">- Use 0 for False, 1 for True</span></span>
<span id="cb186-5"><a href="#cb186-5" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact numbers for numeric answers</span></span>
<span id="cb186-6"><a href="#cb186-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact text for categorical answers</span></span>
<span id="cb186-7"><a href="#cb186-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-8"><a href="#cb186-8" aria-hidden="true" tabindex="-1"></a><span class="st">For explanation field, use one of these formats:</span></span>
<span id="cb186-9"><a href="#cb186-9" aria-hidden="true" tabindex="-1"></a><span class="st">- "Quote" - if answer comes directly from text</span></span>
<span id="cb186-10"><a href="#cb186-10" aria-hidden="true" tabindex="-1"></a><span class="st">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb186-11"><a href="#cb186-11" aria-hidden="true" tabindex="-1"></a><span class="st">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb186-12"><a href="#cb186-12" aria-hidden="true" tabindex="-1"></a><span class="st">- "is_blank" - if unanswerable</span></span>
<span id="cb186-13"><a href="#cb186-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-14"><a href="#cb186-14" aria-hidden="true" tabindex="-1"></a><span class="sc">{{</span></span>
<span id="cb186-15"><a href="#cb186-15" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer": "natural language answer",</span></span>
<span id="cb186-16"><a href="#cb186-16" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",</span></span>
<span id="cb186-17"><a href="#cb186-17" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb186-18"><a href="#cb186-18" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_id": ["doc_id"],</span></span>
<span id="cb186-19"><a href="#cb186-19" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_url": ["ref_url"],</span></span>
<span id="cb186-20"><a href="#cb186-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb186-21"><a href="#cb186-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb186-22"><a href="#cb186-22" aria-hidden="true" tabindex="-1"></a><span class="sc">}}</span></span>
<span id="cb186-23"><a href="#cb186-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb186-24"><a href="#cb186-24" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{context}</span></span>
<span id="cb186-25"><a href="#cb186-25" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{question}</span></span>
<span id="cb186-26"><a href="#cb186-26" aria-hidden="true" tabindex="-1"></a><span class="st">Response:"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6b0b0938" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb187"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a>answer <span class="op">=</span> evaluate_single_question(qa_df.iloc[<span class="dv">7</span>])[<span class="st">'answer'</span>]</span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a>answer</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': 'False',
 'answer_value': '0',
 'answer_unit': 'is_blank',
 'ref_id': ['ebert2024'],
 'ref_url': ['https://arxiv.org/pdf/2410.06681'],
 'supporting_materials': 'According to the text, "Where the Act does mandate the disclosure of energy consumption, this information is restricted to authorities and is not accessible to downstream providers (unless the proposed interpretation from 2) is applied) or the general public, due to confidentiality clauses in Articles 21(3), 53(7), and 78(1) [4]."',
 'explanation': 'Quote'}</code></pre>
</div>
</div>
<div id="b9c77b34" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb189"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a>score_answer_value(answer[<span class="st">'answer_value'</span>], qa_df.iloc[<span class="dv">7</span>][<span class="st">'answer_value'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>1.0</code></pre>
</div>
</div>
<p>Lets continue implementing scoring logic</p>
</section>
<section id="reply-81" class="level5">
<h5 class="anchored" data-anchor-id="reply-81">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! The boolean scoring is now working correctly. Letâ€™s implement the <code>ref_id</code> scoring using Jaccard overlap:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb191"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_ref_id(predicted, expected):</span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to sets for Jaccard calculation</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    pred_set <span class="op">=</span> <span class="bu">set</span>(predicted) <span class="cf">if</span> <span class="bu">isinstance</span>(predicted, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([predicted])</span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>    exp_set <span class="op">=</span> <span class="bu">set</span>(expected) <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([expected])</span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    intersection <span class="op">=</span> <span class="bu">len</span>(pred_set.intersection(exp_set))</span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>    union <span class="op">=</span> <span class="bu">len</span>(pred_set.union(exp_set))</span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this function?</p>
<div id="27dbbc53" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb192"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_ref_id(predicted, expected):</span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to sets for Jaccard calculation</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a>    pred_set <span class="op">=</span> <span class="bu">set</span>(predicted) <span class="cf">if</span> <span class="bu">isinstance</span>(predicted, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([predicted])</span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>    exp_set <span class="op">=</span> <span class="bu">set</span>(expected) <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([expected])</span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>    intersection <span class="op">=</span> <span class="bu">len</span>(pred_set.intersection(exp_set))</span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>    union <span class="op">=</span> <span class="bu">len</span>(pred_set.union(exp_set))</span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb192-12"><a href="#cb192-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="149be231" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb193"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a>score_ref_id(answer[<span class="st">'ref_id'</span>], qa_df.iloc[<span class="dv">7</span>][<span class="st">'ref_id'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>0.0</code></pre>
</div>
</div>
<div id="39ae85bc" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb195"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>answer[<span class="st">'ref_id'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>['ebert2024']</code></pre>
</div>
</div>
<div id="ce73489b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb197"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>qa_df.iloc[<span class="dv">7</span>][<span class="st">'ref_id'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>"['ebert2024']"</code></pre>
</div>
</div>
<p>I think we need to update the score_ref_id as one of them is string and another one is list</p>
</section>
<section id="reply-82" class="level5">
<h5 class="anchored" data-anchor-id="reply-82">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re absolutely right! The expected <code>ref_id</code> is stored as a string representation of a list <code>"['ebert2024']"</code>, but the predicted one is an actual list <code>['ebert2024']</code>.</p>
<p>We need to parse the string first:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb199"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_ref_id(predicted, expected):</span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse string representation if needed</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">str</span>) <span class="kw">and</span> expected.startswith(<span class="st">'['</span>):</span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>        expected <span class="op">=</span> ast.literal_eval(expected)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update the function with this parsing logic?</p>
<p>Yes</p>
</section>
<section id="reply-83" class="level5">
<h5 class="anchored" data-anchor-id="reply-83">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s update the function with the parsing logic:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb200"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_ref_id(predicted, expected):</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse string representation if needed</span></span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">str</span>) <span class="kw">and</span> expected.startswith(<span class="st">'['</span>):</span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>        expected <span class="op">=</span> ast.literal_eval(expected)</span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to sets for Jaccard calculation</span></span>
<span id="cb200-12"><a href="#cb200-12" aria-hidden="true" tabindex="-1"></a>    pred_set <span class="op">=</span> <span class="bu">set</span>(predicted) <span class="cf">if</span> <span class="bu">isinstance</span>(predicted, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([predicted])</span>
<span id="cb200-13"><a href="#cb200-13" aria-hidden="true" tabindex="-1"></a>    exp_set <span class="op">=</span> <span class="bu">set</span>(expected) <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([expected])</span>
<span id="cb200-14"><a href="#cb200-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-15"><a href="#cb200-15" aria-hidden="true" tabindex="-1"></a>    intersection <span class="op">=</span> <span class="bu">len</span>(pred_set.intersection(exp_set))</span>
<span id="cb200-16"><a href="#cb200-16" aria-hidden="true" tabindex="-1"></a>    union <span class="op">=</span> <span class="bu">len</span>(pred_set.union(exp_set))</span>
<span id="cb200-17"><a href="#cb200-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb200-18"><a href="#cb200-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated version?</p>
<div id="932bd749" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb201"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_ref_id(predicted, expected):</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse string representation if needed</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">str</span>) <span class="kw">and</span> expected.startswith(<span class="st">'['</span>):</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>        expected <span class="op">=</span> ast.literal_eval(expected)</span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to sets for Jaccard calculation</span></span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a>    pred_set <span class="op">=</span> <span class="bu">set</span>(predicted) <span class="cf">if</span> <span class="bu">isinstance</span>(predicted, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([predicted])</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>    exp_set <span class="op">=</span> <span class="bu">set</span>(expected) <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([expected])</span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>    intersection <span class="op">=</span> <span class="bu">len</span>(pred_set.intersection(exp_set))</span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>    union <span class="op">=</span> <span class="bu">len</span>(pred_set.union(exp_set))</span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fe9b9e80" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb202"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a>score_ref_id(answer[<span class="st">'ref_id'</span>], qa_df.iloc[<span class="dv">7</span>][<span class="st">'ref_id'</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>1.0</code></pre>
</div>
</div>
<p>Lets continue with the scoring logic</p>
</section>
<section id="reply-84" class="level5">
<h5 class="anchored" data-anchor-id="reply-84">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Now letâ€™s implement the final component - the <code>is_NA</code> scoring (10% weight). This checks if unanswerable questions are correctly identified:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb204"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_is_na(predicted_answer, expected_answer):</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if expected is unanswerable</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>    expected_is_na <span class="op">=</span> expected_answer.get(<span class="st">'answer_value'</span>) <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if predicted is unanswerable  </span></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a>    predicted_is_na <span class="op">=</span> predicted_answer.get(<span class="st">'answer_value'</span>) <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> expected_is_na <span class="op">==</span> predicted_is_na <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this function?</p>
<div id="204f1d4c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb205"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> score_is_na(predicted_answer, expected_answer):</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if expected is unanswerable</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>    expected_is_na <span class="op">=</span> expected_answer[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if predicted is unanswerable  </span></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>    predicted_is_na <span class="op">=</span> predicted_answer[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> expected_is_na <span class="op">==</span> predicted_is_na <span class="cf">else</span> <span class="fl">0.0</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="7d86254d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb206"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>score_is_na(answer, qa_df.iloc[<span class="dv">7</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>1.0</code></pre>
</div>
</div>
<p>It is working fine</p>
</section>
<section id="reply-85" class="level5">
<h5 class="anchored" data-anchor-id="reply-85">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! Now letâ€™s combine all three scoring components into the final WattBot score function:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb208"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_wattbot_score(predicted_answer, expected_row):</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>    answer_score <span class="op">=</span> score_answer_value(predicted_answer[<span class="st">'answer_value'</span>], expected_row[<span class="st">'answer_value'</span>])</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>    ref_score <span class="op">=</span> score_ref_id(predicted_answer[<span class="st">'ref_id'</span>], expected_row[<span class="st">'ref_id'</span>])</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>    na_score <span class="op">=</span> score_is_na(predicted_answer, expected_row)</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.75</span> <span class="op">*</span> answer_score <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> ref_score <span class="op">+</span> <span class="fl">0.10</span> <span class="op">*</span> na_score</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this complete scoring function?</p>
<div id="6abb1a71" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb209"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_wattbot_score(predicted_answer, expected_row):</span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>    answer_score <span class="op">=</span> score_answer_value(predicted_answer[<span class="st">'answer_value'</span>], expected_row[<span class="st">'answer_value'</span>])</span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>    ref_score <span class="op">=</span> score_ref_id(predicted_answer[<span class="st">'ref_id'</span>], expected_row[<span class="st">'ref_id'</span>])</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    na_score <span class="op">=</span> score_is_na(predicted_answer, expected_row)</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.75</span> <span class="op">*</span> answer_score <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> ref_score <span class="op">+</span> <span class="fl">0.10</span> <span class="op">*</span> na_score</span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a>calculate_wattbot_score(answer, qa_df.iloc[<span class="dv">7</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>1.0</code></pre>
</div>
</div>
<p>Now how shall we calculate the score for the whole dataframe?</p>
</section>
<section id="reply-86" class="level5">
<h5 class="anchored" data-anchor-id="reply-86">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Now we can create a function to evaluate the entire dataframe. We need to:</p>
<ol type="1">
<li>Process each question through your RAG pipeline</li>
<li>Calculate the WattBot score for each</li>
<li>Return the average score</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb211"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_full_dataset(qa_dataframe):</span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> qa_dataframe.iterrows():</span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process question and calculate score</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(scores) <span class="op">/</span> <span class="bu">len</span>(scores)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like me to write the complete function, or would you prefer to build it step by step?</p>
<div id="f3b3111e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb212"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>, message<span class="op">=</span><span class="st">".*Unclosed client session.*"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="51cc3325" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb213"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_full_dataset(qa_dataframe):</span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> []</span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> qa_dataframe.iterrows():</span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>        answer <span class="op">=</span> evaluate_single_question(row)[<span class="st">'answer'</span>]</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a>        scores.append(calculate_wattbot_score(answer, row))</span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">sum</span>(scores) <span class="op">/</span> <span class="bu">len</span>(scores)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="175a1509" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb214"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>evaluate_full_dataset(qa_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>0.600609756097561</code></pre>
</div>
</div>
<div id="3e01179d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb216"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a>tst_df <span class="op">=</span> pd.read_csv(data_path<span class="op">/</span><span class="st">'test_Q.csv'</span>)</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>tst_df.head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>q001</td>
<td>What was the average increase in U.S. data cen...</td>
<td>NaN</td>
<td>NaN</td>
<td>percent</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>q002</td>
<td>In 2023, what was the estimated amount of cars...</td>
<td>NaN</td>
<td>NaN</td>
<td>cars</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now I want to generate the answer of tst_df</p>
</section>
<section id="reply-87" class="level5">
<h5 class="anchored" data-anchor-id="reply-87">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Your RAG system achieved a score of ~0.61 on the training data. Now letâ€™s generate answers for the test dataset.</p>
<p>Since the test dataset has NaN values in the answer columns, we need to create a function that fills in all the required fields:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb217"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_test_answers(test_dataframe):</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> test_dataframe.iterrows():</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>        answer <span class="op">=</span> evaluate_single_question(row)[<span class="st">'answer'</span>]</span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add the generated answer to the row</span></span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fill in all required columns</span></span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like me to write the complete function to generate the test answers?</p>
<div id="0218711f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb218"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_test_answers(test_dataframe):</span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> test_dataframe.iterrows():</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>        answer_block <span class="op">=</span> evaluate_single_question(row)</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'answer'</span> <span class="kw">in</span> answer_block:</span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'answer'</span>] <span class="op">=</span> answer[<span class="st">'answer'</span>]</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'answer_value'</span>] <span class="op">=</span> answer[<span class="st">'answer_value'</span>]</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'answer_unit'</span>] <span class="op">=</span> answer[<span class="st">'answer_unit'</span>]</span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'ref_id'</span>] <span class="op">=</span> answer[<span class="st">'ref_id'</span>]</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'ref_url'</span>] <span class="op">=</span> answer[<span class="st">'ref_url'</span>]</span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'supporting_materials'</span>] <span class="op">=</span> answer[<span class="st">'supporting_materials'</span>]</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'explanation'</span>] <span class="op">=</span> answer[<span class="st">'explanation'</span>]</span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_dataframe.copy(deep<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ace70ed3" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb219"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tst_df), <span class="bu">len</span>(qa_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(282, 41)</code></pre>
</div>
</div>
<p>There are too many rows for tst_df, lets parallelize this</p>
</section>
<section id="reply-88" class="level5">
<h5 class="anchored" data-anchor-id="reply-88">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re right! Processing 282 questions sequentially will take a very long time. Letâ€™s parallelize it using <code>fc.parallel</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb221"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_test_answers_parallel(test_dataframe):</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_row(row):</span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a>        answer_block <span class="op">=</span> evaluate_single_question(row)</span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'answer'</span> <span class="kw">in</span> answer_block:</span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>            answer <span class="op">=</span> answer_block[<span class="st">'answer'</span>]</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>                <span class="st">'id'</span>: row[<span class="st">'id'</span>],</span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">'question'</span>: row[<span class="st">'question'</span>],</span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">'answer'</span>: answer[<span class="st">'answer'</span>],</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">'answer_value'</span>: answer[<span class="st">'answer_value'</span>],</span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'answer_unit'</span>: answer[<span class="st">'answer_unit'</span>],</span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ref_id'</span>: answer[<span class="st">'ref_id'</span>],</span>
<span id="cb221-13"><a href="#cb221-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ref_url'</span>: answer[<span class="st">'ref_url'</span>],</span>
<span id="cb221-14"><a href="#cb221-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'supporting_materials'</span>: answer[<span class="st">'supporting_materials'</span>],</span>
<span id="cb221-15"><a href="#cb221-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'explanation'</span>: answer[<span class="st">'explanation'</span>]</span>
<span id="cb221-16"><a href="#cb221-16" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb221-17"><a href="#cb221-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb221-18"><a href="#cb221-18" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> fc.parallel(process_row, test_dataframe.iterrows(), threadpool<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb221-19"><a href="#cb221-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame([r <span class="cf">for</span> r <span class="kw">in</span> results <span class="cf">if</span> r <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we try this parallel approach?</p>
<div id="4dd91a68" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb222"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="bu">next</span>(qa_df.iterrows())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(0,
 id                                                                   q003
 question                What is the name of the benchmark suite presen...
 answer                                            The ML.ENERGY Benchmark
 answer_value                                          ML.ENERGY Benchmark
 answer_unit                                                      is_blank
 ref_id                                                      ['chung2025']
 ref_url                              ['https://arxiv.org/pdf/2505.06371']
 supporting_materials    We present the ML.ENERGY Benchmark, a benchmar...
 explanation                                                         Quote
 Name: 0, dtype: object)</code></pre>
</div>
</div>
<p>iterrows returns both index and value. I think you need to correct the function</p>
</section>
<section id="reply-89" class="level5">
<h5 class="anchored" data-anchor-id="reply-89">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re absolutely right! <code>iterrows()</code> returns <code>(index, row)</code> tuples. Let me fix the function:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb224"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_row(index_row_tuple):</span>
<span id="cb224-2"><a href="#cb224-2" aria-hidden="true" tabindex="-1"></a>    index, row <span class="op">=</span> index_row_tuple</span>
<span id="cb224-3"><a href="#cb224-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># rest of the processing logic</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update the parallel function with this correction?</p>
<div id="41069a44" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb225"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_test_answers_parallel(test_dataframe):</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_row(index_row_tuple):</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a>        idx, row <span class="op">=</span> index_row_tuple</span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>        answer_block <span class="op">=</span> evaluate_single_question(row)</span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'answer'</span> <span class="kw">in</span> answer_block:</span>
<span id="cb225-6"><a href="#cb225-6" aria-hidden="true" tabindex="-1"></a>            answer <span class="op">=</span> answer_block[<span class="st">'answer'</span>]</span>
<span id="cb225-7"><a href="#cb225-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> {</span>
<span id="cb225-8"><a href="#cb225-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">'id'</span>: row[<span class="st">'id'</span>],</span>
<span id="cb225-9"><a href="#cb225-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">'question'</span>: row[<span class="st">'question'</span>],</span>
<span id="cb225-10"><a href="#cb225-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">'answer'</span>: answer[<span class="st">'answer'</span>],</span>
<span id="cb225-11"><a href="#cb225-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'answer_value'</span>: answer[<span class="st">'answer_value'</span>],</span>
<span id="cb225-12"><a href="#cb225-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'answer_unit'</span>: answer[<span class="st">'answer_unit'</span>],</span>
<span id="cb225-13"><a href="#cb225-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ref_id'</span>: answer[<span class="st">'ref_id'</span>],</span>
<span id="cb225-14"><a href="#cb225-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ref_url'</span>: answer[<span class="st">'ref_url'</span>],</span>
<span id="cb225-15"><a href="#cb225-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'supporting_materials'</span>: answer[<span class="st">'supporting_materials'</span>],</span>
<span id="cb225-16"><a href="#cb225-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'explanation'</span>: answer[<span class="st">'explanation'</span>]</span>
<span id="cb225-17"><a href="#cb225-17" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb225-18"><a href="#cb225-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb225-19"><a href="#cb225-19" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> fc.parallel(process_row, test_dataframe.iterrows(), threadpool<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb225-20"><a href="#cb225-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame([r <span class="cf">for</span> r <span class="kw">in</span> results <span class="cf">if</span> r <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bb0df978" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb226"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df <span class="op">=</span> generate_test_answers_parallel(tst_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
</div>
<div id="1a9a7ef5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb228"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>q001</td>
<td>What was the average increase in U.S. data cen...</td>
<td>There is no information about the average incr...</td>
<td>is_blank</td>
<td>is_blank</td>
<td>[patterson2021]</td>
<td>[https://arxiv.org/pdf/2104.10350]</td>
<td>According to a recent paper in Science [Mas20]...</td>
<td>is_blank</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>q002</td>
<td>In 2023, what was the estimated amount of cars...</td>
<td>13,900</td>
<td>13900</td>
<td>cars</td>
<td>[amazon2023]</td>
<td>[https://sustainability.aboutamazon.com/2023-a...</td>
<td>The Amazon Solar Farm Marylandâ€“CPV Backbone wi...</td>
<td>Quote</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="18788625" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb229"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df[tst_ans_df[<span class="st">'answer_value'</span>].isnull()]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
<div id="47722311" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb230"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.to_csv(data_path<span class="op">/</span><span class="st">'tst_ans_df.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How to check for nan values in tst_ans_df?</p>
</section>
<section id="reply-90" class="level5">
<h5 class="anchored" data-anchor-id="reply-90">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>You can check for NaN values in several ways:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb231"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for any NaN values in the entire dataframe</span></span>
<span id="cb231-2"><a href="#cb231-2" aria-hidden="true" tabindex="-1"></a>tst_ans_df.isnull().<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will show you the count of NaN values in each column. Would you like to try this?</p>
<div id="5a8a18db" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb232"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.isnull().<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                      0
question                0
answer                  0
answer_value            0
answer_unit             0
ref_id                  0
ref_url                 0
supporting_materials    0
explanation             0
dtype: int64</code></pre>
</div>
</div>
<p>When I submitting the csv file in the kaggle, I am getting the error Submission contains null values</p>
</section>
<section id="reply-91" class="level5">
<h5 class="anchored" data-anchor-id="reply-91">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The issue might be that some values are being stored as strings like â€œNoneâ€ or empty strings rather than actual NaN values. Letâ€™s check for these:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb234"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for string representations of null values</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a>tst_ans_df[tst_ans_df[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'None'</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Or check for empty strings:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb235"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df[tst_ans_df[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">''</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Which one should we try first to identify the problematic rows?</p>
<div id="e9dd0511" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb236"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tst_ans_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>274</code></pre>
</div>
</div>
<p>Rows are missing</p>
</section>
<section id="reply-92" class="level5">
<h5 class="anchored" data-anchor-id="reply-92">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re right! The test dataframe has 282 rows but your results only have 274 rows. This means 8 questions failed to process and returned <code>None</code>.</p>
<p>Letâ€™s check which questions are missing:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb238"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a>missing_ids <span class="op">=</span> <span class="bu">set</span>(tst_df[<span class="st">'id'</span>]) <span class="op">-</span> <span class="bu">set</span>(tst_ans_df[<span class="st">'id'</span>])</span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Missing </span><span class="sc">{</span><span class="bu">len</span>(missing_ids)<span class="sc">}</span><span class="ss"> questions: </span><span class="sc">{</span>missing_ids<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to identify the problematic questions?</p>
<div id="d9aa070c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb239"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>missing_ids <span class="op">=</span> <span class="bu">set</span>(tst_df[<span class="st">'id'</span>]) <span class="op">-</span> <span class="bu">set</span>(tst_ans_df[<span class="st">'id'</span>])</span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>missing_ids</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'q012', 'q058', 'q087', 'q160', 'q172', 'q220', 'q247', 'q273'}</code></pre>
</div>
</div>
<p>Yes lets run for problematic ones</p>
</section>
<section id="reply-93" class="level5">
<h5 class="anchored" data-anchor-id="reply-93">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s process just those 8 missing questions to see whatâ€™s causing the failures:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb241"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a>missing_rows <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>].isin(missing_ids)]</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span><span class="bu">len</span>(missing_rows)<span class="sc">}</span><span class="ss"> missing questions..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we try processing one of these problematic questions individually first to debug the issue?</p>
<p>Yes</p>
</section>
<section id="reply-94" class="level5">
<h5 class="anchored" data-anchor-id="reply-94">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s try processing one of the problematic questions to see what error occurs:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb242"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>test_row <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>] <span class="op">==</span> <span class="st">'q012'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> evaluate_single_question(test_row)</span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see whatâ€™s causing the failure?</p>
<div id="e58cf80c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb243"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>test_row <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>] <span class="op">==</span> <span class="st">'q012'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> evaluate_single_question(test_row)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>It is giving the error to fail the JSON parsing</p>
</section>
<section id="reply-95" class="level5">
<h5 class="anchored" data-anchor-id="reply-95">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The issue is that the LLM isnâ€™t generating valid JSON. Letâ€™s look at what it actually returned by checking the raw response:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb244"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Let's see what the LLM actually generated</span></span>
<span id="cb244-2"><a href="#cb244-2" aria-hidden="true" tabindex="-1"></a>test_row <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>] <span class="op">==</span> <span class="st">'q012'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb244-3"><a href="#cb244-3" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> test_row[<span class="st">'question'</span>]</span>
<span id="cb244-4"><a href="#cb244-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Question: </span><span class="sc">{</span>question<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we check what question q012 is asking, and then see the raw LLM response to understand why JSON parsing is failing?</p>
<div id="b2145c8f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb245"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>test_row <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>] <span class="op">==</span> <span class="st">'q012'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>question <span class="op">=</span> test_row[<span class="st">'question'</span>]</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>question</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'What is the estimated GPU Power Usage in kWh from SGLang benchmarking on 2400 prompts from ShareGPT at an 8 request/s frequency with a Llama 3.2 1B model?'</code></pre>
</div>
</div>
<p>Lets see the raw LLM response</p>
</section>
<section id="reply-96" class="level5">
<h5 class="anchored" data-anchor-id="reply-96">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s check the raw LLM response to see why JSON parsing is failing:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb247"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the raw response without JSON parsing</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>query_vector <span class="op">=</span> openai_client.embeddings.create(model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> llm.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see the raw response?</p>
<p>Lets create a function</p>
</section>
<section id="reply-97" class="level5">
<h5 class="anchored" data-anchor-id="reply-97">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s create a function to get the raw LLM response for debugging:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb248"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_raw_llm_response(question):</span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> openai_client.embeddings.create(model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> llm.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this function with the problematic question?</p>
<div id="2366f571" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb249"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_raw_llm_response(question):</span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> openai_client.embeddings.create(model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> llm.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>get_raw_llm_response(question)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'Unfortunately, the provided context does not contain the specific information required to answer the question about the estimated GPU Power Usage in kWh from SGLang benchmarking on 2400 prompts from ShareGPT at an 8 request/s frequency with a Llama 3.2 1B model. The question seems to be asking for information that is not present in the given text.\n\nHere is the response in the required JSON format:\n\n```\n{\n  "answer": "The information is not available in the provided context.",\n  "answer_value": "is_blank",\n  "answer_unit": "is_blank",\n  "ref_id": [],\n  "ref_url": [],\n  "supporting_materials": "is_blank",\n  "explanation": "is_blank"\n}\n```'</code></pre>
</div>
</div>
<p>Above is the response</p>
</section>
<section id="reply-98" class="level5">
<h5 class="anchored" data-anchor-id="reply-98">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>I see the issue! The LLM is wrapping the JSON in markdown code blocks with triple backticks, but your parsing function expects raw JSON.</p>
<p>We need to extract the JSON from between the ``<code>json blocks. Should we modify the</code>evaluate_single_question` function to handle this markdown formatting?</p>
<p>Yes</p>
</section>
<section id="reply-99" class="level5">
<h5 class="anchored" data-anchor-id="reply-99">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s modify the parsing to handle markdown code blocks:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb251"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_json_from_response(response_text):</span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"```"</span> <span class="kw">in</span> response_text:</span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract JSON from markdown code blocks</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>        start <span class="op">=</span> response_text.find(<span class="st">"```"</span>) <span class="op">+</span> <span class="dv">3</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> response_text[start:start<span class="op">+</span><span class="dv">4</span>] <span class="op">==</span> <span class="st">"json"</span>:</span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a>            start <span class="op">+=</span> <span class="dv">4</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a>        end <span class="op">=</span> response_text.find(<span class="st">"```"</span>, start)</span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response_text[start:end].strip()</span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response_text.strip()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this extraction function first?</p>
<p>Are you certain that this extraction logic will work for all responses?</p>
</section>
<section id="reply-100" class="level5">
<h5 class="anchored" data-anchor-id="reply-100">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>You raise a good point! The extraction logic might not handle all edge cases. For example:</p>
<ul>
<li>What if there are multiple code blocks?</li>
<li>What if the JSON is malformed inside the blocks?</li>
<li>What if there are no backticks but the JSON is still valid?</li>
</ul>
<p>Would you like to test it with a few different response formats first, or should we make it more robust to handle these edge cases?</p>
<p>I was thinking of making the prompt more strict to return the json even if there is no related context. Can we use prefill?</p>
</section>
<section id="reply-101" class="level5">
<h5 class="anchored" data-anchor-id="reply-101">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Using prefill to force the model to start with JSON structure is much more reliable than trying to parse markdown afterwards.</p>
<p>With prefill, you can start the assistantâ€™s response with <code>{</code> to force it to generate valid JSON directly. This way the model has no choice but to continue with proper JSON format.</p>
<p>Would you like to try modifying the chat completion call to use prefill, or explore how to implement this with the Fireworks API?</p>
<p>Lets explore how the fireworks api implement this?</p>
</section>
<section id="reply-102" class="level5">
<h5 class="anchored" data-anchor-id="reply-102">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>With Fireworks API, you can implement prefill by adding an assistant message that starts the response. Hereâ€™s the approach:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb252"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> [</span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt},</span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: <span class="st">"{"</span>}</span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This forces the model to continue from the opening brace, ensuring JSON format.</p>
<p>Would you like to try this approach, or would you prefer to see how to modify your existing function to use this prefill technique?</p>
<p>Lets try this approach</p>
</section>
<section id="reply-103" class="level5">
<h5 class="anchored" data-anchor-id="reply-103">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s modify your <code>evaluate_single_question</code> function to use prefill:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb253"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> llm.chat.completions.create(</span>
<span id="cb253-2"><a href="#cb253-2" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb253-3"><a href="#cb253-3" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt},</span>
<span id="cb253-4"><a href="#cb253-4" aria-hidden="true" tabindex="-1"></a>        {<span class="st">"role"</span>: <span class="st">"assistant"</span>, <span class="st">"content"</span>: <span class="st">"{"</span>}</span>
<span id="cb253-5"><a href="#cb253-5" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb253-6"><a href="#cb253-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then weâ€™ll need to add the opening brace back to the response before parsing. Should we update your function with this change?</p>
<div id="286a9566" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb254"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb254-2"><a href="#cb254-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-3"><a href="#cb254-3" aria-hidden="true" tabindex="-1"></a><span class="st">For answer_value field:</span></span>
<span id="cb254-4"><a href="#cb254-4" aria-hidden="true" tabindex="-1"></a><span class="st">- Use 0 for False, 1 for True</span></span>
<span id="cb254-5"><a href="#cb254-5" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact numbers for numeric answers</span></span>
<span id="cb254-6"><a href="#cb254-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact text for categorical answers</span></span>
<span id="cb254-7"><a href="#cb254-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-8"><a href="#cb254-8" aria-hidden="true" tabindex="-1"></a><span class="st">For explanation field, use one of these formats:</span></span>
<span id="cb254-9"><a href="#cb254-9" aria-hidden="true" tabindex="-1"></a><span class="st">- "Quote" - if answer comes directly from text</span></span>
<span id="cb254-10"><a href="#cb254-10" aria-hidden="true" tabindex="-1"></a><span class="st">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb254-11"><a href="#cb254-11" aria-hidden="true" tabindex="-1"></a><span class="st">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb254-12"><a href="#cb254-12" aria-hidden="true" tabindex="-1"></a><span class="st">- "is_blank" - if unanswerable</span></span>
<span id="cb254-13"><a href="#cb254-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-14"><a href="#cb254-14" aria-hidden="true" tabindex="-1"></a><span class="sc">{{</span></span>
<span id="cb254-15"><a href="#cb254-15" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer": "natural language answer",</span></span>
<span id="cb254-16"><a href="#cb254-16" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",</span></span>
<span id="cb254-17"><a href="#cb254-17" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb254-18"><a href="#cb254-18" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_id": ["doc_id"],</span></span>
<span id="cb254-19"><a href="#cb254-19" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_url": ["ref_url"],</span></span>
<span id="cb254-20"><a href="#cb254-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb254-21"><a href="#cb254-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb254-22"><a href="#cb254-22" aria-hidden="true" tabindex="-1"></a><span class="sc">}}</span></span>
<span id="cb254-23"><a href="#cb254-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb254-24"><a href="#cb254-24" aria-hidden="true" tabindex="-1"></a><span class="st">Always start with </span><span class="sc">{{</span><span class="st">. </span></span>
<span id="cb254-25"><a href="#cb254-25" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{context}</span></span>
<span id="cb254-26"><a href="#cb254-26" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{question}</span></span>
<span id="cb254-27"><a href="#cb254-27" aria-hidden="true" tabindex="-1"></a><span class="st">Response: """</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fba61214" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb255"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_raw_llm_response(question):</span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a>    query_vector <span class="op">=</span> openai_client.embeddings.create(model<span class="op">=</span><span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>, <span class="bu">input</span><span class="op">=</span>[question]).data[<span class="dv">0</span>].embedding</span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> client.query_points(collection_name<span class="op">=</span>new_collection_name, query<span class="op">=</span>query_vector, limit<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> results.points])</span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>    formatted_prompt <span class="op">=</span> prompt.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>question)</span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> llm.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> response.choices[<span class="dv">0</span>].message.content</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a>get_raw_llm_response(question)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>'{\n  "answer": "is_blank",\n  "answer_value": "is_blank",\n  "answer_unit": "is_blank",\n  "ref_id": ["samsi2024", "chung2025"],\n  "ref_url": ["https://arxiv.org/pdf/2310.03003", "https://arxiv.org/pdf/2505.06371"],\n  "supporting_materials": "None",\n  "explanation": "is_blank"\n}'</code></pre>
</div>
</div>
<p>Lets try with other questions where it failed</p>
</section>
<section id="reply-104" class="level5">
<h5 class="anchored" data-anchor-id="reply-104">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! The prompt modification worked - now itâ€™s returning proper JSON. Letâ€™s test with the other failing questions:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb257"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>test_ids <span class="op">=</span> [<span class="st">'q058'</span>, <span class="st">'q064'</span>, <span class="st">'q087'</span>]</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> test_id <span class="kw">in</span> test_ids:</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>    test_row <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>] <span class="op">==</span> test_id].iloc[<span class="dv">0</span>]</span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> get_raw_llm_response(test_row[<span class="st">'question'</span>])</span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>test_id<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>response[:<span class="dv">100</span>]<span class="sc">}</span><span class="ss">..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test these to see if they now generate valid JSON?</p>
<div id="dd8de65e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb258"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a>test_ids <span class="op">=</span> [<span class="st">'q058'</span>, <span class="st">'q064'</span>, <span class="st">'q087'</span>]</span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> test_id <span class="kw">in</span> test_ids:</span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    test_row <span class="op">=</span> tst_df[tst_df[<span class="st">'id'</span>] <span class="op">==</span> test_id].iloc[<span class="dv">0</span>]</span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>    response <span class="op">=</span> get_raw_llm_response(test_row[<span class="st">'question'</span>])</span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(response[:<span class="dv">100</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
  "answer": "False",
  "answer_value": "0",
  "answer_unit": "is_blank",
  "ref_id": [],
  "ref_ur
{
  "answer": "is_blank",
  "answer_value": "is_blank",
  "answer_unit": "is_blank",
  "ref_id": ["c
{
  "answer": "475 gCO2eq/kWh",
  "answer_value": "475",
  "answer_unit": "gCO2eq/kWh",
  "ref_id": </code></pre>
</div>
</div>
<div id="cebdffb2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb260"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df <span class="op">=</span> generate_test_answers_parallel(tst_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>huggingface/tokenizers: The current process just got forked, after parallelism has already been used. Disabling parallelism to avoid deadlocks...
To disable this warning, you can either:
    - Avoid using `tokenizers` before the fork if possible
    - Explicitly set the environment variable TOKENIZERS_PARALLELISM=(true | false)</code></pre>
</div>
</div>
<div id="3b30b39f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb262"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tst_ans_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>281</code></pre>
</div>
</div>
<div id="31299c87" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb264"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.to_csv(data_path<span class="op">/</span><span class="st">'tst_ans_df.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6eff3262" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb265"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.isnull().<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                      0
question                0
answer                  0
answer_value            0
answer_unit             0
ref_id                  0
ref_url                 0
supporting_materials    0
explanation             0
dtype: int64</code></pre>
</div>
</div>
<div id="a825b2a5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb267"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(tst_df), <span class="bu">len</span>(tst_ans_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(282, 281)</code></pre>
</div>
</div>
<div id="0bb93829" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb269"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a>missing_ids <span class="op">=</span> <span class="bu">set</span>(tst_df[<span class="st">'id'</span>]) <span class="op">-</span> <span class="bu">set</span>(tst_ans_df[<span class="st">'id'</span>])</span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a>missing_ids</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'q066'}</code></pre>
</div>
</div>
<div id="2b3fa14b" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb271"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>q001</td>
<td>What was the average increase in U.S. data cen...</td>
<td>The text does not provide the average increase...</td>
<td>is_blank</td>
<td>is_blank</td>
<td>[patterson2021]</td>
<td>[https://arxiv.org/pdf/2104.10350]</td>
<td>The text does not provide the average increase...</td>
<td>is_blank</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>q002</td>
<td>In 2023, what was the estimated amount of cars...</td>
<td>The Amazon Solar Farm Maryland-CPV Backbone wo...</td>
<td>13900</td>
<td>cars</td>
<td>[amazon2023]</td>
<td>[https://sustainability.aboutamazon.com/2023-a...</td>
<td>The Amazon Solar Farm Marylandâ€“CPV Backbone wi...</td>
<td>Quote</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="a17fc206" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb272"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df[<span class="st">'supporting_materials'</span>] <span class="op">=</span> tst_ans_df[<span class="st">'supporting_materials'</span>].replace([<span class="va">None</span>, <span class="st">''</span>, <span class="st">'None'</span>, <span class="st">'null'</span>], <span class="st">'is_blank'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="414d67bb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb273"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df_local <span class="op">=</span> pd.read_csv(data_path<span class="op">/</span><span class="st">'tst_ans_df.csv'</span>)</span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a>tst_ans_df_local.head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>q001</td>
<td>What was the average increase in U.S. data cen...</td>
<td>The text does not provide the average increase...</td>
<td>is_blank</td>
<td>is_blank</td>
<td>['patterson2021']</td>
<td>['https://arxiv.org/pdf/2104.10350']</td>
<td>The text does not provide the average increase...</td>
<td>is_blank</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>q002</td>
<td>In 2023, what was the estimated amount of cars...</td>
<td>The Amazon Solar Farm Maryland-CPV Backbone wo...</td>
<td>13900</td>
<td>cars</td>
<td>['amazon2023']</td>
<td>['https://sustainability.aboutamazon.com/2023-...</td>
<td>The Amazon Solar Farm Marylandâ€“CPV Backbone wi...</td>
<td>Quote</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>How does tst_ans_df_local has 20 null values whereas tst_ans_df has 0 null values for supporting materials?</p>
</section>
<section id="reply-105" class="level5">
<h5 class="anchored" data-anchor-id="reply-105">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good observation! The difference suggests there might be inconsistency between whatâ€™s in memory (<code>tst_ans_df</code>) versus what was saved to the CSV file (<code>tst_ans_df_local</code>).</p>
<p>This could happen if: 1. The CSV was saved from an earlier version before all issues were fixed 2. Some responses had empty strings <code>""</code> that got converted to NaN when reading the CSV 3. There were processing differences between runs</p>
<p>Should we check what the actual values look like in the rows with null supporting_materials?</p>
<p>yes</p>
</section>
<section id="reply-106" class="level5">
<h5 class="anchored" data-anchor-id="reply-106">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Letâ€™s check the rows with null supporting_materials:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb274"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" aria-hidden="true" tabindex="-1"></a>null_rows <span class="op">=</span> tst_ans_df_local[tst_ans_df_local[<span class="st">'supporting_materials'</span>].isnull()]</span>
<span id="cb274-2"><a href="#cb274-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found </span><span class="sc">{</span><span class="bu">len</span>(null_rows)<span class="sc">}</span><span class="ss"> rows with null supporting_materials"</span>)</span>
<span id="cb274-3"><a href="#cb274-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(null_rows[[<span class="st">'id'</span>, <span class="st">'supporting_materials'</span>]].head())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see which questions have the null values?</p>
<div id="69cdd78d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb275"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>null_rows <span class="op">=</span> tst_ans_df_local[tst_ans_df_local[<span class="st">'supporting_materials'</span>].isnull()]</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a>null_rows[[<span class="st">'id'</span>, <span class="st">'supporting_materials'</span>]].head(n<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>q012</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">17</th>
<td>q020</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="5b22fe58" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb276"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.iloc[<span class="dv">9</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                                                                   q012
question                What is the estimated GPU Power Usage in kWh f...
answer                                                           is_blank
answer_value                                                     is_blank
answer_unit                                                      is_blank
ref_id                                                                 []
ref_url                                                                []
supporting_materials                                             is_blank
explanation                                                      is_blank
Name: 9, dtype: object</code></pre>
</div>
</div>
<div id="96832b1c" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb278"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.iloc[<span class="dv">59</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                                                                   q064
question                What is the estimated cost, in USD, of trainin...
answer                  The estimated cost is not provided in the give...
answer_value                                                     is_blank
answer_unit                                                      is_blank
ref_id                                                      [cottier2024]
ref_url                                [https://arxiv.org/pdf/2405.21015]
supporting_materials                                             is_blank
explanation                                                      is_blank
Name: 59, dtype: object</code></pre>
</div>
</div>
<div id="e33b0de1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb280"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.isnull().<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                      0
question                0
answer                  0
answer_value            0
answer_unit             0
ref_id                  0
ref_url                 0
supporting_materials    0
explanation             0
dtype: int64</code></pre>
</div>
</div>
<p>Can we replace the empty string ones with is_blank?</p>
</section>
<section id="reply-107" class="level5">
<h5 class="anchored" data-anchor-id="reply-107">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! We can replace empty strings with â€œis_blankâ€. Hereâ€™s how:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb282"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df[<span class="st">'supporting_materials'</span>] <span class="op">=</span> tst_ans_df[<span class="st">'supporting_materials'</span>].replace(<span class="st">''</span>, <span class="st">'is_blank'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to fix the empty supporting_materials values?</p>
<div id="6b2cf79d" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb283"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a>null_rows <span class="op">=</span> tst_ans_df[tst_ans_df[<span class="st">'supporting_materials'</span>].isnull()]</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a>null_rows[[<span class="st">'id'</span>, <span class="st">'supporting_materials'</span>]].head()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
</tr>
</thead>
<tbody>
</tbody>
</table>

</div>
</div>
</div>
<div id="424085fd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb284"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df.to_csv(data_path<span class="op">/</span><span class="st">'tst_ans_df.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8eed8f66" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb285"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>tst_ans_df_local <span class="op">=</span> pd.read_csv(data_path<span class="op">/</span><span class="st">'tst_ans_df.csv'</span>)</span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>tst_ans_df_local.isnull().<span class="bu">sum</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>id                      0
question                0
answer                  0
answer_value            0
answer_unit             0
ref_id                  0
ref_url                 0
supporting_materials    0
explanation             0
dtype: int64</code></pre>
</div>
</div>
<p>Can we update the prompt to answer supporting material as is_blank if no reference or exact quote</p>
</section>
<section id="reply-108" class="level5">
<h5 class="anchored" data-anchor-id="reply-108">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! Letâ€™s update the prompt to be more explicit about when to use â€œis_blankâ€ for supporting_materials:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb287"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a><span class="st">For supporting_materials field:</span></span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact verbatim quote if answer comes from text</span></span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a><span class="st">- Use "Table X" or "Figure Y" if from visual elements</span></span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Use "is_blank" if no specific reference or when unanswerable</span></span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a><span class="st">Always start with </span><span class="sc">{{</span><span class="st">. </span></span>
<span id="cb287-9"><a href="#cb287-9" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{context}</span></span>
<span id="cb287-10"><a href="#cb287-10" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{question}</span></span>
<span id="cb287-11"><a href="#cb287-11" aria-hidden="true" tabindex="-1"></a><span class="st">Response: """</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this updated prompt?</p>
<div id="e796e658" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb288"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb288-2"><a href="#cb288-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-3"><a href="#cb288-3" aria-hidden="true" tabindex="-1"></a><span class="st">For answer_value field:</span></span>
<span id="cb288-4"><a href="#cb288-4" aria-hidden="true" tabindex="-1"></a><span class="st">- Use 0 for False, 1 for True</span></span>
<span id="cb288-5"><a href="#cb288-5" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact numbers for numeric answers</span></span>
<span id="cb288-6"><a href="#cb288-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact text for categorical answers</span></span>
<span id="cb288-7"><a href="#cb288-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-8"><a href="#cb288-8" aria-hidden="true" tabindex="-1"></a><span class="st">For supporting_materials field:</span></span>
<span id="cb288-9"><a href="#cb288-9" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact verbatim quote if answer comes from text</span></span>
<span id="cb288-10"><a href="#cb288-10" aria-hidden="true" tabindex="-1"></a><span class="st">- Use "Table X" or "Figure Y" if from visual elements</span></span>
<span id="cb288-11"><a href="#cb288-11" aria-hidden="true" tabindex="-1"></a><span class="st">- Use "is_blank" if no specific reference or when unanswerable</span></span>
<span id="cb288-12"><a href="#cb288-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-13"><a href="#cb288-13" aria-hidden="true" tabindex="-1"></a><span class="st">For explanation field, use one of these formats:</span></span>
<span id="cb288-14"><a href="#cb288-14" aria-hidden="true" tabindex="-1"></a><span class="st">- "Quote" - if answer comes directly from text</span></span>
<span id="cb288-15"><a href="#cb288-15" aria-hidden="true" tabindex="-1"></a><span class="st">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb288-16"><a href="#cb288-16" aria-hidden="true" tabindex="-1"></a><span class="st">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb288-17"><a href="#cb288-17" aria-hidden="true" tabindex="-1"></a><span class="st">- "is_blank" - if unanswerable</span></span>
<span id="cb288-18"><a href="#cb288-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-19"><a href="#cb288-19" aria-hidden="true" tabindex="-1"></a><span class="sc">{{</span></span>
<span id="cb288-20"><a href="#cb288-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer": "natural language answer",</span></span>
<span id="cb288-21"><a href="#cb288-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",</span></span>
<span id="cb288-22"><a href="#cb288-22" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb288-23"><a href="#cb288-23" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_id": ["doc_id"],</span></span>
<span id="cb288-24"><a href="#cb288-24" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_url": ["ref_url"],</span></span>
<span id="cb288-25"><a href="#cb288-25" aria-hidden="true" tabindex="-1"></a><span class="st">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb288-26"><a href="#cb288-26" aria-hidden="true" tabindex="-1"></a><span class="st">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb288-27"><a href="#cb288-27" aria-hidden="true" tabindex="-1"></a><span class="sc">}}</span></span>
<span id="cb288-28"><a href="#cb288-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb288-29"><a href="#cb288-29" aria-hidden="true" tabindex="-1"></a><span class="st">Always start with </span><span class="sc">{{</span><span class="st">. </span></span>
<span id="cb288-30"><a href="#cb288-30" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{context}</span></span>
<span id="cb288-31"><a href="#cb288-31" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{question}</span></span>
<span id="cb288-32"><a href="#cb288-32" aria-hidden="true" tabindex="-1"></a><span class="st">Response: """</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How shall I improve the performance?</p>
</section>
<section id="reply-109" class="level5">
<h5 class="anchored" data-anchor-id="reply-109">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great question! To improve your RAG systemâ€™s performance, here are some key areas to explore:</p>
<ol type="1">
<li><strong>Retrieval quality</strong> - Are you retrieving the most relevant chunks?</li>
<li><strong>Chunk parameters</strong> - Could different chunk sizes or overlap work better?</li>
<li><strong>Number of retrieved chunks</strong> - Currently using 5, might need more or fewer</li>
<li><strong>Prompt engineering</strong> - Add few-shot examples to guide the LLM better</li>
<li><strong>Re-ranking</strong> - Add a re-ranking step after initial retrieval</li>
</ol>
<p>Which area would you like to focus on first? Or would you like to analyze where your current system is struggling most?</p>
<p>How do you measure the retrieval quality?</p>
</section>
<section id="reply-110" class="level5">
<h5 class="anchored" data-anchor-id="reply-110">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good question! To measure retrieval quality, you can check if the correct documents are being retrieved. Here are a few approaches:</p>
<ol type="1">
<li><strong>Recall@k</strong> - For each question in your training set, check if the expected <code>ref_id</code> appears in your top-k retrieved chunks</li>
<li><strong>Mean Reciprocal Rank (MRR)</strong> - Measure the rank position of the first correct document</li>
<li><strong>Manual inspection</strong> - Look at specific cases where your system scored poorly</li>
</ol>
<p>Would you like to calculate Recall@5 on your training set to see how often the correct documents are being retrieved?</p>
<p>How is the Recall@k different from precision@k?</p>
</section>
<section id="reply-111" class="level5">
<h5 class="anchored" data-anchor-id="reply-111">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great question! Hereâ€™s the key difference:</p>
<p><strong>Recall@k</strong> - Of all the correct documents that should be retrieved, how many appear in the top-k results? - Formula: (# of correct docs in top-k) / (total # of correct docs) - Answers: â€œDid I find what I needed?â€</p>
<p><strong>Precision@k</strong> - Of the top-k documents retrieved, how many are actually correct? - Formula: (# of correct docs in top-k) / k - Answers: â€œHow accurate are my results?â€</p>
<p>For your RAG system, if a question has 1 correct document and you retrieve 5 chunks: - If the correct doc appears anywhere in those 5: Recall@5 = 1.0 - If only 1 of the 5 is correct: Precision@5 = 0.2</p>
<p>Which metric would you like to calculate first for your system?</p>
<p>First I want to create a sdk/library for what I have till develop for faster experimentation with the above key ares</p>
</section>
<section id="reply-112" class="level5">
<h5 class="anchored" data-anchor-id="reply-112">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Creating a reusable SDK will make it much easier to experiment with different configurations.</p>
<p>To organize your code into a library, we could structure it with classes like:</p>
<ul>
<li><code>WattBotRAG</code> - Main class to handle retrieval and generation</li>
<li><code>WattBotEvaluator</code> - For scoring and evaluation</li>
<li><code>WattBotConfig</code> - To manage settings (chunk size, model names, etc.)</li>
</ul>
<p>Would you like to start by creating a config class to store all your parameters (like chunk_size, step, embedding model, LLM model, etc.), or would you prefer to begin with the main RAG class?</p>
<p>Lets start with WattBotRAG</p>
</section>
<section id="reply-113" class="level5">
<h5 class="anchored" data-anchor-id="reply-113">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s start designing the <code>WattBotRAG</code> class. Here are the key methods it should have:</p>
<ul>
<li><code>__init__()</code> - Initialize with config (Qdrant client, collection name, models, etc.)</li>
<li><code>retrieve()</code> - Get relevant chunks for a question</li>
<li><a href="https://anubhavmaity.github.io/wattbot/generator.html#generate"><code>generate()</code></a> - Generate answer from retrieved chunks</li>
<li><code>answer_question()</code> - Complete pipeline (retrieve + generate)</li>
</ul>
<p>Should we start by defining the <code>__init__</code> method with the parameters youâ€™ll need, or would you prefer to sketch out all the method signatures first?</p>
<p>I want this library to work with any rag application. Also I want to include the chunkng process and its embedding process</p>
</section>
<section id="reply-114" class="level5">
<h5 class="anchored" data-anchor-id="reply-114">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! Making it generic for any RAG application is a smart design choice. So your library should handle:</p>
<ol type="1">
<li><strong>Document processing</strong> - PDF reading, chunking</li>
<li><strong>Embedding</strong> - Generate and store embeddings in Qdrant</li>
<li><strong>Retrieval</strong> - Query the vector database</li>
<li><strong>Generation</strong> - LLM-based answer generation</li>
<li><strong>Evaluation</strong> - Scoring (optional, for your competition)</li>
</ol>
<p>Should we create separate classes for each component (like <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a>, <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a>, <code>Retriever</code>, <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a>) or keep them as methods within <code>WattBotRAG</code>? Which structure do you prefer?</p>
<p>Lets create separate classes for each component</p>
</section>
<section id="reply-115" class="level5">
<h5 class="anchored" data-anchor-id="reply-115">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great choice! Separate classes will make your library more modular and flexible. Letâ€™s start with the first component.</p>
<p>Which class would you like to build first:</p>
<ol type="1">
<li><strong><a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a></strong> - Handles PDF reading and chunking</li>
<li><strong><a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a></strong> - Creates embeddings and stores in Qdrant</li>
<li><strong><code>Retriever</code></strong> - Queries the vector database</li>
<li><strong><a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a></strong> - LLM-based answer generation</li>
</ol>
<p>Which one should we start with?</p>
<p>DocumentProcessor</p>
</section>
<section id="reply-116" class="level5">
<h5 class="anchored" data-anchor-id="reply-116">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s design the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a> class. It should handle:</p>
<ul>
<li>Reading PDFs</li>
<li>Chunking text with configurable size and overlap</li>
<li>Supporting different chunking strategies (fixed-size, sliding window, etc.)</li>
</ul>
<p>Hereâ€™s a basic structure to start with:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb289"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DocumentProcessor:</span>
<span id="cb289-2"><a href="#cb289-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>):</span>
<span id="cb289-3"><a href="#cb289-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.chunk_size <span class="op">=</span> chunk_size</span>
<span id="cb289-4"><a href="#cb289-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.step <span class="op">=</span> step</span>
<span id="cb289-5"><a href="#cb289-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb289-6"><a href="#cb289-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_pdf(<span class="va">self</span>, pdf_path):</span>
<span id="cb289-7"><a href="#cb289-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Read PDF and return text</span></span>
<span id="cb289-8"><a href="#cb289-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb289-9"><a href="#cb289-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb289-10"><a href="#cb289-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> chunk_text(<span class="va">self</span>, text):</span>
<span id="cb289-11"><a href="#cb289-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Chunk text using sliding window</span></span>
<span id="cb289-12"><a href="#cb289-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb289-13"><a href="#cb289-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb289-14"><a href="#cb289-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_document(<span class="va">self</span>, pdf_path):</span>
<span id="cb289-15"><a href="#cb289-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Complete pipeline: read + chunk</span></span>
<span id="cb289-16"><a href="#cb289-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to implement these methods, or should we discuss the design further first?</p>
<div id="41280cd8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb290"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastcore.<span class="bu">all</span> <span class="im">as</span> fc</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextkit.read <span class="im">as</span> rd</span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DocumentProcessor:</span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>):</span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_pdf(<span class="va">self</span>, pdf_path):</span>
<span id="cb290-9"><a href="#cb290-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rd.read_pdf(pdf_path)</span>
<span id="cb290-10"><a href="#cb290-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb290-11"><a href="#cb290-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> chunk_text(<span class="va">self</span>, text):</span>
<span id="cb290-12"><a href="#cb290-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fc.L(text[i:i<span class="op">+</span><span class="va">self</span>.chunk_size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(text), <span class="va">self</span>.step))</span>
<span id="cb290-13"><a href="#cb290-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb290-14"><a href="#cb290-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_document(<span class="va">self</span>, pdf_path):</span>
<span id="cb290-15"><a href="#cb290-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.chunk_text(<span class="va">self</span>.read_pdf(pdf_path))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How does it look?</p>
</section>
<section id="reply-117" class="level5">
<h5 class="anchored" data-anchor-id="reply-117">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Looks great! Your <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a> is clean and concise. The use of <code>fc.store_attr()</code> is nice for automatically storing the init parameters.</p>
<p>One small consideration: Should <code>process_document</code> also accept a document ID or metadata? This might be useful when you need to track which document each chunk came from later.</p>
<p>Would you like to add metadata handling, or move on to building the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class next?</p>
<p>Lets do that</p>
</section>
<section id="reply-118" class="level5">
<h5 class="anchored" data-anchor-id="reply-118">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Letâ€™s add metadata handling to <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a>. You could modify it to accept and return metadata alongside chunks:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb291"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_document(<span class="va">self</span>, pdf_path, doc_id<span class="op">=</span><span class="va">None</span>, metadata<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb291-2"><a href="#cb291-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> <span class="va">self</span>.read_pdf(pdf_path)</span>
<span id="cb291-3"><a href="#cb291-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="va">self</span>.chunk_text(text)</span>
<span id="cb291-4"><a href="#cb291-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Attach metadata to each chunk?</span></span>
<span id="cb291-5"><a href="#cb291-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> chunks</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should the method return just chunks, or return chunks with their associated metadata (like doc_id, chunk_index, etc.)?</p>
<p>Let it return with associated metadata</p>
</section>
<section id="reply-119" class="level5">
<h5 class="anchored" data-anchor-id="reply-119">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s modify the method to return chunks with their metadata:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb292"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_document(<span class="va">self</span>, pdf_path, doc_id<span class="op">=</span><span class="va">None</span>, metadata<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb292-2"><a href="#cb292-2" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> <span class="va">self</span>.read_pdf(pdf_path)</span>
<span id="cb292-3"><a href="#cb292-3" aria-hidden="true" tabindex="-1"></a>    chunks <span class="op">=</span> <span class="va">self</span>.chunk_text(text)</span>
<span id="cb292-4"><a href="#cb292-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [{<span class="st">'text'</span>: chunk, <span class="st">'chunk_id'</span>: i, <span class="st">'doc_id'</span>: doc_id, <span class="op">**</span>(metadata <span class="kw">or</span> {})} <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Does this structure work for you, or would you prefer a different format for the chunk metadata?</p>
<div id="af0a1828" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb293"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastcore.<span class="bu">all</span> <span class="im">as</span> fc</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextkit.read <span class="im">as</span> rd</span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DocumentProcessor:</span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data_path<span class="op">=</span><span class="st">'watt_bot_data'</span>, chunk_size<span class="op">=</span><span class="dv">1500</span>, step<span class="op">=</span><span class="dv">1400</span>):</span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_pdf(<span class="va">self</span>, doc_id):</span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rd.read_pdf(fc.Path(<span class="va">self</span>.data_path)<span class="op">/</span><span class="ss">f'</span><span class="sc">{</span>doc_id<span class="sc">}</span><span class="ss">.pdf'</span>)</span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> chunk_text(<span class="va">self</span>, text):</span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(text), <span class="va">self</span>.step): <span class="cf">yield</span> text[i:i<span class="op">+</span><span class="va">self</span>.chunk_size]</span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-14"><a href="#cb293-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_document(<span class="va">self</span>, doc_id, metadata<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb293-15"><a href="#cb293-15" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> <span class="va">self</span>.read_pdf(doc_id)</span>
<span id="cb293-16"><a href="#cb293-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fc.L({<span class="st">'text'</span>: chunk, <span class="st">'chunk_id'</span>: i, <span class="st">'doc_id'</span>: doc_id, <span class="op">**</span>(metadata <span class="kw">or</span> {})} <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.chunk_text(text)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Should we not text this class?</p>
</section>
<section id="reply-120" class="level5">
<h5 class="anchored" data-anchor-id="reply-120">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re absolutely right! We should test the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a> class before moving forward. Letâ€™s make sure it works correctly:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb294"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> DocumentProcessor()</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> processor.process_document(data_path<span class="op">/</span><span class="st">'amazon2023.pdf'</span>, doc_id<span class="op">=</span><span class="st">'amazon2023'</span>, metadata<span class="op">=</span>{<span class="st">'type'</span>: <span class="st">'report'</span>})</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of chunks: </span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First chunk: </span><span class="sc">{</span>result[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this test?</p>
<div id="ee50c272" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb295"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" aria-hidden="true" tabindex="-1"></a>metadata <span class="op">=</span> df.iloc[<span class="dv">0</span>]</span>
<span id="cb295-2"><a href="#cb295-2" aria-hidden="true" tabindex="-1"></a>doc_id <span class="op">=</span> metadata[<span class="st">'id'</span>]</span>
<span id="cb295-3"><a href="#cb295-3" aria-hidden="true" tabindex="-1"></a>processor <span class="op">=</span> DocumentProcessor()</span>
<span id="cb295-4"><a href="#cb295-4" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> processor.process_document(doc_id, metadata<span class="op">=</span>{<span class="st">'type'</span>: <span class="st">'report'</span>, <span class="st">'url'</span>: metadata[<span class="st">'url'</span>], <span class="st">'title'</span>: metadata[<span class="st">'title'</span>]})</span>
<span id="cb295-5"><a href="#cb295-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of chunks: </span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb295-6"><a href="#cb295-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"First chunk: </span><span class="sc">{</span>result[<span class="dv">0</span>][<span class="st">'text'</span>][:<span class="dv">200</span>]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of chunks: 322
First chunk: Amazon 
Sustainability 
Report
2023 Contents
Overview
3 Introduction
4 A Letter from Our Chief 
Sustainability Officer&nbsp;
5 How We Work
6 Goals Summary
7 2023 Year in Review &nbsp;
Environment
9 Carbon
24 Ca</code></pre>
</div>
</div>
<p>It is working what is next?</p>
</section>
<section id="reply-121" class="level5">
<h5 class="anchored" data-anchor-id="reply-121">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! The <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#documentprocessor"><code>DocumentProcessor</code></a> is working perfectly. Now letâ€™s move on to the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class. This should handle:</p>
<ul>
<li>Creating embeddings from text chunks</li>
<li>Storing embeddings in Qdrant</li>
<li>Supporting different embedding models</li>
</ul>
<p>Should we start designing the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class structure?</p>
<p>Yes</p>
</section>
<section id="reply-122" class="level5">
<h5 class="anchored" data-anchor-id="reply-122">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Letâ€™s design the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class. It should handle:</p>
<ul>
<li>Initialize with embedding model and Qdrant client</li>
<li>Create embeddings in batches (for efficiency)</li>
<li>Store embeddings with metadata in Qdrant</li>
</ul>
<p>Hereâ€™s a basic structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb297"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Embedder:</span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, model_name, qdrant_client, collection_name, batch_size<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize embedding model and Qdrant client</span></span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_embeddings(<span class="va">self</span>, chunks):</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generate embeddings in batches</span></span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb297-10"><a href="#cb297-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> store_in_qdrant(<span class="va">self</span>, chunks, embeddings):</span>
<span id="cb297-11"><a href="#cb297-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store embeddings with metadata</span></span>
<span id="cb297-12"><a href="#cb297-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Does this structure work for you, or would you like to adjust the methods?</p>
<p>I want this embedder to work with any vector database</p>
</section>
<section id="reply-123" class="level5">
<h5 class="anchored" data-anchor-id="reply-123">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent design decision! To make it work with any vector database, we should separate the embedding creation from storage.</p>
<p>Here are two approaches:</p>
<ol type="1">
<li><strong>Abstract base class</strong> - Create a <code>VectorStore</code> interface that different databases (Qdrant, Pinecone, etc.) can implement</li>
<li><strong>Dependency injection</strong> - Pass a storage function/object to the Embedder</li>
</ol>
<p>Which approach appeals to you more?</p>
<p>2nd option</p>
</section>
<section id="reply-124" class="level5">
<h5 class="anchored" data-anchor-id="reply-124">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! With dependency injection, the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> will just create embeddings, and you pass in a storage handler separately. Hereâ€™s the structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb298"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Embedder:</span>
<span id="cb298-2"><a href="#cb298-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, embedding_client, model_name, batch_size<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb298-3"><a href="#cb298-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.embedding_client <span class="op">=</span> embedding_client</span>
<span id="cb298-4"><a href="#cb298-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model_name <span class="op">=</span> model_name</span>
<span id="cb298-5"><a href="#cb298-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.batch_size <span class="op">=</span> batch_size</span>
<span id="cb298-6"><a href="#cb298-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb298-7"><a href="#cb298-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_embeddings(<span class="va">self</span>, texts):</span>
<span id="cb298-8"><a href="#cb298-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Batch embed the texts</span></span>
<span id="cb298-9"><a href="#cb298-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then youâ€™d have a separate <code>VectorStore</code> class that handles storage. Does this separation make sense for your use case?</p>
<p>Yes</p>
</section>
<section id="reply-125" class="level5">
<h5 class="anchored" data-anchor-id="reply-125">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! So youâ€™ll have:</p>
<ol type="1">
<li><strong><a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a></strong> - Creates embeddings from text</li>
<li><strong><code>VectorStore</code></strong> - Handles storage (you can create <code>QdrantStore</code>, <code>PineconeStore</code>, etc.)</li>
</ol>
<p>Should we implement the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class first, or would you like to design the <code>VectorStore</code> interface first?</p>
<p>Yes lets do the embedder</p>
</section>
<section id="reply-126" class="level5">
<h5 class="anchored" data-anchor-id="reply-126">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s implement the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb299"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Embedder:</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, client, model_name, bs<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gen_emb <span class="op">=</span> <span class="va">self</span>.client.embeddings.create</span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb299-6"><a href="#cb299-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_embeddings(<span class="va">self</span>, texts):</span>
<span id="cb299-7"><a href="#cb299-7" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> fc.L()</span>
<span id="cb299-8"><a href="#cb299-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> fc.chunked(texts, <span class="va">self</span>.bs):</span>
<span id="cb299-9"><a href="#cb299-9" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> <span class="va">self</span>.gen_emb(model<span class="op">=</span><span class="va">self</span>.model_name, <span class="bu">input</span><span class="op">=</span><span class="bu">list</span>(batch)).data</span>
<span id="cb299-10"><a href="#cb299-10" aria-hidden="true" tabindex="-1"></a>            embeddings.extend([data.embedding <span class="cf">for</span> data <span class="kw">in</span> response])</span>
<span id="cb299-11"><a href="#cb299-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This assumes your <code>embedding_client</code> has an OpenAI-compatible interface (like your Fireworks client). Does this work for your needs?</p>
<div id="896c00cf" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb300"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Embedder:</span>
<span id="cb300-2"><a href="#cb300-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, client, model_name, bs<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb300-3"><a href="#cb300-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb300-4"><a href="#cb300-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gen_emb <span class="op">=</span> <span class="va">self</span>.client.embeddings.create</span>
<span id="cb300-5"><a href="#cb300-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb300-6"><a href="#cb300-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_embeddings(<span class="va">self</span>, texts):</span>
<span id="cb300-7"><a href="#cb300-7" aria-hidden="true" tabindex="-1"></a>        embeddings <span class="op">=</span> fc.L()</span>
<span id="cb300-8"><a href="#cb300-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> fc.chunked(texts, <span class="va">self</span>.bs):</span>
<span id="cb300-9"><a href="#cb300-9" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> <span class="va">self</span>.gen_emb(model<span class="op">=</span><span class="va">self</span>.model_name, <span class="bu">input</span><span class="op">=</span><span class="bu">list</span>(batch)).data</span>
<span id="cb300-10"><a href="#cb300-10" aria-hidden="true" tabindex="-1"></a>            embeddings.extend([data.embedding <span class="cf">for</span> data <span class="kw">in</span> response])</span>
<span id="cb300-11"><a href="#cb300-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> embeddings</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6a05a9ed" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb301"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb301-2"><a href="#cb301-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> openai</span>
<span id="cb301-3"><a href="#cb301-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-4"><a href="#cb301-4" aria-hidden="true" tabindex="-1"></a>openai_client <span class="op">=</span> openai.OpenAI(base_url <span class="op">=</span> <span class="st">"https://api.fireworks.ai/inference/v1"</span>, api_key<span class="op">=</span>os.environ[<span class="st">'FIREWORKS_API_KEY'</span>])</span>
<span id="cb301-5"><a href="#cb301-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb301-6"><a href="#cb301-6" aria-hidden="true" tabindex="-1"></a>embdr <span class="op">=</span> Embedder(openai_client, <span class="st">"nomic-ai/nomic-embed-text-v1.5"</span>)</span>
<span id="cb301-7"><a href="#cb301-7" aria-hidden="true" tabindex="-1"></a>embds <span class="op">=</span> embdr.create_embeddings(result.attrgot(<span class="st">'text'</span>))</span>
<span id="cb301-8"><a href="#cb301-8" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(embds), <span class="bu">len</span>(embds[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(322, 768)</code></pre>
</div>
</div>
<p>Lets implement the Vector Store now</p>
</section>
<section id="reply-127" class="level5">
<h5 class="anchored" data-anchor-id="reply-127">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! The <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> is working well. Now letâ€™s design the <code>VectorStore</code> class for Qdrant:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb303"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QdrantStore:</span>
<span id="cb303-2"><a href="#cb303-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, client, collection_name):</span>
<span id="cb303-3"><a href="#cb303-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb303-4"><a href="#cb303-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb303-5"><a href="#cb303-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_collection(<span class="va">self</span>, vector_size, distance<span class="op">=</span><span class="st">"Cosine"</span>):</span>
<span id="cb303-6"><a href="#cb303-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create collection if it doesn't exist</span></span>
<span id="cb303-7"><a href="#cb303-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb303-8"><a href="#cb303-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb303-9"><a href="#cb303-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> upsert(<span class="va">self</span>, points):</span>
<span id="cb303-10"><a href="#cb303-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store points in Qdrant</span></span>
<span id="cb303-11"><a href="#cb303-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb303-12"><a href="#cb303-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb303-13"><a href="#cb303-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search(<span class="va">self</span>, query_vector, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb303-14"><a href="#cb303-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Search for similar vectors</span></span>
<span id="cb303-15"><a href="#cb303-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Does this structure look good to you?</p>
<p>If it is QdrantStore let it accept the host and create the client</p>
</section>
<section id="reply-128" class="level5">
<h5 class="anchored" data-anchor-id="reply-128">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good point! Letâ€™s make <code>QdrantStore</code> handle its own client creation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb304"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QdrantStore:</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, url, api_key, collection_name):</span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> QdrantClient(url<span class="op">=</span>url, api_key<span class="op">=</span>api_key)</span>
<span id="cb304-5"><a href="#cb304-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb304-6"><a href="#cb304-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_collection(<span class="va">self</span>, vector_size, distance<span class="op">=</span>Distance.COSINE):</span>
<span id="cb304-7"><a href="#cb304-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client.collection_exists(<span class="va">self</span>.collection_name):</span>
<span id="cb304-8"><a href="#cb304-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.client.create_collection(</span>
<span id="cb304-9"><a href="#cb304-9" aria-hidden="true" tabindex="-1"></a>                collection_name<span class="op">=</span><span class="va">self</span>.collection_name,</span>
<span id="cb304-10"><a href="#cb304-10" aria-hidden="true" tabindex="-1"></a>                vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span>vector_size, distance<span class="op">=</span>distance)</span>
<span id="cb304-11"><a href="#cb304-11" aria-hidden="true" tabindex="-1"></a>            )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we continue implementing the <code>upsert</code> and <code>search</code> methods?</p>
<p>I think the point of creating the points is to insert them into the database. Do you think there are any other use cases for creating the points?</p>
</section>
<section id="reply-129" class="level5">
<h5 class="anchored" data-anchor-id="reply-129">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>You raise a great point! In most cases, points are created specifically to insert into the database. However, there could be some edge cases:</p>
<ol type="1">
<li><strong>Dry-run/validation</strong> - Creating points to validate format before actual insertion</li>
<li><strong>Batch processing</strong> - Creating points in memory to accumulate before bulk insert</li>
<li><strong>Testing</strong> - Creating mock points without database interaction</li>
</ol>
<p>But youâ€™re right - for most practical purposes, point creation and insertion go together. Should we combine them into a single <code>upsert</code> method that creates and stores points in one step?</p>
<p>Is chaining of methods possible we create points first then we upsert it?</p>
</section>
<section id="reply-130" class="level5">
<h5 class="anchored" data-anchor-id="reply-130">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes, method chaining is definitely possible! You could design it like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb305"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QdrantStore:</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, url, api_key, collection_name):</span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... initialization</span></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> []</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_points(<span class="va">self</span>, chunks, embeddings):</span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> [...]  <span class="co"># create points</span></span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>  <span class="co"># Return self for chaining</span></span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb305-10"><a href="#cb305-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> upsert(<span class="va">self</span>):</span>
<span id="cb305-11"><a href="#cb305-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client.upsert(collection_name<span class="op">=</span><span class="va">self</span>.collection_name, points<span class="op">=</span><span class="va">self</span>.points)</span>
<span id="cb305-12"><a href="#cb305-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then you could use it like: <code>store.create_points(chunks, embeddings).upsert()</code></p>
<p>Does this chaining approach appeal to you?</p>
<p>Yes</p>
</section>
<section id="reply-131" class="level5">
<h5 class="anchored" data-anchor-id="reply-131">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Letâ€™s implement the <code>QdrantStore</code> class with method chaining:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb306"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QdrantStore:</span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, url, api_key, cname):</span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> QdrantClient(url<span class="op">=</span>url, api_key<span class="op">=</span>api_key)</span>
<span id="cb306-5"><a href="#cb306-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> []</span>
<span id="cb306-6"><a href="#cb306-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb306-7"><a href="#cb306-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_collection(<span class="va">self</span>, vs, distance<span class="op">=</span>Distance.COSINE):</span>
<span id="cb306-8"><a href="#cb306-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client.collection_exists(<span class="va">self</span>.cname):</span>
<span id="cb306-9"><a href="#cb306-9" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.client.create_collection(collection_name<span class="op">=</span><span class="va">self</span>.cname, vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span>vs, distance<span class="op">=</span>distance))</span>
<span id="cb306-10"><a href="#cb306-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb306-11"><a href="#cb306-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb306-12"><a href="#cb306-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_points(<span class="va">self</span>, chunks, embeddings, start_id<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb306-13"><a href="#cb306-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> [PointStruct(<span class="bu">id</span><span class="op">=</span>start_id<span class="op">+</span>i, vector<span class="op">=</span>embeddings[i], payload<span class="op">=</span>chunk) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)]</span>
<span id="cb306-14"><a href="#cb306-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb306-15"><a href="#cb306-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb306-16"><a href="#cb306-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> upsert(<span class="va">self</span>):</span>
<span id="cb306-17"><a href="#cb306-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client.upsert(collection_name<span class="op">=</span><span class="va">self</span>.collection_name, points<span class="op">=</span><span class="va">self</span>.points)</span>
<span id="cb306-18"><a href="#cb306-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this implementation?</p>
<p>What about search?</p>
</section>
<section id="reply-132" class="level5">
<h5 class="anchored" data-anchor-id="reply-132">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good catch! We need to add the <code>search</code> method too. Hereâ€™s what it should look like:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb307"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> search(<span class="va">self</span>, query_vector, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> <span class="va">self</span>.client.query_points(collection_name<span class="op">=</span><span class="va">self</span>.cname, query<span class="op">=</span>query_vector, limit<span class="op">=</span>limit)</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results.points</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we add this method and then test the complete <code>QdrantStore</code> class?</p>
<div id="bfbf7bcd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb308"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastcore.<span class="bu">all</span> <span class="im">as</span> fc</span>
<span id="cb308-2"><a href="#cb308-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client <span class="im">import</span> QdrantClient</span>
<span id="cb308-3"><a href="#cb308-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client.models <span class="im">import</span> Distance, VectorParams, PointStruct</span>
<span id="cb308-4"><a href="#cb308-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-5"><a href="#cb308-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> QdrantStore:</span>
<span id="cb308-6"><a href="#cb308-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, url, api_key, cname):</span>
<span id="cb308-7"><a href="#cb308-7" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb308-8"><a href="#cb308-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client <span class="op">=</span> QdrantClient(url<span class="op">=</span>url, api_key<span class="op">=</span>api_key)</span>
<span id="cb308-9"><a href="#cb308-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> []</span>
<span id="cb308-10"><a href="#cb308-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb308-11"><a href="#cb308-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_collection(<span class="va">self</span>, vs, distance<span class="op">=</span>Distance.COSINE):</span>
<span id="cb308-12"><a href="#cb308-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client.collection_exists(<span class="va">self</span>.cname):</span>
<span id="cb308-13"><a href="#cb308-13" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.client.create_collection(collection_name<span class="op">=</span><span class="va">self</span>.cname, vectors_config<span class="op">=</span>VectorParams(size<span class="op">=</span>vs, distance<span class="op">=</span>distance))</span>
<span id="cb308-14"><a href="#cb308-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb308-15"><a href="#cb308-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb308-16"><a href="#cb308-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_points(<span class="va">self</span>, chunks, embeddings, start_id<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb308-17"><a href="#cb308-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> [PointStruct(<span class="bu">id</span><span class="op">=</span>start_id<span class="op">+</span>i, vector<span class="op">=</span>embeddings[i], payload<span class="op">=</span>chunk) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)]</span>
<span id="cb308-18"><a href="#cb308-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb308-19"><a href="#cb308-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb308-20"><a href="#cb308-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> upsert(<span class="va">self</span>):</span>
<span id="cb308-21"><a href="#cb308-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client.upsert(collection_name<span class="op">=</span><span class="va">self</span>.cname, points<span class="op">=</span><span class="va">self</span>.points)</span>
<span id="cb308-22"><a href="#cb308-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span></span>
<span id="cb308-23"><a href="#cb308-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb308-24"><a href="#cb308-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> search(<span class="va">self</span>, query_vector, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb308-25"><a href="#cb308-25" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="va">self</span>.client.query_points(collection_name<span class="op">=</span><span class="va">self</span>.cname, query<span class="op">=</span>query_vector, limit<span class="op">=</span>limit)</span>
<span id="cb308-26"><a href="#cb308-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results.points</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="d3e20143" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb309"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a>QDRANT_HOST <span class="op">=</span> <span class="st">"https://76eb75ff-5ca3-4a68-93d4-ae19a9c169a4.us-west-2-0.aws.cloud.qdrant.io:6333"</span></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>api_key <span class="op">=</span> os.getenv(<span class="st">"QDRANT_API_KEY"</span>)</span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>cname <span class="op">=</span> <span class="st">'wattbot_docs_nomic_768'</span></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>qs <span class="op">=</span> QdrantStore(QDRANT_HOST, api_key, cname).create_collection(<span class="dv">768</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6a8fdb23" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb310"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a>qs.client.get_collections()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>CollectionsResponse(collections=[CollectionDescription(name='wattbot_docs_nomic_768'), CollectionDescription(name='wattbot_documents_768'), CollectionDescription(name='wattbot_documents')])</code></pre>
</div>
</div>
<div id="ee28775e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb312"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(result), <span class="bu">len</span>(embds)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>(322, 322)</code></pre>
</div>
</div>
<div id="051222d8" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb314"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" aria-hidden="true" tabindex="-1"></a>qs <span class="op">=</span> qs.create_points(result, embds)</span>
<span id="cb314-2"><a href="#cb314-2" aria-hidden="true" tabindex="-1"></a>qs <span class="op">=</span> qs.upsert()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>I want to search for some item in the qdrant store. Please provide some text which I can embed and pass to the search</p>
</section>
<section id="reply-133" class="level5">
<h5 class="anchored" data-anchor-id="reply-133">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Sure! You can search for something related to the Amazon sustainability report. Hereâ€™s a sample query:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb315"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a>query_text <span class="op">=</span> <span class="st">"What are Amazon's carbon emissions goals?"</span></span>
<span id="cb315-2"><a href="#cb315-2" aria-hidden="true" tabindex="-1"></a>query_emb <span class="op">=</span> embdr.create_embeddings([query_text])[<span class="dv">0</span>]</span>
<span id="cb315-3"><a href="#cb315-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> qs.search(query_emb, limit<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb315-4"><a href="#cb315-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results[<span class="dv">0</span>].payload[<span class="st">'text'</span>][:<span class="dv">200</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to try this search?</p>
<div id="63234d64" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb316"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" aria-hidden="true" tabindex="-1"></a>query_text <span class="op">=</span> <span class="st">"What are Amazon's carbon emissions goals?"</span></span>
<span id="cb316-2"><a href="#cb316-2" aria-hidden="true" tabindex="-1"></a>query_emb <span class="op">=</span> embdr.create_embeddings([query_text])[<span class="dv">0</span>]</span>
<span id="cb316-3"><a href="#cb316-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> qs.search(query_emb, limit<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb316-4"><a href="#cb316-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results[<span class="dv">0</span>].payload[<span class="st">'text'</span>][:<span class="dv">200</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>cacy for carbon-free energy 
solutions: We engage in partnerships, industry 
initiatives, and public policy advocacy to advance access 
to and the expansion of carbon-free energy for Amazon, 
our cust</code></pre>
</div>
</div>
<div id="cb785460" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb318"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" aria-hidden="true" tabindex="-1"></a>query_text <span class="op">=</span> <span class="st">'5,842 labeled entries'</span></span>
<span id="cb318-2"><a href="#cb318-2" aria-hidden="true" tabindex="-1"></a>query_emb <span class="op">=</span> embdr.create_embeddings([query_text])[<span class="dv">0</span>]</span>
<span id="cb318-3"><a href="#cb318-3" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> qs.search(query_emb, limit<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb318-4"><a href="#cb318-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results[<span class="dv">0</span>].payload[<span class="st">'text'</span>][:<span class="dv">200</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-cyan-fg">Cell</span><span class="ansi-cyan-fg"> </span><span class="ansi-green-fg">In[14]</span><span class="ansi-green-fg">, line 2</span>
<span class="ansi-green-fg">      1</span> query_text = <span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">5,842 labeled entries</span><span class="ansi-yellow-fg">'</span>
<span class="ansi-green-fg">----&gt; </span><span class="ansi-green-fg">2</span> query_emb = <span class="ansi-yellow-bg">embdr</span>.create_embeddings([query_text])[<span class="ansi-green-fg">0</span>]
<span class="ansi-green-fg">      3</span> results = qs.search(query_emb, limit=<span class="ansi-green-fg">3</span>)
<span class="ansi-green-fg">      4</span> <span style="color:rgb(0,135,0)">print</span>(results[<span class="ansi-green-fg">0</span>].payload[<span class="ansi-yellow-fg">'</span><span class="ansi-yellow-fg">text</span><span class="ansi-yellow-fg">'</span>][:<span class="ansi-green-fg">200</span>])

<span class="ansi-red-fg">NameError</span>: name 'embdr' is not defined</pre>
</div>
</div>
</div>
<p>What is next?</p>
</section>
<section id="reply-134" class="level5">
<h5 class="anchored" data-anchor-id="reply-134">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! Your <code>QdrantStore</code> is working perfectly. Now letâ€™s build the <code>Retriever</code> class. This should:</p>
<ul>
<li>Take a query text</li>
<li>Create embeddings for it</li>
<li>Search the vector store</li>
<li>Return relevant chunks</li>
</ul>
<p>Should we design the <code>Retriever</code> class structure?Great! Your <code>QdrantStore</code> is working perfectly. Now letâ€™s move on to the <code>Retriever</code> class. This will tie together the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> and <code>VectorStore</code> to handle the complete retrieval pipeline.</p>
<p>Should we design the <code>Retriever</code> class next, or would you like to build the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a> class for LLM-based answer generation?</p>
<p>Lets build the Retriever class</p>
</section>
<section id="reply-135" class="level5">
<h5 class="anchored" data-anchor-id="reply-135">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s design the <code>Retriever</code> class. It should connect the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> and <code>VectorStore</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb319"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Retriever:</span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, embedder, vector_store):</span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> retrieve(<span class="va">self</span>, query, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb319-6"><a href="#cb319-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Embed query and search</span></span>
<span id="cb319-7"><a href="#cb319-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should the <code>retrieve</code> method return just the raw results from the vector store, or should it format them in a specific way (like extracting just the text and metadata)?</p>
<p>Lets return it in the raw way, we can change it later if we want to</p>
</section>
<section id="reply-136" class="level5">
<h5 class="anchored" data-anchor-id="reply-136">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s implement the <code>Retriever</code> class to return raw results:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb320"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Retriever:</span>
<span id="cb320-2"><a href="#cb320-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, embedder, vector_store):</span>
<span id="cb320-3"><a href="#cb320-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb320-4"><a href="#cb320-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb320-5"><a href="#cb320-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> retrieve(<span class="va">self</span>, query, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb320-6"><a href="#cb320-6" aria-hidden="true" tabindex="-1"></a>        query_emb <span class="op">=</span> <span class="va">self</span>.embedder.create_embeddings([query])[<span class="dv">0</span>]</span>
<span id="cb320-7"><a href="#cb320-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.vector_store.search(query_emb, limit<span class="op">=</span>limit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this <code>Retriever</code> class with your existing embedder and vector store?</p>
<div id="8baa91f0" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb321"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Retriever:</span>
<span id="cb321-2"><a href="#cb321-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, embedder, vector_store):</span>
<span id="cb321-3"><a href="#cb321-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb321-4"><a href="#cb321-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb321-5"><a href="#cb321-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> retrieve(<span class="va">self</span>, query, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb321-6"><a href="#cb321-6" aria-hidden="true" tabindex="-1"></a>        query_emb <span class="op">=</span> <span class="va">self</span>.embedder.create_embeddings([query])[<span class="dv">0</span>]</span>
<span id="cb321-7"><a href="#cb321-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.vector_store.search(query_emb, limit<span class="op">=</span>limit)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3f3030d5" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb322"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" aria-hidden="true" tabindex="-1"></a>retriever <span class="op">=</span> Retriever(embdr, qs)</span>
<span id="cb322-2"><a href="#cb322-2" aria-hidden="true" tabindex="-1"></a>retriever.retrieve(query_text, limit<span class="op">=</span><span class="dv">1</span>)[<span class="dv">0</span>].payload[<span class="st">'text'</span>][:<span class="dv">200</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>' important ways we lower electricity-\nrelated carbon emissions are by improving energy efficiency \nand transitioning to carbon-free energy. To date, we have \nfocused on scaling renewable energy; going'</code></pre>
</div>
</div>
<p>What is next?</p>
</section>
<section id="reply-137" class="level5">
<h5 class="anchored" data-anchor-id="reply-137">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! The <code>Retriever</code> is working perfectly. Now letâ€™s build the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a> class to handle LLM-based answer generation. This should:</p>
<ul>
<li>Take a query and retrieved chunks</li>
<li>Format them into a prompt</li>
<li>Call the LLM to generate an answer</li>
</ul>
<p>Should we design the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a> class structure?</p>
<p>Yes</p>
</section>
<section id="reply-138" class="level5">
<h5 class="anchored" data-anchor-id="reply-138">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s design the <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a> class. It should handle:</p>
<ul>
<li>LLM client initialization</li>
<li>Prompt formatting with context and question</li>
<li>Answer generation with proper JSON parsing</li>
</ul>
<p>Hereâ€™s a basic structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb324"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Generator:</span>
<span id="cb324-2"><a href="#cb324-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, llm_client, prompt_template):</span>
<span id="cb324-3"><a href="#cb324-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize LLM and prompt</span></span>
<span id="cb324-4"><a href="#cb324-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb324-5"><a href="#cb324-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb324-6"><a href="#cb324-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, query, retrieved_chunks):</span>
<span id="cb324-7"><a href="#cb324-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Format prompt and generate answer</span></span>
<span id="cb324-8"><a href="#cb324-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should the <code>prompt_template</code> be passed in at initialization, or should we have a default one that can be overridden?</p>
<p>Lets the pass the prompt template at the initialization</p>
</section>
<section id="reply-139" class="level5">
<h5 class="anchored" data-anchor-id="reply-139">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good choice! That gives maximum flexibility. Hereâ€™s the structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb325"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Generator:</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, llm_client, prompt_template):</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb325-4"><a href="#cb325-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb325-5"><a href="#cb325-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, query, retrieved_chunks):</span>
<span id="cb325-6"><a href="#cb325-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Format context from chunks</span></span>
<span id="cb325-7"><a href="#cb325-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create prompt</span></span>
<span id="cb325-8"><a href="#cb325-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Call LLM</span></span>
<span id="cb325-9"><a href="#cb325-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parse JSON response</span></span>
<span id="cb325-10"><a href="#cb325-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>How should the <a href="https://anubhavmaity.github.io/wattbot/generator.html#generate"><code>generate</code></a> method format the context from retrieved chunks? Should it extract specific fields like <code>text</code>, <code>doc_id</code>, <code>url</code>?</p>
<p>We can create the context context = â€œâ€.join([fâ€Doc ID: {chunk.payload[â€˜doc_idâ€™]}: {chunk.payload[â€˜urlâ€™]}: {chunk.payload[â€˜titleâ€™]}: {chunk.payload[â€˜textâ€™]}â€ for chunk in results.points])</p>
</section>
<section id="reply-140" class="level5">
<h5 class="anchored" data-anchor-id="reply-140">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! So the <a href="https://anubhavmaity.github.io/wattbot/generator.html#generate"><code>generate</code></a> method will format the context like that. Hereâ€™s the implementation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb326"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Generator:</span>
<span id="cb326-2"><a href="#cb326-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, llm_client, prompt_template):</span>
<span id="cb326-3"><a href="#cb326-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb326-4"><a href="#cb326-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb326-5"><a href="#cb326-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, query, retrieved_chunks):</span>
<span id="cb326-6"><a href="#cb326-6" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb326-7"><a href="#cb326-7" aria-hidden="true" tabindex="-1"></a>        formatted_prompt <span class="op">=</span> <span class="va">self</span>.prompt_template.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>query)</span>
<span id="cb326-8"><a href="#cb326-8" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.llm_client.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb326-9"><a href="#cb326-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we test this <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#generator"><code>Generator</code></a> class with your existing LLM client and prompt?</p>
<p>Can we have a create context and formating the prompt as separate function?</p>
</section>
<section id="reply-141" class="level5">
<h5 class="anchored" data-anchor-id="reply-141">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Separating concerns makes the code more modular and testable. Hereâ€™s the updated structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb327"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Generator:</span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, llm_client, prompt_template):</span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb327-4"><a href="#cb327-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb327-5"><a href="#cb327-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_context(<span class="va">self</span>, retrieved_chunks):</span>
<span id="cb327-6"><a href="#cb327-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb327-7"><a href="#cb327-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb327-8"><a href="#cb327-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_prompt(<span class="va">self</span>, query, context):</span>
<span id="cb327-9"><a href="#cb327-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.prompt_template.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>query)</span>
<span id="cb327-10"><a href="#cb327-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb327-11"><a href="#cb327-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, query, retrieved_chunks):</span>
<span id="cb327-12"><a href="#cb327-12" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="va">self</span>.create_context(retrieved_chunks)</span>
<span id="cb327-13"><a href="#cb327-13" aria-hidden="true" tabindex="-1"></a>        formatted_prompt <span class="op">=</span> <span class="va">self</span>.format_prompt(query, context)</span>
<span id="cb327-14"><a href="#cb327-14" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.llm_client.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb327-15"><a href="#cb327-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Does this separation work for you?</p>
<div id="09e7adcb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb328"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Generator:</span>
<span id="cb328-2"><a href="#cb328-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, llm_client, prompt_template):</span>
<span id="cb328-3"><a href="#cb328-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb328-4"><a href="#cb328-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb328-5"><a href="#cb328-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> create_context(<span class="va">self</span>, retrieved_chunks):</span>
<span id="cb328-6"><a href="#cb328-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"</span><span class="ch">\n\n</span><span class="st">"</span>.join([<span class="ss">f"Doc ID: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'doc_id'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">URL: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'url'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Title: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'title'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">Text: </span><span class="sc">{</span>chunk<span class="sc">.</span>payload[<span class="st">'text'</span>]<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> chunk <span class="kw">in</span> retrieved_chunks])</span>
<span id="cb328-7"><a href="#cb328-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb328-8"><a href="#cb328-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> format_prompt(<span class="va">self</span>, query, context):</span>
<span id="cb328-9"><a href="#cb328-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.prompt_template.<span class="bu">format</span>(context<span class="op">=</span>context, question<span class="op">=</span>query)</span>
<span id="cb328-10"><a href="#cb328-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb328-11"><a href="#cb328-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate(<span class="va">self</span>, query, retrieved_chunks):</span>
<span id="cb328-12"><a href="#cb328-12" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="va">self</span>.create_context(retrieved_chunks)</span>
<span id="cb328-13"><a href="#cb328-13" aria-hidden="true" tabindex="-1"></a>        formatted_prompt <span class="op">=</span> <span class="va">self</span>.format_prompt(query, context)</span>
<span id="cb328-14"><a href="#cb328-14" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.llm_client.chat.completions.create(messages<span class="op">=</span>[{<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: formatted_prompt}])</span>
<span id="cb328-15"><a href="#cb328-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6a519758" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb329"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>query_text <span class="op">=</span> <span class="st">'What is the name of the benchmark suite presented in a recent paper for measuring inference energy consumption?'</span></span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a>retrieved_chunks <span class="op">=</span> Retriever(embdr, qs).retrieve(query_text, limit<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a>generator <span class="op">=</span> Generator(llm, prompt)</span>
<span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a>generator.generate(query_text, retrieved_chunks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': 'Inferentia2',
 'answer_value': 'Inferentia2',
 'answer_unit': 'is_blank',
 'ref_id': ['amazon2023'],
 'ref_url': ['https://sustainability.aboutamazon.com/2023-amazon-sustainability-report.pdf'],
 'supporting_materials': 'is_blank',
 'explanation': 'is_blank'}</code></pre>
</div>
</div>
<p>Okay it is working fine. Now what is next?</p>
</section>
<section id="reply-142" class="level5">
<h5 class="anchored" data-anchor-id="reply-142">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Excellent! Now you have all the core components working. Letâ€™s tie them together with a main <a href="https://anubhavmaity.github.io/wattbot/generator.html#rag"><code>RAG</code></a> class that orchestrates everything:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb331"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RAG:</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, retriever, generator):</span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> answer_question(<span class="va">self</span>, query, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb331-6"><a href="#cb331-6" aria-hidden="true" tabindex="-1"></a>        retrieved_chunks <span class="op">=</span> <span class="va">self</span>.retriever.retrieve(query, limit<span class="op">=</span>limit)</span>
<span id="cb331-7"><a href="#cb331-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.generator.generate(query, retrieved_chunks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we create this main <a href="https://anubhavmaity.github.io/wattbot/generator.html#rag"><code>RAG</code></a> class to complete your pipeline?</p>
<div id="d03b56f7" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb332"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> RAG:</span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, retriever, generator):</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> answer_question(<span class="va">self</span>, query, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a>        retrieved_chunks <span class="op">=</span> <span class="va">self</span>.retriever.retrieve(query, limit<span class="op">=</span>limit)</span>
<span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.generator.generate(query, retrieved_chunks)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="60ca4666" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb333"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a>rag <span class="op">=</span> RAG(retriever, generator)</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a>rag.answer_question(query_text)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': 'Inferentia2',
 'answer_value': 'Inferentia2',
 'answer_unit': 'is_blank',
 'ref_id': ['amazon2023'],
 'ref_url': ['https://sustainability.aboutamazon.com/2023-amazon-sustainability-report.pdf'],
 'supporting_materials': 'Inferentia2 is up to 50% more energy-efficient and can reduce costs by up to 40% against comparable Amazon Elastic Compute Cloud (EC2) instances.',
 'explanation': 'Quote'}</code></pre>
</div>
</div>
<p>I also want an evaluator class</p>
</section>
<section id="reply-143" class="level5">
<h5 class="anchored" data-anchor-id="reply-143">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! The <code>Evaluator</code> class should handle the WattBot scoring logic. It should include:</p>
<ul>
<li><a href="https://anubhavmaity.github.io/wattbot/evaluate.html#score_answer_value"><code>score_answer_value()</code></a> - Score with Â±0.1% tolerance</li>
<li><a href="https://anubhavmaity.github.io/wattbot/evaluate.html#score_ref_id"><code>score_ref_id()</code></a> - Jaccard overlap scoring</li>
<li><a href="https://anubhavmaity.github.io/wattbot/evaluate.html#score_is_na"><code>score_is_na()</code></a> - Check if unanswerable questions are handled correctly</li>
<li><a href="https://anubhavmaity.github.io/wattbot/evaluate.html#calculate_wattbot_score"><code>calculate_wattbot_score()</code></a> - Combine all scores with weights</li>
</ul>
<p>Should we implement this class with the scoring functions you already created?</p>
<p>Also it should idenity the n samples which has the lowest scores. This will be for debbuging purpose</p>
</section>
<section id="reply-144" class="level5">
<h5 class="anchored" data-anchor-id="reply-144">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great addition! So the <code>Evaluator</code> class should also:</p>
<ul>
<li>Store individual question scores</li>
<li>Identify the N lowest-scoring samples for debugging</li>
</ul>
<p>Should we add a method like <code>get_worst_predictions(n=5)</code> that returns the questions with the lowest scores along with their predicted and expected answers?</p>
<p>Also if possible the retreived chunks and context</p>
</section>
<section id="reply-145" class="level5">
<h5 class="anchored" data-anchor-id="reply-145">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! So for debugging, the <code>Evaluator</code> should store:</p>
<ul>
<li>Individual scores per question</li>
<li>Predicted vs expected answers</li>
<li>Retrieved chunks</li>
<li>Generated context</li>
</ul>
<p>Should we design the <code>Evaluator</code> to store all this information during evaluation, then provide a <code>get_worst_predictions(n=5)</code> method that returns a detailed breakdown of the lowest-scoring questions?</p>
<p>Yes</p>
</section>
<section id="reply-146" class="level5">
<h5 class="anchored" data-anchor-id="reply-146">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s design the <code>Evaluator</code> class structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb335"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Evaluator:</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> []  <span class="co"># Store all evaluation results</span></span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_dataset(<span class="va">self</span>, rag, qa_dataframe):</span>
<span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Run RAG on each question and store detailed results</span></span>
<span id="cb335-7"><a href="#cb335-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb335-8"><a href="#cb335-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb335-9"><a href="#cb335-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_worst_predictions(<span class="va">self</span>, n<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb335-10"><a href="#cb335-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return n lowest-scoring samples with full details</span></span>
<span id="cb335-11"><a href="#cb335-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we start implementing the <code>evaluate_dataset</code> method first, or would you like to sketch out what information should be stored in <code>self.results</code>?</p>
<p>Lets start implementing the evaluate_dataset first</p>
</section>
<section id="reply-147" class="level5">
<h5 class="anchored" data-anchor-id="reply-147">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! For the <code>evaluate_dataset</code> method, we need to decide what information to store for each question. Should each result include:</p>
<ul>
<li>Question ID and text</li>
<li>Predicted answer (full JSON)</li>
<li>Expected answer</li>
<li>Individual component scores (answer_value, ref_id, is_na)</li>
<li>Total WattBot score</li>
<li>Retrieved chunks</li>
<li>Generated context</li>
</ul>
<p>Is this the right set of information, or would you like to add/remove anything?</p>
<p>This is the right choice, lets store it as SimpleNamespace</p>
</section>
<section id="reply-148" class="level5">
<h5 class="anchored" data-anchor-id="reply-148">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect choice! Using <code>SimpleNamespace</code> makes it easy to access the stored data with dot notation. Hereâ€™s the implementation:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb336"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> types <span class="im">import</span> SimpleNamespace</span>
<span id="cb336-2"><a href="#cb336-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb336-3"><a href="#cb336-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_dataset(<span class="va">self</span>, rag, qa_dataframe):</span>
<span id="cb336-4"><a href="#cb336-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> qa_dataframe.iterrows():</span>
<span id="cb336-5"><a href="#cb336-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get retrieved chunks and answer</span></span>
<span id="cb336-6"><a href="#cb336-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate scores</span></span>
<span id="cb336-7"><a href="#cb336-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Store as SimpleNamespace</span></span>
<span id="cb336-8"><a href="#cb336-8" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> SimpleNamespace(</span>
<span id="cb336-9"><a href="#cb336-9" aria-hidden="true" tabindex="-1"></a>            question_id<span class="op">=</span>row[<span class="st">'id'</span>],</span>
<span id="cb336-10"><a href="#cb336-10" aria-hidden="true" tabindex="-1"></a>            question<span class="op">=</span>row[<span class="st">'question'</span>],</span>
<span id="cb336-11"><a href="#cb336-11" aria-hidden="true" tabindex="-1"></a>            predicted<span class="op">=</span>predicted_answer,</span>
<span id="cb336-12"><a href="#cb336-12" aria-hidden="true" tabindex="-1"></a>            expected<span class="op">=</span>row,</span>
<span id="cb336-13"><a href="#cb336-13" aria-hidden="true" tabindex="-1"></a>            scores<span class="op">=</span>{<span class="st">'answer_value'</span>: av_score, <span class="st">'ref_id'</span>: ref_score, <span class="st">'is_na'</span>: na_score, <span class="st">'total'</span>: total_score},</span>
<span id="cb336-14"><a href="#cb336-14" aria-hidden="true" tabindex="-1"></a>            retrieved_chunks<span class="op">=</span>chunks,</span>
<span id="cb336-15"><a href="#cb336-15" aria-hidden="true" tabindex="-1"></a>            context<span class="op">=</span>context</span>
<span id="cb336-16"><a href="#cb336-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb336-17"><a href="#cb336-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results.append(result)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we implement the complete method with the scoring logic?</p>
<p>Instead of the iterrows we can use the lambda with pandas right?</p>
</section>
<section id="reply-149" class="level5">
<h5 class="anchored" data-anchor-id="reply-149">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! You can use <code>apply()</code> with a lambda function, which is often more efficient than <code>iterrows()</code>. Hereâ€™s the approach:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb337"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_dataset(<span class="va">self</span>, rag, qa_dataframe):</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_row(row):</span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluation logic here</span></span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.results <span class="op">=</span> qa_dataframe.<span class="bu">apply</span>(evaluate_row, axis<span class="op">=</span><span class="dv">1</span>).tolist()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to implement the <code>evaluate_row</code> function with all the scoring logic?</p>
<p>Before evaluating I want to store the prompts in braintrust</p>
</section>
<section id="reply-150" class="level5">
<h5 class="anchored" data-anchor-id="reply-150">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Braintrust is excellent for tracking prompts and experiments. To integrate it, youâ€™ll need to:</p>
<ol type="1">
<li>Install braintrust: <code>pip install braintrust</code></li>
<li>Initialize a braintrust logger in your <code>Evaluator</code></li>
<li>Log prompts, responses, and scores during evaluation</li>
</ol>
<p>Do you already have a Braintrust account set up, or would you like help getting started with that first?</p>
<p>How shall I create a prompt template and do versioning in braintrust?</p>
</section>
<section id="reply-151" class="level5">
<h5 class="anchored" data-anchor-id="reply-151">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>To create and version prompts in Braintrust, youâ€™ll use their Prompts feature:</p>
<ol type="1">
<li><strong>Create a prompt</strong> - Define it in the Braintrust UI or via their SDK</li>
<li><strong>Version automatically</strong> - Braintrust tracks versions when you update prompts</li>
<li><strong>Pull in code</strong> - Reference the prompt by name to use the latest or specific version</li>
</ol>
<p>You can create prompts using:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb338"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> braintrust <span class="im">import</span> load_prompt</span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> load_prompt(<span class="st">"my-prompt-name"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to create your WattBot prompt in Braintrustâ€™s UI first, or would you prefer to do it programmatically via their SDK?</p>
<p>How shall I create a prompt using SDK?</p>
</section>
<section id="reply-152" class="level5">
<h5 class="anchored" data-anchor-id="reply-152">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>To create a prompt using the Braintrust SDK, youâ€™ll use their API to define and store your prompt:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb339"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> braintrust</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb339-3"><a href="#cb339-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create or update a prompt</span></span>
<span id="cb339-4"><a href="#cb339-4" aria-hidden="true" tabindex="-1"></a>braintrust.update_prompt(</span>
<span id="cb339-5"><a href="#cb339-5" aria-hidden="true" tabindex="-1"></a>    project<span class="op">=</span><span class="st">"your-project-name"</span>,</span>
<span id="cb339-6"><a href="#cb339-6" aria-hidden="true" tabindex="-1"></a>    slug<span class="op">=</span><span class="st">"wattbot-prompt"</span>,</span>
<span id="cb339-7"><a href="#cb339-7" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span>{</span>
<span id="cb339-8"><a href="#cb339-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"prompt"</span>: your_prompt_template,</span>
<span id="cb339-9"><a href="#cb339-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model"</span>: <span class="st">"llama-v3p1-70b-instruct"</span></span>
<span id="cb339-10"><a href="#cb339-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb339-11"><a href="#cb339-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Do you have a Braintrust project already created, or would you like to set that up first?</p>
<p>Why the model name is necessary?</p>
</section>
<section id="reply-153" class="level5">
<h5 class="anchored" data-anchor-id="reply-153">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good question! The model name in Braintrust prompts is optional - itâ€™s metadata to help you track which model a prompt was designed for. It doesnâ€™t actually control which model runs the prompt.</p>
<p>You can omit it if you prefer:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb340"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" aria-hidden="true" tabindex="-1"></a>braintrust.update_prompt(</span>
<span id="cb340-2"><a href="#cb340-2" aria-hidden="true" tabindex="-1"></a>    project<span class="op">=</span><span class="st">"your-project-name"</span>,</span>
<span id="cb340-3"><a href="#cb340-3" aria-hidden="true" tabindex="-1"></a>    slug<span class="op">=</span><span class="st">"wattbot-prompt"</span>,</span>
<span id="cb340-4"><a href="#cb340-4" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span>{<span class="st">"prompt"</span>: your_prompt_template}</span>
<span id="cb340-5"><a href="#cb340-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to try creating your WattBot prompt in Braintrust now?</p>
<div id="372340b1" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb341"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a>prompt_template <span class="op">=</span> <span class="st">"""You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:</span></span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a><span class="st">For answer_value field:</span></span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a><span class="st">- Use 0 for False, 1 for True</span></span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact numbers for numeric answers</span></span>
<span id="cb341-6"><a href="#cb341-6" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact text for categorical answers</span></span>
<span id="cb341-7"><a href="#cb341-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-8"><a href="#cb341-8" aria-hidden="true" tabindex="-1"></a><span class="st">For supporting_materials field:</span></span>
<span id="cb341-9"><a href="#cb341-9" aria-hidden="true" tabindex="-1"></a><span class="st">- Use exact verbatim quote if answer comes from text</span></span>
<span id="cb341-10"><a href="#cb341-10" aria-hidden="true" tabindex="-1"></a><span class="st">- Use "Table X" or "Figure Y" if from visual elements</span></span>
<span id="cb341-11"><a href="#cb341-11" aria-hidden="true" tabindex="-1"></a><span class="st">- Use "is_blank" if no specific reference or when unanswerable</span></span>
<span id="cb341-12"><a href="#cb341-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-13"><a href="#cb341-13" aria-hidden="true" tabindex="-1"></a><span class="st">For explanation field, use one of these formats:</span></span>
<span id="cb341-14"><a href="#cb341-14" aria-hidden="true" tabindex="-1"></a><span class="st">- "Quote" - if answer comes directly from text</span></span>
<span id="cb341-15"><a href="#cb341-15" aria-hidden="true" tabindex="-1"></a><span class="st">- "Table" or "Figure" - if from visual elements  </span></span>
<span id="cb341-16"><a href="#cb341-16" aria-hidden="true" tabindex="-1"></a><span class="st">- "Math: [calculation]" - if requires computation</span></span>
<span id="cb341-17"><a href="#cb341-17" aria-hidden="true" tabindex="-1"></a><span class="st">- "is_blank" - if unanswerable</span></span>
<span id="cb341-18"><a href="#cb341-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-19"><a href="#cb341-19" aria-hidden="true" tabindex="-1"></a><span class="st">{</span></span>
<span id="cb341-20"><a href="#cb341-20" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer": "natural language answer",</span></span>
<span id="cb341-21"><a href="#cb341-21" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",</span></span>
<span id="cb341-22"><a href="#cb341-22" aria-hidden="true" tabindex="-1"></a><span class="st">  "answer_unit": "unit or 'is_blank'",</span></span>
<span id="cb341-23"><a href="#cb341-23" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_id": ["doc_id"],</span></span>
<span id="cb341-24"><a href="#cb341-24" aria-hidden="true" tabindex="-1"></a><span class="st">  "ref_url": ["ref_url"],</span></span>
<span id="cb341-25"><a href="#cb341-25" aria-hidden="true" tabindex="-1"></a><span class="st">  "supporting_materials": "exact quote or reference",</span></span>
<span id="cb341-26"><a href="#cb341-26" aria-hidden="true" tabindex="-1"></a><span class="st">  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"</span></span>
<span id="cb341-27"><a href="#cb341-27" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb341-28"><a href="#cb341-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb341-29"><a href="#cb341-29" aria-hidden="true" tabindex="-1"></a><span class="st">Always start with {. </span></span>
<span id="cb341-30"><a href="#cb341-30" aria-hidden="true" tabindex="-1"></a><span class="st">Context: </span><span class="sc">{{</span><span class="st">context</span><span class="sc">}}</span></span>
<span id="cb341-31"><a href="#cb341-31" aria-hidden="true" tabindex="-1"></a><span class="st">Question: </span><span class="sc">{{</span><span class="st">question</span><span class="sc">}}</span></span>
<span id="cb341-32"><a href="#cb341-32" aria-hidden="true" tabindex="-1"></a><span class="st">Response:</span></span>
<span id="cb341-33"><a href="#cb341-33" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Can the above prompt be coverted to mustache templating syntax?</p>
</section>
<section id="reply-154" class="level5">
<h5 class="anchored" data-anchor-id="reply-154">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! Mustache uses <code>{variable}</code> for variables, but since your prompt already has <code>{{</code> for JSON examples, youâ€™ll need to escape them or use different delimiters.</p>
<p>In Mustache, you can: 1. Use <code>{{variable}}</code> (triple braces) for unescaped content 2. Escape literal braces as <code>\{{</code> or by wrapping in verbatim sections</p>
<p>For your prompt, youâ€™d replace <code>{context}</code> and <code>{question}</code> with <code>{context}</code> and <code>{question}</code>, and escape the JSON example braces.</p>
<p>Would you like me to show you the converted Mustache version?</p>
<p>Yes</p>
</section>
<section id="reply-155" class="level5">
<h5 class="anchored" data-anchor-id="reply-155">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Hereâ€™s your prompt converted to Mustache syntax:</p>
<pre><code>You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:

For answer_value field:
- Use 0 for False, 1 for True
- Use exact numbers for numeric answers
- Use exact text for categorical answers

For supporting_materials field:
- Use exact verbatim quote if answer comes from text
- Use "Table X" or "Figure Y" if from visual elements
- Use "is_blank" if no specific reference or when unanswerable

For explanation field, use one of these formats:
- "Quote" - if answer comes directly from text
- "Table" or "Figure" - if from visual elements  
- "Math: [calculation]" - if requires computation
- "is_blank" - if unanswerable

\{
  "answer": "natural language answer",
  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",
  "answer_unit": "unit or 'is_blank'",
  "ref_id": ["doc_id"],
  "ref_url": ["ref_url"],
  "supporting_materials": "exact quote or reference",
  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"
\}

Always start with \{. 
Context: {{context}}
Question: {{question}}
Response:</code></pre>
<p>The key changes: <code>{context}</code> â†’ <code>{context}</code>, <code>{question}</code> â†’ <code>{question}</code>, and literal <code>{</code> â†’ <code>\{</code></p>
<p>Would you like to create this prompt in Braintrust now?</p>
<div id="e4710c21" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb343"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> braintrust</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How shall I resolve the error? And is the slug used for versioning? How shall I refer versions?</p>
</section>
<section id="reply-156" class="level5">
<h5 class="anchored" data-anchor-id="reply-156">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Let me search for the correct Braintrust API for managing prompts.Perfect! I found the correct method. <a href="https://www.braintrust.dev/docs/cookbook/recipes/PromptVersioning" title="Prompt versioning and deployment - Docs - Braintrust">*</a> To create a prompt in Braintrust, you use <code>project.prompts.create()</code> method. Hereâ€™s how to fix your code:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb344"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> braintrust.projects.create(name<span class="op">=</span><span class="st">"WattBot2025"</span>)</span>
<span id="cb344-2"><a href="#cb344-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> project.prompts.create(</span>
<span id="cb344-3"><a href="#cb344-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"WattBot Prompt"</span>,</span>
<span id="cb344-4"><a href="#cb344-4" aria-hidden="true" tabindex="-1"></a>    slug<span class="op">=</span><span class="st">"wattbot-prompt"</span>,</span>
<span id="cb344-5"><a href="#cb344-5" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span>{<span class="st">"prompt"</span>: prompt_template},</span>
<span id="cb344-6"><a href="#cb344-6" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span></span>
<span id="cb344-7"><a href="#cb344-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><a href="https://www.braintrust.dev/docs/guides/functions/prompts" title="Braintrust">*</a> The slug is a unique identifier you use to reference the prompt in your code - as you change the promptâ€™s content, the slug stays constant.</p>
<p><a href="https://www.braintrust.dev/docs/guides/functions/prompts" title="Braintrust">*</a> For versioning, Braintrust automatically tracks versions, and you can load a specific version using <code>loadPrompt()</code> with a version parameter. Each update creates a new version transaction ID automatically.</p>
<p>Should we try this corrected approach?</p>
<p>Still getting error</p>
</section>
<section id="reply-157" class="level5">
<h5 class="anchored" data-anchor-id="reply-157">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The issue is that <code>braintrust.init()</code> returns an Experiment object, not a project object with prompts. Let me search for the correct Braintrust API for creating prompts with an existing project ID.I found the correct way! <a href="https://www.braintrust.dev/docs/cookbook/recipes/PromptVersioning" title="Prompt versioning and deployment - Docs - Braintrust">*</a> According to Braintrust docs, you use <code>braintrust.projects.create()</code> to get a project object, then call <code>project.prompts.create()</code> to create a prompt. Hereâ€™s the correct code:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb345"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> braintrust.projects.create(name<span class="op">=</span><span class="st">"WattBot2025"</span>)</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> project.prompts.create(</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"WattBot Prompt"</span>,</span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>    slug<span class="op">=</span><span class="st">"wattbot-prompt"</span>,</span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span>{<span class="st">"prompt"</span>: prompt_template},</span>
<span id="cb345-6"><a href="#cb345-6" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span></span>
<span id="cb345-7"><a href="#cb345-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><a href="https://www.braintrust.dev/docs/cookbook/recipes/PromptVersioning" title="Prompt versioning and deployment - Docs - Braintrust">*</a> The slug is how youâ€™ll reference the prompt later - Braintrust automatically handles versioning when you update prompts with the same slug.</p>
<p>Should we try this approach with your existing project?</p>
<p>What if I have already a project id?</p>
</section>
<section id="reply-158" class="level5">
<h5 class="anchored" data-anchor-id="reply-158">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>If you have an existing project ID, you can use <a href="https://www.braintrust.dev/docs/cookbook/recipes/PromptVersioning" title="Prompt versioning and deployment - Docs - Braintrust">*</a> <code>braintrust.projects.create(name="your-project-name")</code> to reference your project (it wonâ€™t create a duplicate if a project with that name already exists), then create prompts within it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb346"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> braintrust.projects.create(name<span class="op">=</span><span class="st">"WattBot2025"</span>)  <span class="co"># References existing project</span></span>
<span id="cb346-2"><a href="#cb346-2" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> project.prompts.create(</span>
<span id="cb346-3"><a href="#cb346-3" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"WattBot Prompt"</span>,</span>
<span id="cb346-4"><a href="#cb346-4" aria-hidden="true" tabindex="-1"></a>    slug<span class="op">=</span><span class="st">"wattbot-prompt"</span>,</span>
<span id="cb346-5"><a href="#cb346-5" aria-hidden="true" tabindex="-1"></a>    prompt<span class="op">=</span>{<span class="st">"prompt"</span>: prompt_template},</span>
<span id="cb346-6"><a href="#cb346-6" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span></span>
<span id="cb346-7"><a href="#cb346-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The <code>name</code> parameter identifies which project to use - if it exists, it returns the existing project. Would you like to try this approach?</p>
<div id="16a5c9bd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb347"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> lisette <span class="im">as</span> lz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cbb3286f" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb348"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" aria-hidden="true" tabindex="-1"></a>messages <span class="op">=</span> lz.mk_msgs(prompt_template)<span class="op">;</span> messages</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>[{'role': 'user',
  'content': 'You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:\n\nFor answer_value field:\n- Use 0 for False, 1 for True\n- Use exact numbers for numeric answers\n- Use exact text for categorical answers\n\nFor supporting_materials field:\n- Use exact verbatim quote if answer comes from text\n- Use "Table X" or "Figure Y" if from visual elements\n- Use "is_blank" if no specific reference or when unanswerable\n\nFor explanation field, use one of these formats:\n- "Quote" - if answer comes directly from text\n- "Table" or "Figure" - if from visual elements  \n- "Math: [calculation]" - if requires computation\n- "is_blank" - if unanswerable\n\n{\n  "answer": "natural language answer",\n  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",\n  "answer_unit": "unit or \'is_blank\'",\n  "ref_id": ["doc_id"],\n  "ref_url": ["ref_url"],\n  "supporting_materials": "exact quote or reference",\n  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"\n}\n\nAlways start with {. \nContext: {{context}}\nQuestion: {{question}}\nResponse:\n'}]</code></pre>
</div>
</div>
<div id="42efde20" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb350"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" aria-hidden="true" tabindex="-1"></a>llm_model <span class="op">=</span> <span class="st">"accounts/fireworks/models/llama-v3p1-70b-instruct"</span></span>
<span id="cb350-2"><a href="#cb350-2" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> braintrust.projects.create(name<span class="op">=</span><span class="st">"wattbot"</span>)</span>
<span id="cb350-3"><a href="#cb350-3" aria-hidden="true" tabindex="-1"></a>prompt <span class="op">=</span> project.prompts.create(name<span class="op">=</span><span class="st">"WattBot Prompt"</span>, model <span class="op">=</span> llm_model, slug<span class="op">=</span><span class="st">"wattbot-prompt-v1"</span>, messages<span class="op">=</span>messages, if_exists<span class="op">=</span> <span class="st">"replace"</span>)</span>
<span id="cb350-4"><a href="#cb350-4" aria-hidden="true" tabindex="-1"></a>project.publish()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'status': 'success'}</code></pre>
</div>
</div>
</section>
</section>
<section id="ai-prompt" class="level2">
<h2 class="anchored" data-anchor-id="ai-prompt">AI Prompt</h2>
<p>How to load the prompt ## AI Response ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ </p>
<p>To load a prompt from Braintrust, you use the <code>load_prompt()</code> function with your project and slug:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb352"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" aria-hidden="true" tabindex="-1"></a>loaded_prompt <span class="op">=</span> braintrust.load_prompt(project<span class="op">=</span><span class="st">"wattbot"</span>, slug<span class="op">=</span><span class="st">"wattbot-prompt"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will load the latest version of your prompt. Would you like to try loading it?</p>
<div id="3aecebeb" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb353"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a>loaded_prompt <span class="op">=</span> braintrust.load_prompt(project<span class="op">=</span><span class="st">"wattbot"</span>, slug<span class="op">=</span><span class="st">"wattbot-prompt-v1"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="63dfb5d2" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb354"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb354-1"><a href="#cb354-1" aria-hidden="true" tabindex="-1"></a>loaded_prompt.prompt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>PromptChatBlock(messages=[PromptMessage(content='You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:\n\nFor answer_value field:\n- Use 0 for False, 1 for True\n- Use exact numbers for numeric answers\n- Use exact text for categorical answers\n\nFor supporting_materials field:\n- Use exact verbatim quote if answer comes from text\n- Use "Table X" or "Figure Y" if from visual elements\n- Use "is_blank" if no specific reference or when unanswerable\n\nFor explanation field, use one of these formats:\n- "Quote" - if answer comes directly from text\n- "Table" or "Figure" - if from visual elements  \n- "Math: [calculation]" - if requires computation\n- "is_blank" - if unanswerable\n\n{\n  "answer": "natural language answer",\n  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",\n  "answer_unit": "unit or \'is_blank\'",\n  "ref_id": ["doc_id"],\n  "ref_url": ["ref_url"],\n  "supporting_materials": "exact quote or reference",\n  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"\n}\n\nAlways start with {. \nContext: {{context}}\nQuestion: {{question}}\nResponse:\n', role='user', name=None, function_call=None, tool_calls=None)], tools=None, type='chat')</code></pre>
</div>
</div>
<p>Now how shall I prefill the context and question for this prompt?</p>
<section id="reply-159" class="level5">
<h5 class="anchored" data-anchor-id="reply-159">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>To fill in the <code>{context}</code> and <code>{question}</code> variables in your Braintrust prompt, you use the <code>build()</code> method:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb356"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb356-1"><a href="#cb356-1" aria-hidden="true" tabindex="-1"></a>filled_prompt <span class="op">=</span> loaded_prompt.build(context<span class="op">=</span>your_context, question<span class="op">=</span>your_question)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will replace the mustache variables with your actual values. Would you like to try this with a sample context and question?</p>
<p>Yes</p>
</section>
<section id="reply-160" class="level5">
<h5 class="anchored" data-anchor-id="reply-160">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s try filling in the prompt with sample data:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb357"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a>sample_context <span class="op">=</span> <span class="st">"Doc ID: amazon2023</span><span class="ch">\n</span><span class="st">Text: Amazon's carbon emissions goal is net-zero by 2040."</span></span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a>sample_question <span class="op">=</span> <span class="st">"What is Amazon's carbon goal?"</span></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a>filled_prompt <span class="op">=</span> loaded_prompt.build(context<span class="op">=</span>sample_context, question<span class="op">=</span>sample_question)</span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(filled_prompt)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we run this to see how the variables get filled in?</p>
<div id="32ab8d8e" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb358"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb358-1"><a href="#cb358-1" aria-hidden="true" tabindex="-1"></a>sample_context <span class="op">=</span> <span class="st">"Doc ID: amazon2023</span><span class="ch">\n</span><span class="st">Text: Amazon's carbon emissions goal is net-zero by 2040."</span></span>
<span id="cb358-2"><a href="#cb358-2" aria-hidden="true" tabindex="-1"></a>sample_question <span class="op">=</span> <span class="st">"What is Amazon's carbon goal?"</span></span>
<span id="cb358-3"><a href="#cb358-3" aria-hidden="true" tabindex="-1"></a>filled_prompt <span class="op">=</span> loaded_prompt.build(context<span class="op">=</span>sample_context, question<span class="op">=</span>sample_question)</span>
<span id="cb358-4"><a href="#cb358-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(filled_prompt)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>{'model': 'accounts/fireworks/models/llama-v3p1-70b-instruct', 'span_info': {'metadata': {'prompt': {'variables': {'context': "Doc ID: amazon2023\nText: Amazon's carbon emissions goal is net-zero by 2040.", 'question': "What is Amazon's carbon goal?"}, 'id': '92048cd8-fd55-4775-9b23-ca4d8cf697e6', 'project_id': '6c094e85-403b-4ea5-ae5c-03c7fad1c8bb', 'version': '1000195995678157075'}}}, 'messages': [{'content': 'You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format:\n\nFor answer_value field:\n- Use 0 for False, 1 for True\n- Use exact numbers for numeric answers\n- Use exact text for categorical answers\n\nFor supporting_materials field:\n- Use exact verbatim quote if answer comes from text\n- Use "Table X" or "Figure Y" if from visual elements\n- Use "is_blank" if no specific reference or when unanswerable\n\nFor explanation field, use one of these formats:\n- "Quote" - if answer comes directly from text\n- "Table" or "Figure" - if from visual elements  \n- "Math: [calculation]" - if requires computation\n- "is_blank" - if unanswerable\n\n{\n  "answer": "natural language answer",\n  "answer_value": "0/1 for booleans, numbers for numeric, exact text for categorical",\n  "answer_unit": "unit or \'is_blank\'",\n  "ref_id": ["doc_id"],\n  "ref_url": ["ref_url"],\n  "supporting_materials": "exact quote or reference",\n  "explanation": "Quote/Table/Figure/Math: calculation/is_blank"\n}\n\nAlways start with {. \nContext: Doc ID: amazon2023\nText: Amazon\'s carbon emissions goal is net-zero by 2040.\nQuestion: What is Amazon\'s carbon goal?\nResponse:\n', 'role': 'user'}]}</code></pre>
</div>
</div>
<p>Now shall I use the prompt to call the llm?</p>
</section>
<section id="reply-161" class="level5">
<h5 class="anchored" data-anchor-id="reply-161">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes! The <code>build()</code> method returns a dictionary with <code>messages</code> that you can pass directly to your LLM client:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb360"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb360-1"><a href="#cb360-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> llm.chat.completions.create(<span class="op">**</span>filled_prompt)</span>
<span id="cb360-2"><a href="#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we try calling the LLM with the filled prompt?</p>
<div id="a200a932" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb361"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> fastcore.<span class="bu">all</span> <span class="im">as</span> fc</span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> llm.chat.completions.create(filled_prompt[<span class="st">'messages'</span>])<span class="op">;</span> fc.loads(response.choices[<span class="dv">0</span>].message.content)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>{'answer': "Amazon's carbon emissions goal is to be net-zero by 2040.",
 'answer_value': 'net-zero by 2040',
 'answer_unit': 'is_blank',
 'ref_id': ['amazon2023'],
 'ref_url': ['is_blank'],
 'supporting_materials': "Amazon's carbon emissions goal is net-zero by 2040.",
 'explanation': 'Quote'}</code></pre>
</div>
</div>
<p>Now I want to implement the Evaluator class with the calculate_wattbot_score function</p>
</section>
<section id="reply-162" class="level5">
<h5 class="anchored" data-anchor-id="reply-162">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Now letâ€™s implement the <code>Evaluator</code> class. It should include:</p>
<ul>
<li>The scoring functions you already created (<a href="https://anubhavmaity.github.io/wattbot/evaluate.html#score_answer_value"><code>score_answer_value</code></a>, <a href="https://anubhavmaity.github.io/wattbot/evaluate.html#score_ref_id"><code>score_ref_id</code></a>, <a href="https://anubhavmaity.github.io/wattbot/evaluate.html#score_is_na"><code>score_is_na</code></a>)</li>
<li><a href="https://anubhavmaity.github.io/wattbot/evaluate.html#calculate_wattbot_score"><code>calculate_wattbot_score</code></a> to combine them</li>
<li><code>evaluate_dataset</code> to run evaluation on all questions</li>
<li><code>get_worst_predictions</code> for debugging</li>
</ul>
<p>Should we start by putting your existing scoring functions into the <code>Evaluator</code> class?</p>
<p>Yes</p>
</section>
<section id="reply-163" class="level5">
<h5 class="anchored" data-anchor-id="reply-163">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Letâ€™s start building the <code>Evaluator</code> class with your existing scoring functions:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb363"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Evaluator:</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> []</span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_answer_value(<span class="va">self</span>, predicted, expected):</span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Your existing implementation</span></span>
<span id="cb363-7"><a href="#cb363-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb363-8"><a href="#cb363-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb363-9"><a href="#cb363-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_ref_id(<span class="va">self</span>, predicted, expected):</span>
<span id="cb363-10"><a href="#cb363-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Your existing implementation</span></span>
<span id="cb363-11"><a href="#cb363-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb363-12"><a href="#cb363-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb363-13"><a href="#cb363-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_is_na(<span class="va">self</span>, predicted_answer, expected_answer):</span>
<span id="cb363-14"><a href="#cb363-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Your existing implementation</span></span>
<span id="cb363-15"><a href="#cb363-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb363-16"><a href="#cb363-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb363-17"><a href="#cb363-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_wattbot_score(<span class="va">self</span>, predicted_answer, expected_row):</span>
<span id="cb363-18"><a href="#cb363-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combine the three scores with weights</span></span>
<span id="cb363-19"><a href="#cb363-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we copy your existing scoring function implementations into this class structure?</p>
<p>Yes</p>
</section>
<section id="reply-164" class="level5">
<h5 class="anchored" data-anchor-id="reply-164">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Hereâ€™s the <code>Evaluator</code> class with your existing scoring functions:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb364"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb364-1"><a href="#cb364-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb364-2"><a href="#cb364-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> types <span class="im">import</span> SimpleNamespace</span>
<span id="cb364-3"><a href="#cb364-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb364-4"><a href="#cb364-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Evaluator:</span>
<span id="cb364-5"><a href="#cb364-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb364-6"><a href="#cb364-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> []</span>
<span id="cb364-7"><a href="#cb364-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb364-8"><a href="#cb364-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_numeric(<span class="va">self</span>, value):</span>
<span id="cb364-9"><a href="#cb364-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb364-10"><a href="#cb364-10" aria-hidden="true" tabindex="-1"></a>            <span class="bu">float</span>(value)</span>
<span id="cb364-11"><a href="#cb364-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb364-12"><a href="#cb364-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb364-13"><a href="#cb364-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb364-14"><a href="#cb364-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb364-15"><a href="#cb364-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_answer_value(<span class="va">self</span>, predicted, expected):</span>
<span id="cb364-16"><a href="#cb364-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb364-17"><a href="#cb364-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb364-18"><a href="#cb364-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb364-19"><a href="#cb364-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.is_numeric(expected) <span class="kw">and</span> <span class="va">self</span>.is_numeric(predicted):</span>
<span id="cb364-20"><a href="#cb364-20" aria-hidden="true" tabindex="-1"></a>            pred_num, exp_num <span class="op">=</span> <span class="bu">map</span>(<span class="bu">float</span>, (predicted, expected))</span>
<span id="cb364-21"><a href="#cb364-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> exp_num) <span class="op">&lt;=</span> <span class="bu">abs</span>(exp_num <span class="op">*</span> <span class="fl">0.001</span>) <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb364-22"><a href="#cb364-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb364-23"><a href="#cb364-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">str</span>(predicted).strip().lower() <span class="op">==</span> <span class="bu">str</span>(expected).strip().lower() <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb364-24"><a href="#cb364-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb364-25"><a href="#cb364-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_ref_id(<span class="va">self</span>, predicted, expected):</span>
<span id="cb364-26"><a href="#cb364-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb364-27"><a href="#cb364-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb364-28"><a href="#cb364-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb364-29"><a href="#cb364-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">str</span>) <span class="kw">and</span> expected.startswith(<span class="st">'['</span>): expected <span class="op">=</span> ast.literal_eval(expected)</span>
<span id="cb364-30"><a href="#cb364-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb364-31"><a href="#cb364-31" aria-hidden="true" tabindex="-1"></a>        pred_set <span class="op">=</span> <span class="bu">set</span>(predicted) <span class="cf">if</span> <span class="bu">isinstance</span>(predicted, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([predicted])</span>
<span id="cb364-32"><a href="#cb364-32" aria-hidden="true" tabindex="-1"></a>        exp_set <span class="op">=</span> <span class="bu">set</span>(expected) <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([expected])</span>
<span id="cb364-33"><a href="#cb364-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb364-34"><a href="#cb364-34" aria-hidden="true" tabindex="-1"></a>        intersection <span class="op">=</span> <span class="bu">len</span>(pred_set.intersection(exp_set))</span>
<span id="cb364-35"><a href="#cb364-35" aria-hidden="true" tabindex="-1"></a>        union <span class="op">=</span> <span class="bu">len</span>(pred_set.union(exp_set))</span>
<span id="cb364-36"><a href="#cb364-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb364-37"><a href="#cb364-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb364-38"><a href="#cb364-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb364-39"><a href="#cb364-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_is_na(<span class="va">self</span>, predicted_answer, expected_answer):</span>
<span id="cb364-40"><a href="#cb364-40" aria-hidden="true" tabindex="-1"></a>        expected_is_na <span class="op">=</span> expected_answer[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb364-41"><a href="#cb364-41" aria-hidden="true" tabindex="-1"></a>        predicted_is_na <span class="op">=</span> predicted_answer[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb364-42"><a href="#cb364-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> expected_is_na <span class="op">==</span> predicted_is_na <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb364-43"><a href="#cb364-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb364-44"><a href="#cb364-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_wattbot_score(<span class="va">self</span>, predicted_answer, expected_row):</span>
<span id="cb364-45"><a href="#cb364-45" aria-hidden="true" tabindex="-1"></a>        answer_score <span class="op">=</span> <span class="va">self</span>.score_answer_value(predicted_answer[<span class="st">'answer_value'</span>], expected_row[<span class="st">'answer_value'</span>])</span>
<span id="cb364-46"><a href="#cb364-46" aria-hidden="true" tabindex="-1"></a>        ref_score <span class="op">=</span> <span class="va">self</span>.score_ref_id(predicted_answer[<span class="st">'ref_id'</span>], expected_row[<span class="st">'ref_id'</span>])</span>
<span id="cb364-47"><a href="#cb364-47" aria-hidden="true" tabindex="-1"></a>        na_score <span class="op">=</span> <span class="va">self</span>.score_is_na(predicted_answer, expected_row)</span>
<span id="cb364-48"><a href="#cb364-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb364-49"><a href="#cb364-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.75</span> <span class="op">*</span> answer_score <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> ref_score <span class="op">+</span> <span class="fl">0.10</span> <span class="op">*</span> na_score</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now should we implement the <code>evaluate_dataset</code> method?</p>
<div id="968db701" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb365"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ast</span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> types <span class="im">import</span> SimpleNamespace</span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> EvalUtil:</span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb365-7"><a href="#cb365-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_numeric(value):</span>
<span id="cb365-8"><a href="#cb365-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb365-9"><a href="#cb365-9" aria-hidden="true" tabindex="-1"></a>            <span class="bu">float</span>(value)</span>
<span id="cb365-10"><a href="#cb365-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb365-11"><a href="#cb365-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb365-12"><a href="#cb365-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb365-13"><a href="#cb365-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb365-14"><a href="#cb365-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb365-15"><a href="#cb365-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_answer_value(predicted, expected):</span>
<span id="cb365-16"><a href="#cb365-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb365-17"><a href="#cb365-17" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb365-18"><a href="#cb365-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb365-19"><a href="#cb365-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> EvalUtil.is_numeric(expected) <span class="kw">and</span> EvalUtil.is_numeric(predicted):</span>
<span id="cb365-20"><a href="#cb365-20" aria-hidden="true" tabindex="-1"></a>            pred_num, exp_num <span class="op">=</span> <span class="bu">map</span>(<span class="bu">float</span>, (predicted, expected))</span>
<span id="cb365-21"><a href="#cb365-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">abs</span>(pred_num <span class="op">-</span> exp_num) <span class="op">&lt;=</span> <span class="bu">abs</span>(exp_num <span class="op">*</span> <span class="fl">0.001</span>) <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb365-22"><a href="#cb365-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb365-23"><a href="#cb365-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> <span class="bu">str</span>(predicted).strip().lower() <span class="op">==</span> <span class="bu">str</span>(expected).strip().lower() <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb365-24"><a href="#cb365-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb365-25"><a href="#cb365-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb365-26"><a href="#cb365-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_ref_id(predicted, expected):</span>
<span id="cb365-27"><a href="#cb365-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> expected <span class="op">==</span> <span class="st">"is_blank"</span>:</span>
<span id="cb365-28"><a href="#cb365-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> predicted <span class="op">==</span> <span class="st">"is_blank"</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb365-29"><a href="#cb365-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb365-30"><a href="#cb365-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">str</span>) <span class="kw">and</span> expected.startswith(<span class="st">'['</span>): expected <span class="op">=</span> ast.literal_eval(expected)</span>
<span id="cb365-31"><a href="#cb365-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb365-32"><a href="#cb365-32" aria-hidden="true" tabindex="-1"></a>        pred_set <span class="op">=</span> <span class="bu">set</span>(predicted) <span class="cf">if</span> <span class="bu">isinstance</span>(predicted, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([predicted])</span>
<span id="cb365-33"><a href="#cb365-33" aria-hidden="true" tabindex="-1"></a>        exp_set <span class="op">=</span> <span class="bu">set</span>(expected) <span class="cf">if</span> <span class="bu">isinstance</span>(expected, <span class="bu">list</span>) <span class="cf">else</span> <span class="bu">set</span>([expected])</span>
<span id="cb365-34"><a href="#cb365-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb365-35"><a href="#cb365-35" aria-hidden="true" tabindex="-1"></a>        intersection <span class="op">=</span> <span class="bu">len</span>(pred_set.intersection(exp_set))</span>
<span id="cb365-36"><a href="#cb365-36" aria-hidden="true" tabindex="-1"></a>        union <span class="op">=</span> <span class="bu">len</span>(pred_set.union(exp_set))</span>
<span id="cb365-37"><a href="#cb365-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb365-38"><a href="#cb365-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> intersection <span class="op">/</span> union <span class="cf">if</span> union <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb365-39"><a href="#cb365-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb365-40"><a href="#cb365-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb365-41"><a href="#cb365-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> score_is_na(predicted_answer, expected_answer):</span>
<span id="cb365-42"><a href="#cb365-42" aria-hidden="true" tabindex="-1"></a>        expected_is_na <span class="op">=</span> expected_answer[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb365-43"><a href="#cb365-43" aria-hidden="true" tabindex="-1"></a>        predicted_is_na <span class="op">=</span> predicted_answer[<span class="st">'answer_value'</span>] <span class="op">==</span> <span class="st">'is_blank'</span></span>
<span id="cb365-44"><a href="#cb365-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1.0</span> <span class="cf">if</span> expected_is_na <span class="op">==</span> predicted_is_na <span class="cf">else</span> <span class="fl">0.0</span></span>
<span id="cb365-45"><a href="#cb365-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb365-46"><a href="#cb365-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb365-47"><a href="#cb365-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calculate_wattbot_score(predicted_answer, expected_row):</span>
<span id="cb365-48"><a href="#cb365-48" aria-hidden="true" tabindex="-1"></a>        answer_score <span class="op">=</span> EvalUtil.score_answer_value(predicted_answer[<span class="st">'answer_value'</span>], expected_row[<span class="st">'answer_value'</span>])</span>
<span id="cb365-49"><a href="#cb365-49" aria-hidden="true" tabindex="-1"></a>        ref_score <span class="op">=</span> EvalUtil.score_ref_id(predicted_answer[<span class="st">'ref_id'</span>], expected_row[<span class="st">'ref_id'</span>])</span>
<span id="cb365-50"><a href="#cb365-50" aria-hidden="true" tabindex="-1"></a>        na_score <span class="op">=</span> EvalUtil.score_is_na(predicted_answer, expected_row)</span>
<span id="cb365-51"><a href="#cb365-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb365-52"><a href="#cb365-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">0.75</span> <span class="op">*</span> answer_score <span class="op">+</span> <span class="fl">0.15</span> <span class="op">*</span> ref_score <span class="op">+</span> <span class="fl">0.10</span> <span class="op">*</span> na_score</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>I created evalutil class. Is this looking good?</p>
</section>
<section id="reply-165" class="level5">
<h5 class="anchored" data-anchor-id="reply-165">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes, looks great! Using static methods is a clean choice since these scoring functions donâ€™t need instance state.</p>
<p>Now should we create the <code>Evaluator</code> class that uses <code>EvalUtil</code> and implements the <code>evaluate_dataset</code> and <code>get_worst_predictions</code> methods?</p>
<p>Yes</p>
</section>
<section id="reply-166" class="level5">
<h5 class="anchored" data-anchor-id="reply-166">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s create the <code>Evaluator</code> class that uses <code>EvalUtil</code>. Hereâ€™s the structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb366"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb366-1"><a href="#cb366-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Evaluator:</span>
<span id="cb366-2"><a href="#cb366-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, rag):</span>
<span id="cb366-3"><a href="#cb366-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb366-4"><a href="#cb366-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> []</span>
<span id="cb366-5"><a href="#cb366-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb366-6"><a href="#cb366-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_dataset(<span class="va">self</span>, qa_dataframe, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb366-7"><a href="#cb366-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> evaluate_row(r):</span>
<span id="cb366-8"><a href="#cb366-8" aria-hidden="true" tabindex="-1"></a>            predicted_answer <span class="op">=</span> <span class="va">self</span>.rag.answer_question(r[<span class="st">'question'</span>])</span>
<span id="cb366-9"><a href="#cb366-9" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> EvalUtil.calculate_wattbot_score(predicted_answer, r)</span>
<span id="cb366-10"><a href="#cb366-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> fc.NS(qid<span class="op">=</span>r[<span class="st">'id'</span>], q<span class="op">=</span>r[<span class="st">'question'</span>], predicted<span class="op">=</span>predicted_answer, expected<span class="op">=</span>r, <span class="op">**</span>score, context<span class="op">=</span><span class="va">self</span>.rag.retrieved_chunks)</span>
<span id="cb366-11"><a href="#cb366-11" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb366-12"><a href="#cb366-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> qa_dataframe.<span class="bu">apply</span>(evaluate_row, axis<span class="op">=</span><span class="dv">1</span>).tolist()</span>
<span id="cb366-13"><a href="#cb366-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(r.scores[<span class="st">'total'</span>] <span class="cf">for</span> r <span class="kw">in</span> <span class="va">self</span>.results) <span class="op">/</span> <span class="bu">len</span>(<span class="va">self</span>.results)</span>
<span id="cb366-14"><a href="#cb366-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb366-15"><a href="#cb366-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_worst_predictions(<span class="va">self</span>, n<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb366-16"><a href="#cb366-16" aria-hidden="true" tabindex="-1"></a>        sorted_results <span class="op">=</span> <span class="bu">sorted</span>(<span class="va">self</span>.results, key<span class="op">=</span><span class="kw">lambda</span> r: r.scores[<span class="st">'total'</span>])</span>
<span id="cb366-17"><a href="#cb366-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sorted_results[:n]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we implement the <code>evaluate_row</code> function inside <code>evaluate_dataset</code>?</p>
<div id="558e9b72" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb367"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Evaluator:</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, rag):</span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>        fc.store_attr()</span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> []</span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_dataset(<span class="va">self</span>, qa_dataframe, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> evaluate_row(r):</span>
<span id="cb367-8"><a href="#cb367-8" aria-hidden="true" tabindex="-1"></a>            predicted_answer <span class="op">=</span> <span class="va">self</span>.rag.answer_question(r[<span class="st">'question'</span>])</span>
<span id="cb367-9"><a href="#cb367-9" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> EvalUtil.calculate_wattbot_score(predicted_answer, r)</span>
<span id="cb367-10"><a href="#cb367-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> fc.NS(qid<span class="op">=</span>r[<span class="st">'id'</span>], q<span class="op">=</span>r[<span class="st">'question'</span>], predicted<span class="op">=</span>predicted_answer, expected<span class="op">=</span>r, <span class="op">**</span>score, context<span class="op">=</span><span class="va">self</span>.rag.retrieved_chunks)</span>
<span id="cb367-11"><a href="#cb367-11" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb367-12"><a href="#cb367-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.results <span class="op">=</span> qa_dataframe.<span class="bu">apply</span>(evaluate_row, axis<span class="op">=</span><span class="dv">1</span>).tolist()</span>
<span id="cb367-13"><a href="#cb367-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">sum</span>(r.scores[<span class="st">'total'</span>] <span class="cf">for</span> r <span class="kw">in</span> <span class="va">self</span>.results) <span class="op">/</span> <span class="bu">len</span>(<span class="va">self</span>.results)</span>
<span id="cb367-14"><a href="#cb367-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb367-15"><a href="#cb367-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_worst_predictions(<span class="va">self</span>, n<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb367-16"><a href="#cb367-16" aria-hidden="true" tabindex="-1"></a>        sorted_results <span class="op">=</span> <span class="bu">sorted</span>(<span class="va">self</span>.results, key<span class="op">=</span><span class="kw">lambda</span> r: r.scores[<span class="st">'total'</span>])</span>
<span id="cb367-17"><a href="#cb367-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> sorted_results[:n]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>How is it now?</p>
</section>
<section id="reply-167" class="level5">
<h5 class="anchored" data-anchor-id="reply-167">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good progress! A few things to consider:</p>
<ol type="1">
<li><p><strong>Retrieved chunks</strong> - Your RAG class doesnâ€™t currently store <code>retrieved_chunks</code> as an attribute. Should we modify the <a href="https://anubhavmaity.github.io/wattbot/generator.html#rag"><code>RAG</code></a> class to save the chunks it retrieves?</p></li>
<li><p><strong>Score structure</strong> - <a href="https://anubhavmaity.github.io/wattbot/evaluate.html#calculate_wattbot_score"><code>calculate_wattbot_score</code></a> returns a single float, but youâ€™re trying to unpack it with <code>**score</code>. Should we modify it to return a dictionary with individual scores?</p></li>
</ol>
<p>Which would you like to fix first?</p>
<p>I want to create a class/function which does prediction on the test file</p>
</section>
<section id="reply-168" class="level5">
<h5 class="anchored" data-anchor-id="reply-168">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good idea! You want a separate component for making predictions on test data (without ground truth answers).</p>
<p>Should this be: 1. A method in your existing <a href="https://anubhavmaity.github.io/wattbot/generator.html#rag"><code>RAG</code></a> class (like <code>predict_dataset()</code>)? 2. A separate <code>Predictor</code> class that wraps your RAG system?</p>
<p>Which approach do you prefer?</p>
<p>A method in the existing RAG class</p>
</section>
<section id="reply-169" class="level5">
<h5 class="anchored" data-anchor-id="reply-169">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s add a <code>predict_dataset</code> method to your <a href="https://anubhavmaity.github.io/wattbot/generator.html#rag"><code>RAG</code></a> class:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb368"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb368-1"><a href="#cb368-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_dataset(<span class="va">self</span>, test_dataframe, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb368-2"><a href="#cb368-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_row(row):</span>
<span id="cb368-3"><a href="#cb368-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.answer_question(row[<span class="st">'question'</span>], limit<span class="op">=</span>limit)</span>
<span id="cb368-4"><a href="#cb368-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb368-5"><a href="#cb368-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> test_dataframe.<span class="bu">apply</span>(predict_row, axis<span class="op">=</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This would return a Series of predictions. Does this structure work for you, or would you like it to return a full DataFrame with the predictions merged in?</p>
<p>I want to log the evals into braintrust</p>
</section>
<section id="reply-170" class="level5">
<h5 class="anchored" data-anchor-id="reply-170">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! To log evaluations to Braintrust, youâ€™ll need to use their <code>Eval</code> API. You typically:</p>
<ol type="1">
<li>Create an evaluation experiment</li>
<li>Log each question with its input, output, expected answer, and score</li>
</ol>
<p>Should we integrate Braintrust logging into your <code>Evaluator.evaluate_dataset()</code> method, or create a separate method for it?</p>
<p>Lets integrate braintrust logging into Evaulator.evaluate_dataset</p>
</section>
<section id="reply-171" class="level5">
<h5 class="anchored" data-anchor-id="reply-171">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! To integrate Braintrust logging into <code>evaluate_dataset</code>, youâ€™ll need to:</p>
<ol type="1">
<li>Initialize a Braintrust experiment at the start</li>
<li>Log each evaluation with <code>experiment.log()</code> including input, output, expected, and scores</li>
</ol>
<p>Hereâ€™s the basic structure:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb369"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_dataset(<span class="va">self</span>, qa_dataframe, limit<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>    experiment <span class="op">=</span> braintrust.init(project<span class="op">=</span><span class="st">"wattbot"</span>, experiment<span class="op">=</span><span class="st">"evaluation"</span>)</span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_row(r):</span>
<span id="cb369-5"><a href="#cb369-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... existing evaluation logic ...</span></span>
<span id="cb369-6"><a href="#cb369-6" aria-hidden="true" tabindex="-1"></a>        experiment.log(<span class="bu">input</span><span class="op">=</span>r[<span class="st">'question'</span>], output<span class="op">=</span>predicted_answer, expected<span class="op">=</span>r, scores<span class="op">=</span>{<span class="st">'wattbot_score'</span>: score})</span>
<span id="cb369-7"><a href="#cb369-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like me to show you the complete integration, or would you prefer to implement it step by step?</p>
<p>Can we log some metadata</p>
</section>
<section id="reply-172" class="level5">
<h5 class="anchored" data-anchor-id="reply-172">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Yes, absolutely! Braintrust allows you to log metadata alongside your evaluations. You can include things like:</p>
<ul>
<li>Model name and parameters</li>
<li>Retrieval settings (limit, chunk size)</li>
<li>Prompt version</li>
<li>Any other configuration details</li>
</ul>
<p>What specific metadata would you like to log for your evaluations?</p>
<p>The context, model name, chunksize etc</p>
</section>
<section id="reply-173" class="level5">
<h5 class="anchored" data-anchor-id="reply-173">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great choices! You can log all of those as metadata in Braintrust. Hereâ€™s how you could structure it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb370"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb370-1"><a href="#cb370-1" aria-hidden="true" tabindex="-1"></a>experiment.log(</span>
<span id="cb370-2"><a href="#cb370-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>r[<span class="st">'question'</span>],</span>
<span id="cb370-3"><a href="#cb370-3" aria-hidden="true" tabindex="-1"></a>    output<span class="op">=</span>predicted_answer,</span>
<span id="cb370-4"><a href="#cb370-4" aria-hidden="true" tabindex="-1"></a>    expected<span class="op">=</span>r,</span>
<span id="cb370-5"><a href="#cb370-5" aria-hidden="true" tabindex="-1"></a>    scores<span class="op">=</span>{<span class="st">'wattbot_score'</span>: score},</span>
<span id="cb370-6"><a href="#cb370-6" aria-hidden="true" tabindex="-1"></a>    metadata<span class="op">=</span>{</span>
<span id="cb370-7"><a href="#cb370-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'model'</span>: model_name,</span>
<span id="cb370-8"><a href="#cb370-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'chunk_size'</span>: chunk_size,</span>
<span id="cb370-9"><a href="#cb370-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'context'</span>: context,</span>
<span id="cb370-10"><a href="#cb370-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'retrieval_limit'</span>: limit</span>
<span id="cb370-11"><a href="#cb370-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb370-12"><a href="#cb370-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update your <code>Evaluator</code> class to accept these configuration parameters so they can be logged as metadata?</p>
<p>Can you suggest a better embedding model?</p>
</section>
<section id="reply-174" class="level5">
<h5 class="anchored" data-anchor-id="reply-174">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good question! For better retrieval quality, you could consider:</p>
<ol type="1">
<li><strong>nomic-embed-text-v1.5</strong> (what youâ€™re using) - 768 dims, good balance</li>
<li><strong>text-embedding-3-large</strong> (OpenAI) - 3072 dims, higher quality but slower/costlier</li>
<li><strong>voyage-large-2-instruct</strong> - Optimized for RAG tasks</li>
<li><strong>BGE-large-en-v1.5</strong> - Strong open-source option</li>
</ol>
<p>The best choice depends on your priorities. Would you like to experiment with a different model to see if it improves your retrieval scores?</p>
<p>I prefer a better open source model with 768 dimension</p>
</section>
<section id="reply-175" class="level5">
<h5 class="anchored" data-anchor-id="reply-175">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>For 768-dimensional open-source embeddings with better quality than nomic, consider:</p>
<ol type="1">
<li><strong>bge-large-en-v1.5</strong> - Strong retrieval performance, widely used</li>
<li><strong>gte-large</strong> - Good for general text embedding tasks</li>
<li><strong>e5-large-v2</strong> - Microsoftâ€™s model, performs well on benchmarks</li>
</ol>
<p><strong>bge-large-en-v1.5</strong> is probably your best bet - it consistently ranks high on retrieval benchmarks and is specifically optimized for semantic search.</p>
<p>Would you like to try switching to bge-large-en-v1.5 to see if it improves your retrieval quality?</p>
<p>I think bge-large-en-v1.5 is not there in fireworks</p>
</section>
<section id="reply-176" class="level5">
<h5 class="anchored" data-anchor-id="reply-176">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Youâ€™re right! Fireworks.ai has a limited set of embedding models. Let me check what embedding models are actually available on Fireworks.</p>
<p>For Fireworks.ai, the main embedding options are: - <strong>nomic-ai/nomic-embed-text-v1.5</strong> (what youâ€™re using - 768 dims) - <strong>nomic-ai/nomic-embed-text-v1</strong> (older version) - <strong>WhereIsAI/UAE-Large-V1</strong> (1024 dims)</p>
<p>If you want to stick with Fireworks and 768 dimensions, nomic-embed-text-v1.5 is actually your best option. To try better models like bge-large, youâ€™d need to switch to a different provider or run locally.</p>
<p>Would you like to stick with Fireworks and nomic, or explore other embedding providers?</p>
<p>Now how can I improve this RAG application</p>
</section>
<section id="reply-177" class="level5">
<h5 class="anchored" data-anchor-id="reply-177">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great question! Here are some key areas to improve your RAG application:</p>
<ol type="1">
<li><strong>Retrieval quality</strong> - Test different chunk sizes, add re-ranking, or try hybrid search (semantic + keyword)</li>
<li><strong>Prompt engineering</strong> - Add few-shot examples to guide the LLM better</li>
<li><strong>Evaluation-driven iteration</strong> - Use your <code>Evaluator</code> to identify where itâ€™s failing and iterate</li>
<li><strong>Metadata filtering</strong> - Filter by document type or year before retrieval</li>
<li><strong>Query expansion</strong> - Rephrase questions to improve retrieval</li>
</ol>
<p>Which area interests you most, or would you like to start by analyzing your current performance with the <code>Evaluator</code> to see where improvements are needed?</p>
<p>Can you please help with hybrid search?</p>
</section>
<section id="reply-178" class="level5">
<h5 class="anchored" data-anchor-id="reply-178">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Of course! Iâ€™d be happy to help you implement hybrid search for your RAG application.</p>
<p>To get started with hybrid search in Qdrant, we need to enable sparse vectors alongside your existing dense vectors. Qdrant supports this through their hybrid search feature.</p>
<p>First question: Would you like me to explain the concept and steps first, or would you prefer I write the code to implement it for you?</p>
<p>Lets go through the concept</p>
</section>
<section id="reply-179" class="level5">
<h5 class="anchored" data-anchor-id="reply-179">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s understand hybrid search step by step.</p>
<p><strong>What is Hybrid Search?</strong></p>
<p>Hybrid search combines two retrieval methods:</p>
<ol type="1">
<li><p><strong>Dense/Semantic search</strong> (what you currently have) - Uses embeddings to find semantically similar content. Great for concepts and meaning.</p></li>
<li><p><strong>Sparse/Keyword search</strong> (BM25-like) - Uses exact term matching and frequency. Great for specific names, numbers, and technical terms.</p></li>
</ol>
<p><strong>Why does it help?</strong></p>
<p>For your WattBot questions, you might ask â€œWhat is the ML.ENERGY Benchmark?â€ - semantic search might miss the exact name, but keyword search will catch it. Combining both gives you the best of both worlds.</p>
<p>Does this make sense so far? Should I explain how Qdrant implements this next?</p>
<p>Yes please</p>
</section>
<section id="reply-180" class="level5">
<h5 class="anchored" data-anchor-id="reply-180">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Hereâ€™s how Qdrant implements hybrid search:</p>
<p><strong>Qdrantâ€™s Approach:</strong></p>
<ol type="1">
<li><p><strong>Sparse Vectors</strong> - Qdrant stores both dense (your 768-dim embeddings) and sparse vectors (keyword-based) for each chunk</p></li>
<li><p><strong>Sparse Vector Generation</strong> - You need a model that creates sparse vectors from text. Common options:</p>
<ul>
<li>BM25 (traditional keyword scoring)</li>
<li>SPLADE (learned sparse representations)</li>
<li>Qdrantâ€™s built-in sparse vector support</li>
</ul></li>
<li><p><strong>Query Time</strong> - You send both dense and sparse query vectors, and Qdrant combines the results using a fusion algorithm (like RRF - Reciprocal Rank Fusion)</p></li>
</ol>
<p><strong>Key Implementation Steps:</strong> - Modify your collection to support both vector types - Generate sparse vectors for your chunks - Update queries to include both vector types</p>
<p>Would you like to start implementing this, beginning with updating your <code>QdrantStore</code> class to support sparse vectors?</p>
<p>Yes</p>
</section>
<section id="reply-181" class="level5">
<h5 class="anchored" data-anchor-id="reply-181">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s start by updating your <code>QdrantStore</code> class to support sparse vectors.</p>
<p>First, when creating the collection, youâ€™ll need to configure both dense and sparse vectors:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb371"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_collection(<span class="va">self</span>, vs, distance<span class="op">=</span>Distance.COSINE):</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.client.collection_exists(<span class="va">self</span>.cname):</span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.client.create_collection(</span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a>            collection_name<span class="op">=</span><span class="va">self</span>.cname,</span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a>            vectors_config<span class="op">=</span>{</span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a>                <span class="st">"dense"</span>: VectorParams(size<span class="op">=</span>vs, distance<span class="op">=</span>distance)</span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb371-8"><a href="#cb371-8" aria-hidden="true" tabindex="-1"></a>            sparse_vectors_config<span class="op">=</span>{</span>
<span id="cb371-9"><a href="#cb371-9" aria-hidden="true" tabindex="-1"></a>                <span class="st">"sparse"</span>: models.SparseVectorParams()</span>
<span id="cb371-10"><a href="#cb371-10" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb371-11"><a href="#cb371-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb371-12"><a href="#cb371-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This sets up two vector types: â€œdenseâ€ for your embeddings and â€œsparseâ€ for keyword-based vectors.</p>
<p>Should we update your <code>QdrantStore.create_collection()</code> method with this configuration?</p>
<p>Lets have variable to introduce hybrid search or dense search</p>
</section>
<section id="reply-182" class="level5">
<h5 class="anchored" data-anchor-id="reply-182">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Adding a configuration option makes your code more flexible. You could add a parameter to control whether to use hybrid or dense-only search:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb372"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb372-1"><a href="#cb372-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, url, api_key, cname, use_hybrid<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb372-2"><a href="#cb372-2" aria-hidden="true" tabindex="-1"></a>    fc.store_attr()</span>
<span id="cb372-3"><a href="#cb372-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... rest of init</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then in <code>create_collection</code>, youâ€™d conditionally add sparse vectors based on <code>use_hybrid</code>. Does this approach work for you, or would you prefer a different way to configure it?</p>
<p>What is the models in models.SparseVectorParams?</p>
</section>
<section id="reply-183" class="level5">
<h5 class="anchored" data-anchor-id="reply-183">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good catch! <code>models</code> refers to <code>qdrant_client.models</code>. You need to import it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb373"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client <span class="im">import</span> models</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Or you can use the full path: <code>qdrant_client.models.SparseVectorParams()</code></p>
<p>Which import style do you prefer for your code?</p>
<p>I am getting error AttributeError: â€˜QdrantClientâ€™ object has no attribute â€˜modelsâ€™</p>
</section>
<section id="reply-184" class="level5">
<h5 class="anchored" data-anchor-id="reply-184">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The error is because <code>models</code> is not an attribute of <code>QdrantClient</code> - itâ€™s a separate module you need to import directly.</p>
<p>You should import it like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb374"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qdrant_client <span class="im">import</span> models</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then use <code>models.SparseVectorParams()</code> in your code. Have you added this import at the top of your file?</p>
<p>I tried with that but it is not able to find simple text match</p>
</section>
<section id="reply-185" class="level5">
<h5 class="anchored" data-anchor-id="reply-185">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>If your hybrid search isnâ€™t finding simple text matches, there could be a few issues:</p>
<ol type="1">
<li><strong>Sparse vectors not generated properly</strong> - Are you creating sparse vectors for your chunks when indexing?</li>
<li><strong>Query sparse vector missing</strong> - Are you generating a sparse vector for your query too?</li>
<li><strong>Fusion scoring</strong> - The way dense and sparse scores are combined might be weighted too heavily toward dense</li>
</ol>
<p>Which part have you implemented so far - the indexing with sparse vectors, the querying, or both?</p>
<p>Okat after creating the collection what to do next?</p>
</section>
<section id="reply-186" class="level5">
<h5 class="anchored" data-anchor-id="reply-186">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good! After creating the collection with sparse vector support, the next step is to generate sparse vectors for your text chunks.</p>
<p>Youâ€™ll need a sparse vector encoder. Qdrant recommends using models like: - <strong>fastembed</strong> library with their sparse models - <strong>SPLADE</strong> models - Or implement BM25-style sparse vectors</p>
<p>Have you chosen which sparse vector model youâ€™d like to use, or would you like a recommendation?</p>
<p>Which one is good?</p>
</section>
<section id="reply-187" class="level5">
<h5 class="anchored" data-anchor-id="reply-187">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>For your use case, Iâ€™d recommend <strong>fastembed</strong> with their sparse models because:</p>
<ol type="1">
<li><strong>Easy integration</strong> - Works well with Qdrant</li>
<li><strong>Good performance</strong> - Balances speed and accuracy</li>
<li><strong>Simple API</strong> - Similar to what youâ€™re already using for dense embeddings</li>
</ol>
<p>Specifically, fastembedâ€™s <code>Splade</code> model is a solid choice for hybrid search.</p>
<p>Would you like to try implementing fastembed for sparse vectors?</p>
<p>Yes</p>
</section>
<section id="reply-188" class="level5">
<h5 class="anchored" data-anchor-id="reply-188">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! To get started with fastembed for sparse vectors, youâ€™ll need to:</p>
<ol type="1">
<li>Install fastembed: <code>pip install fastembed</code></li>
<li>Import and initialize the sparse embedding model</li>
<li>Generate sparse vectors alongside your dense embeddings</li>
</ol>
<p>Hereâ€™s how to initialize it:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb375"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastembed <span class="im">import</span> SparseTextEmbedding</span>
<span id="cb375-2"><a href="#cb375-2" aria-hidden="true" tabindex="-1"></a>sparse_model <span class="op">=</span> SparseTextEmbedding(model_name<span class="op">=</span><span class="st">"prithvida/Splade_PP_en_v1"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to try installing fastembed and creating a sparse embedder, or would you prefer I show you how to integrate it into your existing <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class?</p>
<p>I installed what is next?</p>
</section>
<section id="reply-189" class="level5">
<h5 class="anchored" data-anchor-id="reply-189">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now you need to create a sparse embedder similar to your dense <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class.</p>
<p>Should we: 1. Create a separate <code>SparseEmbedder</code> class 2. Modify your existing <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class to handle both dense and sparse</p>
<p>Which approach do you prefer?</p>
<p>Lets modify the embedder class to handle both</p>
</section>
<section id="reply-190" class="level5">
<h5 class="anchored" data-anchor-id="reply-190">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good choice! To modify your <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class to handle both dense and sparse embeddings, youâ€™ll need to:</p>
<ol type="1">
<li>Add a sparse model parameter to <code>__init__</code></li>
<li>Create a method to generate sparse embeddings</li>
<li>Optionally, create a method that generates both at once</li>
</ol>
<p>Should we start by updating the <code>__init__</code> method to accept an optional sparse model parameter?</p>
<p>Yes</p>
</section>
<section id="reply-191" class="level5">
<h5 class="anchored" data-anchor-id="reply-191">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s update the <code>__init__</code> method to accept an optional sparse model:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb376"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, client, model_name, sparse_model<span class="op">=</span><span class="va">None</span>, bs<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a>    fc.store_attr()</span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.gen_emb <span class="op">=</span> <span class="va">self</span>.client.embeddings.create</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Now youâ€™ll have <code>self.sparse_model</code> available. Should we add a method called <code>create_sparse_embeddings()</code> next that uses this sparse model?</p>
<p>Yes</p>
</section>
<section id="reply-192" class="level5">
<h5 class="anchored" data-anchor-id="reply-192">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Letâ€™s add a method to create sparse embeddings:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb377"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_sparse_embeddings(<span class="va">self</span>, texts):</span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.sparse_model:</span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Sparse model not initialized"</span>)</span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">list</span>(<span class="va">self</span>.sparse_model.embed(texts))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will generate sparse vectors for your texts. Should we test this method once youâ€™ve initialized an <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> with a sparse model?</p>
<p>Iâ€™ve deployed an end point to huggingface hase and now I want to call that endpoint to generate the sparse embendings instead of the local model because that way it will be faster.</p>
</section>
<section id="reply-193" class="level5">
<h5 class="anchored" data-anchor-id="reply-193">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Using a deployed endpoint will be much faster than running locally.</p>
<p>To call your Hugging Face endpoint, youâ€™ll need to use the <code>requests</code> library or Hugging Faceâ€™s <code>InferenceClient</code>.</p>
<p>Do you have the endpoint URL ready? And would you prefer to use <code>requests</code> or the Hugging Face client to call it?</p>
<p>I am running into some issue when deploying the model to the hugging phase endpoint. Is there any other model that generates better and bor sparse? embeddings that you can suggest which is also deployable to the hugging face endpoint.</p>
</section>
<section id="reply-194" class="level5">
<h5 class="anchored" data-anchor-id="reply-194">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>For sparse embeddings that work well with Hugging Face endpoints, here are some good alternatives:</p>
<ol type="1">
<li><strong>SPLADE v2</strong> - <code>naver/splade-cocondenser-ensembledistil</code> - Very effective for retrieval</li>
<li><strong>SPLADE++</strong> - Improved version with better performance</li>
<li><strong>distilsplade-max</strong> - Lighter and faster variant</li>
</ol>
<p>These models are specifically designed for sparse retrieval and should deploy smoothly to Hugging Face endpoints.</p>
<p>What issue are you running into with your current deployment? That might help me suggest the best alternative.</p>
<p>I am running into the following issue. Endpoint encountered an error. You can try restarting it using the â€œretryâ€ button above. Check logs for more details. [Server message]Endpoint failed to start Exit code: 3. Reason: /neuron/modeling_traced.pyâ€, line 358, in _export main_export( File â€œ/usr/local/lib/python3.10/dist-packages/optimum/exporters/neuron/<strong>main</strong>.pyâ€, line 624, in main_export models_and_neuron_configs, output_model_names = load_models_and_neuron_configs( File â€œ/usr/local/lib/python3.10/dist-packages/optimum/exporters/neuron/<strong>main</strong>.pyâ€, line 551, in load_models_and_neuron_configs model = TasksManager.get_model_from_task(**model_kwargs) File â€œ/usr/local/lib/python3.10/dist-packages/optimum/exporters/tasks.pyâ€, line 2093, in get_model_from_task model = model_class( File â€œ/usr/local/lib/python3.10/dist-packages/sentence_transformers/SentenceTransformer.pyâ€, line 308, in <strong>init</strong> modules, self.module_kwargs = self._load_sbert_model( File â€œ/usr/local/lib/python3.10/dist-packages/sentence_transformers/SentenceTransformer.pyâ€, line 1661, in _load_sbert_model module_class = self._load_module_class_from_ref( File â€œ/usr/local/lib/python3.10/dist-packages/sentence_transformers/SentenceTransformer.pyâ€, line 1551, in _load_module_class_from_ref return import_from_string(class_ref) File â€œ/usr/local/lib/python3.10/dist-packages/sentence_transformers/util.pyâ€, line 1126, in import_from_string module = importlib.import_module(module_path) File â€œ/usr/lib/python3.10/importlib/<strong>init</strong>.pyâ€, line 126, in import_module return _bootstrap._gcd_import(name[level:], package, level) File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 1050, in _gcd_import File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 1027, in _find_and_load File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 992, in _find_and_load_unlocked File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 241, in _call_with_frames_removed File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 1050, in _gcd_import File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 1027, in _find_and_load File â€œ&lt;frozen importlib._bootstrap&gt;â€, line 1004, in _find_and_load_unlocked ModuleNotFoundError: No module named â€˜sentence_transformers.sparse_encoderâ€™</p>
<p>Application startup failed. Exiting.</p>
</section>
<section id="reply-195" class="level5">
<h5 class="anchored" data-anchor-id="reply-195">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The error shows that the Hugging Face endpoint is trying to load a <code>sentence_transformers.sparse_encoder</code> module that doesnâ€™t exist. This suggests the SPLADE model youâ€™re trying to deploy has a custom architecture that isnâ€™t compatible with Hugging Faceâ€™s standard deployment.</p>
<p>For sparse embeddings on Hugging Face endpoints, try using a simpler approach:</p>
<p><strong>Option 1</strong>: Use a standard dense model endpoint and generate sparse vectors client-side using BM25 <strong>Option 2</strong>: Deploy a standard BERT-based model and use token-level embeddings to create sparse representations</p>
<p>Would you like to explore generating sparse vectors locally using BM25 (which is fast and doesnâ€™t need a model), or would you prefer to find a different deployable sparse model?</p>
<p>Letâ€™s try this Splade V2 which you are suggesting. If it doesnâ€™t work then we might go for BM25.</p>
</section>
<section id="reply-196" class="level5">
<h5 class="anchored" data-anchor-id="reply-196">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good plan! Letâ€™s try SPLADE v2 (<code>naver/splade-cocondenser-ensembledistil</code>).</p>
<p>To deploy it on Hugging Face, youâ€™ll need to: 1. Create a new inference endpoint 2. Select the model <code>naver/splade-cocondenser-ensembledistil</code> 3. Choose the task type (feature extraction or text embeddings)</p>
<p>Have you started creating the endpoint, or would you like guidance on the deployment settings?</p>
<p>This splade v2 is also failing. I would request for another model which works in the Huggingface endpoint.</p>
</section>
<section id="reply-197" class="level5">
<h5 class="anchored" data-anchor-id="reply-197">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>I understand the frustration with deployment issues. Since SPLADE models are having compatibility problems with Hugging Face endpoints, letâ€™s switch to <strong>BM25</strong> for sparse vectors instead.</p>
<p>BM25 is: - Fast and runs locally (no endpoint needed) - Proven effective for keyword matching - Easy to implement with libraries like <code>rank-bm25</code></p>
<p>Would you like to implement BM25 for your sparse embeddings? Itâ€™s actually simpler than deploying a model endpoint.</p>
<p>Letâ€™s go for it.</p>
</section>
<section id="reply-198" class="level5">
<h5 class="anchored" data-anchor-id="reply-198">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ ðŸ§ </p>
<p>Perfect! Letâ€™s implement BM25 for sparse embeddings.</p>
<p>First, youâ€™ll need to install the library:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb378"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install rank-bm25</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Once installed, weâ€™ll need to modify your <a href="https://anubhavmaity.github.io/wattbot/xx_sdk_markdown.html#embedder"><code>Embedder</code></a> class to generate BM25-style sparse vectors.</p>
<p>Have you installed <code>rank-bm25</code>, or would you like to do that first?</p>
<div id="e45c85b4" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb379"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install rank<span class="op">-</span>bm25</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting rank-bm25
  Downloading rank_bm25-0.2.2-py3-none-any.whl.metadata (3.2 kB)
Requirement already satisfied: numpy in /usr/local/lib/python3.12/site-packages (from rank-bm25) (2.3.3)
Downloading rank_bm25-0.2.2-py3-none-any.whl (8.6 kB)
Installing collected packages: rank-bm25
Successfully installed rank-bm25-0.2.2</code></pre>
</div>
</div>
<p>I install the BM25. Now what is next?</p>
</section>
<section id="reply-199" class="level5">
<h5 class="anchored" data-anchor-id="reply-199">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great! Now we need to understand how BM25 works with Qdrantâ€™s sparse vectors.</p>
<p>BM25 generates term-frequency based scores, but Qdrant expects sparse vectors in a specific format: a list of <code>(index, value)</code> pairs where index represents token IDs.</p>
<p>For this, we have two approaches: 1. <strong>Use a tokenizer</strong> to convert text to token IDs and compute BM25 scores 2. <strong>Use fastembedâ€™s BM25</strong> which handles this conversion automatically</p>
<p>Which approach would you prefer to explore?</p>
<p>Letâ€™s use the easier one.</p>
</section>
<section id="reply-200" class="level5">
<h5 class="anchored" data-anchor-id="reply-200">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>The easier approach is <strong>fastembedâ€™s BM25</strong> - it handles all the tokenization and sparse vector formatting for you automatically.</p>
<p>You can use it like this:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb381"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastembed <span class="im">import</span> SparseTextEmbedding</span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a>sparse_model <span class="op">=</span> SparseTextEmbedding(model_name<span class="op">=</span><span class="st">"Qdrant/bm25"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This creates BM25 sparse vectors in the exact format Qdrant expects. Would you like to try initializing this model?</p>
<div id="90a11666" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb382"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastembed <span class="im">import</span> SparseTextEmbedding</span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a>sparse_model <span class="op">=</span> SparseTextEmbedding(model_name<span class="op">=</span><span class="st">"Qdrant/bm25"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.12/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from .autonotebook import tqdm as notebook_tqdm
Fetching 18 files:   0%|          | 0/18 [00:00&lt;?, ?it/s]Fetching 18 files:  11%|â–ˆ         | 2/18 [00:00&lt;00:01, 15.96it/s]Fetching 18 files: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 18/18 [00:00&lt;00:00, 83.86it/s]</code></pre>
</div>
</div>
<div id="1bf74805" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb384"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a>sparse_model</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<pre><code>&lt;fastembed.sparse.sparse_text_embedding.SparseTextEmbedding&gt;</code></pre>
</div>
</div>
<p>Now how shall I have all the points generated using this sparse embedding model and insert into the quadrant database?</p>
</section>
<section id="reply-201" class="level5">
<h5 class="anchored" data-anchor-id="reply-201">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Good question! Now you need to:</p>
<ol type="1">
<li>Generate sparse embeddings for your text chunks</li>
<li>Update your <code>create_points</code> method in <code>QdrantStore</code> to include both dense and sparse vectors</li>
</ol>
<p>Letâ€™s start by testing the sparse model first. Can you try generating a sparse embedding for a sample text to see what format it returns?</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb386"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a>sample_text <span class="op">=</span> [<span class="st">"Amazon's carbon goal is net-zero by 2040"</span>]</span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a>sparse_result <span class="op">=</span> <span class="bu">list</span>(sparse_model.embed(sample_text))</span>
<span id="cb386-3"><a href="#cb386-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sparse_result[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Would you like to run this to see the sparse vector format?</p>
<div id="7f4303bd" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb387"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb387-1"><a href="#cb387-1" aria-hidden="true" tabindex="-1"></a>sample_text <span class="op">=</span> [<span class="st">"Amazon's carbon goal is net-zero by 2040"</span>]</span>
<span id="cb387-2"><a href="#cb387-2" aria-hidden="true" tabindex="-1"></a>sparse_result <span class="op">=</span> <span class="bu">list</span>(sparse_model.embed(sample_text))</span>
<span id="cb387-3"><a href="#cb387-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sparse_result[<span class="dv">0</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>SparseEmbedding(values=array([1.66528681, 1.66528681, 1.66528681, 1.66528681, 1.66528681,
       1.66528681]), indices=array([ 373664883, 1322814068, 1117092987, 1902323900, 2006536704,
        350969189]))</code></pre>
</div>
</div>
<p>And now how shall we deal with create endpoints?</p>
</section>
<section id="reply-202" class="level5">
<h5 class="anchored" data-anchor-id="reply-202">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! The sparse embedding returns <code>SparseEmbedding</code> objects with <code>values</code> and <code>indices</code> arrays - exactly what Qdrant needs.</p>
<p>Now you need to update your <code>QdrantStore.create_points()</code> method to handle both dense and sparse vectors.</p>
<p>When creating points, Qdrant expects this format:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb389"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a>PointStruct(</span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">id</span><span class="op">=</span>...,</span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">=</span>{<span class="st">"dense"</span>: dense_vector, <span class="st">"sparse"</span>: sparse_vector},</span>
<span id="cb389-4"><a href="#cb389-4" aria-hidden="true" tabindex="-1"></a>    payload<span class="op">=</span>...</span>
<span id="cb389-5"><a href="#cb389-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we modify your <code>create_points</code> method to accept both dense and sparse embeddings?</p>
<p>Yes</p>
</section>
<section id="reply-203" class="level5">
<h5 class="anchored" data-anchor-id="reply-203">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s update the <code>create_points</code> method to handle both dense and sparse vectors.</p>
<p>The method should now accept both <code>embeddings</code> (dense) and <code>sparse_embeddings</code> parameters. When both are provided, it creates points with hybrid vectors:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb390"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_points(<span class="va">self</span>, chunks, embeddings, sparse_embeddings<span class="op">=</span><span class="va">None</span>, start_id<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sparse_embeddings:</span>
<span id="cb390-3"><a href="#cb390-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Create hybrid points with both dense and sparse</span></span>
<span id="cb390-4"><a href="#cb390-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> [PointStruct(</span>
<span id="cb390-5"><a href="#cb390-5" aria-hidden="true" tabindex="-1"></a>            <span class="bu">id</span><span class="op">=</span>start_id<span class="op">+</span>i, </span>
<span id="cb390-6"><a href="#cb390-6" aria-hidden="true" tabindex="-1"></a>            vector<span class="op">=</span>{<span class="st">"dense"</span>: embeddings[i], <span class="st">"sparse"</span>: models.SparseVector(values<span class="op">=</span>sparse_embeddings[i].values.tolist(), indices<span class="op">=</span>sparse_embeddings[i].indices.tolist())},</span>
<span id="cb390-7"><a href="#cb390-7" aria-hidden="true" tabindex="-1"></a>            payload<span class="op">=</span>chunk</span>
<span id="cb390-8"><a href="#cb390-8" aria-hidden="true" tabindex="-1"></a>        ) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)]</span>
<span id="cb390-9"><a href="#cb390-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb390-10"><a href="#cb390-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dense only (existing behavior)</span></span>
<span id="cb390-11"><a href="#cb390-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.points <span class="op">=</span> [PointStruct(<span class="bu">id</span><span class="op">=</span>start_id<span class="op">+</span>i, vector<span class="op">=</span>embeddings[i], payload<span class="op">=</span>chunk) <span class="cf">for</span> i, chunk <span class="kw">in</span> <span class="bu">enumerate</span>(chunks)]</span>
<span id="cb390-12"><a href="#cb390-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Should we update your <code>QdrantStore</code> class with this modification?</p>
<p>Can you please suggest the prompt with few shot examples?</p>
</section>
<section id="reply-204" class="level5">
<h5 class="anchored" data-anchor-id="reply-204">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Great idea! Few-shot examples can significantly improve your LLMâ€™s performance by showing it exactly what you expect.</p>
<p>For your WattBot prompt, you could add 2-3 examples showing: 1. A numeric answer with quote 2. A True/False answer 3. An unanswerable question (is_blank)</p>
<p>Would you like me to draft a few example Q&amp;A pairs to add to your prompt, or would you prefer to select specific examples from your training data?</p>
<div id="65d13b99" class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb391"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a>qa <span class="op">=</span> pd.read_csv(<span class="st">"wattbot_data/train_QA.csv"</span>)</span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a>qa.head(n<span class="op">=</span><span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">question</th>
<th data-quarto-table-cell-role="th">answer</th>
<th data-quarto-table-cell-role="th">answer_value</th>
<th data-quarto-table-cell-role="th">answer_unit</th>
<th data-quarto-table-cell-role="th">ref_id</th>
<th data-quarto-table-cell-role="th">ref_url</th>
<th data-quarto-table-cell-role="th">supporting_materials</th>
<th data-quarto-table-cell-role="th">explanation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>q003</td>
<td>What is the name of the benchmark suite presen...</td>
<td>The ML.ENERGY Benchmark</td>
<td>ML.ENERGY Benchmark</td>
<td>is_blank</td>
<td>['chung2025']</td>
<td>['https://arxiv.org/pdf/2505.06371']</td>
<td>We present the ML.ENERGY Benchmark, a benchmar...</td>
<td>Quote</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>q009</td>
<td>What were the net CO2e emissions from training...</td>
<td>4.3 tCO2e</td>
<td>4.3</td>
<td>tCO2e</td>
<td>['patterson2021']</td>
<td>['https://arxiv.org/pdf/2104.10350']</td>
<td>"Training GShard-600B used 24 MWh and produced...</td>
<td>Quote</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>q054</td>
<td>What is the model size in gigabytes (GB) for t...</td>
<td>64.7 GB</td>
<td>64.7</td>
<td>GB</td>
<td>['chen2024']</td>
<td>['https://arxiv.org/pdf/2405.01814']</td>
<td>Table 3: Large language models used for evalua...</td>
<td>Table 3</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>lets draft the prompt from the qa pair</p>
</section>
<section id="reply-205" class="level5">
<h5 class="anchored" data-anchor-id="reply-205">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Letâ€™s draft a few-shot prompt using examples from your training data. We can use the 3 examples you just displayed - they cover different types well:</p>
<ol type="1">
<li><strong>Categorical answer</strong> (q003 - benchmark name)</li>
<li><strong>Numeric answer</strong> (q009 - CO2 emissions)</li>
<li><strong>Table reference</strong> (q054 - model size)</li>
</ol>
<p>Should I draft the complete prompt with these examples included, showing the exact format you want the LLM to follow?</p>
<p>Yes</p>
</section>
<section id="reply-206" class="level5">
<h5 class="anchored" data-anchor-id="reply-206">ðŸ¤–ReplyðŸ¤–<!-- SOLVEIT_SEPARATOR_7f3a9b2c --></h5>
<p>Perfect! Hereâ€™s a draft prompt with few-shot examples from your training data:</p>
<pre><code>You are answering questions for the WattBot 2025 competition. Based on the provided context, generate a response in this exact JSON format.

EXAMPLES:

Example 1 - Categorical Answer:
Question: What is the name of the benchmark suite presented in a recent paper for measuring inference energy consumption?
Context: We present the ML.ENERGY Benchmark, a benchmark suite for measuring inference energy consumption...
Answer:
{
  "answer": "The ML.ENERGY Benchmark",
  "answer_value": "ML.ENERGY Benchmark",
  "answer_unit": "is_blank",
  "ref_id": ["chung2025"],
  "ref_url": ["https://arxiv.org/pdf/2505.06371"],
  "supporting_materials": "We present the ML.ENERGY Benchmark, a benchmark suite for measuring inference energy consumption...",
  "explanation": "Quote"
}

Example 2 - Numeric Answer:
Question: What were the net CO2e emissions from training GShard-600B?
Context: Training GShard-600B used 24 MWh and produced 4.3 tCO2e...
Answer:
{
  "answer": "4.3 tCO2e",
  "answer_value": "4.3",
  "answer_unit": "tCO2e",
  "ref_id": ["patterson2021"],
  "ref_url": ["https://arxiv.org/pdf/2104.10350"],
  "supporting_materials": "Training GShard-600B used 24 MWh and produced 4.3 tCO2e",
  "explanation": "Quote"
}

Example 3 - Table Reference:
Question: What is the model size in gigabytes (GB) for the model Llama-3-70B-Instruct?
Context: [Table showing model sizes]
Answer:
{
  "answer": "64.7 GB",
  "answer_value": "64.7",
  "answer_unit": "GB",
  "ref_id": ["chen2024"],
  "ref_url": ["https://arxiv.org/pdf/2405.01814"],
  "supporting_materials": "Table 3: Large language models used for evaluation",
  "explanation": "Table 3"
}

INSTRUCTIONS:
- Use 0 for False, 1 for True
- Use exact numbers for numeric answers
- Use "is_blank" when no evidence exists
- Always start with {

Context: {{context}}
Question: {{question}}
Response:</code></pre>
<p>Does this structure look good, or would you like to adjust the examples or format?</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/anubhavmaity\.github\.io\/wattbot");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/anubhavmaity/wattbot/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>